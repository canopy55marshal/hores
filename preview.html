
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ›é©¬æ¸¸æˆé€»è¾‘é¢„è§ˆ (Lite)</title>
    <style>
        body { background: #1a1a1a; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 0; height: 100vh; justify-content: center; }
        /* ç«–å±å®¹å™¨ï¼š375x667 (iPhone SE) æˆ– 360x800 (å¸¸è§å®‰å“) */
        #game-container { 
            width: 375px; 
            height: 667px; 
            border: 2px solid #444; 
            position: relative; 
            background: #000; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            overflow: hidden; /* é˜²æ­¢è·‘å‡ºç•Œ */
        }
        
        /* é¡¶éƒ¨ä¿¡æ¯æ  - æ”¹ä¸º Flex å¸ƒå±€ï¼Œåˆ†ä¸¤è¡Œ */
        #info-panel { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 340px; /* å¢åŠ é«˜åº¦ä»¥å®¹çº³å®Œæ•´æŠ€èƒ½æ± å’Œèµ›å­£é¢æ¿ */
            background: rgba(0,0,0,0.6); 
            padding: 6px; 
            box-sizing: border-box;
            z-index: 10;
            display: flex;
            flex-direction: column;
            transition: height 0.3s ease; /* æ·»åŠ è¿‡æ¸¡åŠ¨ç”» */
            overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }
        
        /* æ¯”èµ›æ¨¡å¼ä¸‹çš„æ ·å¼æŠ˜å  */
        .racing-mode #info-panel {
            display: none;
        }
        .racing-mode #info-panel .stable-container,
        .racing-mode #info-panel .season-panel {
            display: none !important;
        }

        /* ç©å®¶èµ„äº§è¡Œ */
        .asset-row {
            display: flex;
            justify-content: space-between;
            color: #f1c40f;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
            padding: 0 10px;
            flex-shrink: 0;
            height: 30px; /* å›ºå®šé«˜åº¦ */
            align-items: center;
        }

        /* é©¬å©å®¹å™¨ - æ¨ªå‘æ»šåŠ¨ */
        .user-panel {
            background: #2c3e50;
            border-radius: 12px;
            margin: 0 0 6px 0;
            padding: 7px 8px;
            border: 1px solid rgba(52, 152, 219, 0.55);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .stable-panel {
            border-radius: 12px;
            margin: 0;
            padding: 6px;
            height: 170px;
            border: 1px solid rgba(231, 76, 60, 0.45);
            background: rgba(44, 62, 80, 0.9);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.35);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        .stable-hint {
            height: 20px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(0,0,0,0.18);
            overflow: hidden;
        }
        .stable-hint-track {
            height: 100%;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0 8px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .stable-hint-track::-webkit-scrollbar { display: none; }
        .hint-chip {
            flex: 0 0 auto;
            font-size: 10px;
            line-height: 16px;
            color: #ecf0f1;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(52, 152, 219, 0.15);
            white-space: nowrap;
        }
        .stable-container {
            display: flex;
            align-items: stretch;
            overflow-x: auto;
            gap: 8px;
            flex: 1;
            height: auto;
            margin: 0;
            padding: 0;
            scrollbar-width: none;
            transition: opacity 0.3s;
        }
        .stable-container::-webkit-scrollbar { display: none; }

        /* é©¬åŒ¹åç‰Œå¡ç‰‡ */
        .horse-card {
            flex: 0 0 auto;
            min-width: 284px;
            height: 145px;
            background: #34495e;
            border-radius: 8px;
            padding: 8px;
            display: grid;
            grid-template-columns: 1fr 96px;
            grid-template-rows: 50px 1fr;
            grid-template-areas:
                "skills info"
                "skills image";
            border: 1px solid #7f8c8d;
            position: relative;
            box-sizing: border-box;
            gap: 8px;
            overflow: hidden;
        }

        .card-skills {
            grid-area: skills;
            border-radius: 6px;
            padding: 6px;
            border: 1px solid rgba(46, 204, 113, 0.35);
            background: rgba(46, 204, 113, 0.06);
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 4px;
        }
        .horse-name-input {
            height: 20px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.18);
            background: rgba(0,0,0,0.18);
            color: #ecf0f1;
            font-size: 12px;
            font-weight: bold;
            padding: 0 8px;
            box-sizing: border-box;
            outline: none;
        }
        .horse-name-input:focus {
            border-color: rgba(52, 152, 219, 0.65);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.18);
        }

        .card-info {
            grid-area: info;
            border-radius: 6px;
            padding: 4px 5px;
            border: 1px solid rgba(241, 196, 15, 0.45);
            background: rgba(241, 196, 15, 0.06);
            display: flex;
            flex-direction: column;
            gap: 1px;
            overflow: hidden;
        }

        .card-image {
            grid-area: image;
            border-radius: 6px;
            border: 1px solid rgba(231, 76, 60, 0.35);
            background: #2c3e50;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding-top: 0;
        }
        .idle-avatar {
            font-size: 34px;
            transform: translateZ(0) scaleX(-1) scale(1.5);
            opacity: 0.95;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.35));
        }
        .idle-horse {
            width: 68px;
            height: 68px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            --idle-scale: 1.5;
            transform: translateZ(0) scaleX(-1) scale(var(--idle-scale));
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.35));
        }
        .market-idle-horse {
            width: 78px;
            height: 78px;
        }
        #market-panel .idle-horse {
            width: 78px;
            height: 78px;
            --idle-scale: 1.5;
        }
        .idle-horse[data-sprite-set="horse"] {
            --idle-scale: 1.65;
        }
        .idle-horse[data-sprite-set="rare"] {
            --idle-scale: 1.98;
        }
        .idle-horse[data-sprite-set="legendary2"] {
            --idle-scale: 1.32;
        }

        .horse-card .name {
            font-size: 14px;
            line-height: 18px;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            text-align: right;
        }
        .horse-card .life {
            font-size: 10px;
            line-height: 14px;
            color: #bdc3c7;
            white-space: nowrap;
            text-align: right;
        }
        .horse-card .blood {
            font-size: 10px;
            line-height: 14px;
            color: #bdc3c7;
            white-space: nowrap;
            text-align: right;
        }

        /* é€‰ä¸­çŠ¶æ€çš„é©¬åŒ¹å¡ç‰‡ */
        .horse-card.selected {
            border: 2px solid #2ecc71;
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.4);
            transform: scale(1.02); /* ç¨å¾®å‡å°ç¼©æ”¾é˜²æ­¢æ¨¡ç³Š */
        }

        .horse-card:active {
            transform: scale(0.98);
        }
        
        .horse-card .gene-tags {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-auto-rows: 16px;
            gap: 2px;
            width: 100%;
            flex: 1;
            height: auto;
            box-sizing: border-box;
            border-radius: 4px;
            align-content: start;
            overflow: hidden;
        }

        .gene-tags {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-auto-rows: 24px;
            gap: 6px;
            width: 100%;
            box-sizing: border-box;
            border-radius: 6px;
            align-content: start;
        }
        
        .gene-tag {
            font-size: 9px;
            line-height: 16px;
            padding: 0 1px;
            border-radius: 3px;
            color: #ecf0f1;
            font-weight: normal;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* å¢åŠ çœç•¥å·ä»¥é˜²æº¢å‡º */
            transform: none;
            cursor: help; /* å¢åŠ é¼ æ ‡æ‰‹åŠ¿ */
        }
        .gene-normal { background: #27ae60; color: #fff; } /* å·²æ‹¥æœ‰æ™®é€š-ç»¿è‰² */
        .gene-rare { background: #f1c40f; color: #000; box-shadow: 0 0 5px rgba(241, 196, 15, 0.5); font-weight: bold; } /* å·²æ‹¥æœ‰ç¨€æœ‰-é‡‘è‰² */
        .gene-epic { background: #9b59b6; color: #fff; box-shadow: 0 0 6px rgba(155, 89, 182, 0.6); font-weight: bold; border: 1px solid #8e44ad; } /* å²è¯—-ç´«è‰² */
        .gene-legend { background: #e74c3c; color: #fff; box-shadow: 0 0 8px rgba(231, 76, 60, 0.8); font-weight: bold; border: 1px solid #c0392b; animation: pulse 2s infinite; } /* ç¥å…½-çº¢è‰² */
        .gene-locked { background: #2c3e50; color: #555; border: 1px solid #444; } /* æœªè§£é”æ ·å¼ */
        .gene-active { border: 2px solid #3498db; box-shadow: 0 0 6px rgba(52,152,219,0.6); }
        .gene-just { border: 2px solid #e74c3c !important; box-shadow: 0 0 6px rgba(231, 76, 60, 0.6); }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }


        /* è·‘é“å±‚å®¹å™¨ */
        #track-container {
            position: absolute;
            top: 340px; /* é¿å¼€é¡¶éƒ¨ä¿¡æ¯æ  */
            bottom: 0;
            left: 0;
            width: 100%;
            overflow: hidden; 
            transition: top 0.3s ease; /* æ·»åŠ è¿‡æ¸¡åŠ¨ç”» */
        }
        
        /* æ¯”èµ›æ¨¡å¼ä¸‹è·‘é“ä¸Šç§» */
        .racing-mode #track-container {
            top: 0;
        }

        #track-layer {
            position: absolute;
            top: 0;
            left: 0;
            /* è·‘é“æ”¹ä¸ºæ¨ªå‘è¶…é•¿ */
            width: 10000px; 
            height: 100%; 
            background-color: #5da629; 
            background-image: 
                /* ç»ˆç‚¹çº¿ */
                linear-gradient(90deg, transparent 95%, rgba(255,255,255,0.8) 96%, transparent 97%),
                /* è‰åœ°çº¹ç†æ”¹ä¸ºæ¨ªå‘ */
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 19px,
                    rgba(0,0,0,0.05) 20px,
                    rgba(0,0,0,0.05) 40px
                );
            background-size: 1000px 100%, 40px 100%;
            overflow: hidden;
        }

        /* è·‘é“åˆ†éš”çº¿æ”¹ä¸ºæ¨ªå‘ */
        .lane-divider {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255,255,255,0.3);
            border-top: 1px dashed rgba(255,255,255,0.5);
        }

        .horse { 
            position: absolute; 
            width: 120px; 
            height: 120px; 
            /* ... æ ·å¼ä¿æŒä¸å˜ ... */
            border: none; 
            background-color: transparent !important;
            
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            display: flex;
            align-items: flex-end; 
            justify-content: center; 
            font-size: 10px; 
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
            z-index: 100; 
            will-change: left, background-image, transform;
            backface-visibility: hidden;
            
            background-image: url('assets/sprites/horse_run/1_horesrun.png'); 
            
            /* é•œåƒç¿»è½¬ï¼šè®©é©¬å¤´æœå³ */
            --race-scale: 1;
            transform: translateZ(0) scaleX(-1) scale(var(--race-scale)); 
            transform-origin: center;
        }
        .horse-ghost {
            position: absolute;
            width: 120px;
            height: 120px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            pointer-events: none;
            opacity: 0.35;
            filter: blur(0.6px) brightness(1.15) saturate(1.1);
            z-index: 90;
            --race-scale: 1;
            transform: translateZ(0) scaleX(-1) scale(var(--race-scale));
            transform-origin: center;
            will-change: opacity, transform;
            backface-visibility: hidden;
        }
        .horse-burst {
            position: absolute;
            width: 160px;
            height: 160px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            pointer-events: none;
            opacity: 0.9;
            filter: blur(0.2px) brightness(1.2) saturate(1.25);
            z-index: 95;
            --race-scale: 1;
            transform: translateZ(0) scaleX(-1) scale(var(--race-scale));
            transform-origin: center;
            will-change: opacity, transform, background-image;
            backface-visibility: hidden;
        }
        .horse-jifeng {
            position: absolute;
            width: 170px;
            height: 170px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            pointer-events: none;
            opacity: 0.95;
            filter: brightness(1.05) saturate(1.2);
            z-index: 94;
            --race-scale: 1;
            transform: translateZ(0) scaleX(-1) scale(var(--race-scale));
            transform-origin: center;
            will-change: transform, background-image;
            backface-visibility: hidden;
        }
        .horse-lanying {
            position: absolute;
            width: 170px;
            height: 170px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            pointer-events: none;
            opacity: 0.9;
            filter: brightness(1.05) saturate(1.1);
            z-index: 93;
            --race-scale: 1;
            transform: translateZ(0) scaleX(-1) scale(var(--race-scale));
            transform-origin: center;
            will-change: transform, background-image;
            backface-visibility: hidden;
        }
        .horse-lieyan {
            position: absolute;
            width: 175px;
            height: 175px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            pointer-events: none;
            opacity: 0.92;
            filter: brightness(1.1) saturate(1.2);
            z-index: 92;
            --race-scale: 1;
            transform: translateZ(0) scaleX(-1) scale(var(--race-scale));
            transform-origin: center;
            will-change: transform, background-image;
            backface-visibility: hidden;
        }
        
        /* ä¿®æ­£æ–‡å­—æ–¹å‘ï¼šå› ä¸ºçˆ¶å…ƒç´ ç¿»è½¬äº†ï¼Œæ–‡å­—ä¹Ÿä¼šç¿»è½¬ï¼Œéœ€è¦æŠŠæ–‡å­—ç¿»è½¬å›æ¥ */
        /* ä½†ç”±äºæˆ‘ä»¬æŠŠæ–‡å­—ç›´æ¥å†™åœ¨ .horse é‡Œï¼Œå¤„ç†èµ·æ¥æ¯”è¾ƒéº»çƒ¦ */
        /* æ›´å¥½çš„åšæ³•æ˜¯æŠŠæ–‡å­—å•ç‹¬æ”¾ä¸€ä¸ªå­å…ƒç´ ï¼Œæˆ–è€…ä¸ç¿»è½¬çˆ¶å…ƒç´ ï¼Œè€Œæ˜¯ç”¨ scaleX(-1) ç¿»è½¬èƒŒæ™¯å›¾ */
        /* ä¸è¿‡ background-image ä¸æ”¯æŒç›´æ¥ scaleXï¼Œæ‰€ä»¥å¿…é¡»ç¿»è½¬å®¹å™¨ */
        /* æˆ‘ä»¬ç»™æ–‡å­—åŠ ä¸€ä¸ªåå‘ç¿»è½¬ */


        /* ç§»é™¤ä¹‹å‰çš„ CSS ç»˜åˆ¶ */
        .horse::before { content: none; }
        .horse::after { content: none; }

        /* å®šä¹‰åŠ¨ç”»ç±» - æˆ‘ä»¬ç”¨ JS åŠ¨æ€åˆ‡æ¢èƒŒæ™¯å›¾æ¥å®ç°åºåˆ—å¸§ï¼Œå› ä¸ºå›¾ç‰‡æ˜¯ç‹¬ç«‹çš„ png */
        /* æˆ–è€…ä½¿ç”¨ CSS keyframes å¦‚æœå›¾ç‰‡æ‹¼åœ¨ä¸€èµ· */


        /* UI æ“ä½œå±‚ */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }
        #ui-layer * { pointer-events: auto; }
        
        /* ç»“ç®—é¢æ¿ */
        #result-panel {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
            background: rgba(0,0,0,0.6);
        }
        .result-box {
            width: 80%;
            background: #2c3e50;
            border: 1px solid #7f8c8d;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        .result-title {
            font-size: 20px;
            margin-bottom: 8px;
            color: #f1c40f;
        }
        .result-desc {
            font-size: 14px;
            color: #ecf0f1;
            margin-bottom: 12px;
        }
        .result-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .btn-small {
            padding: 8px 12px;
            font-size: 14px;
            width: auto;
        }
        .countdown {
            margin-top: 8px;
            font-size: 12px;
            color: #bdc3c7;
        }
        /* åº•éƒ¨æŒ‰é’®åŒº */
        .panel { 
            position: absolute; 
            bottom: 50px; 
            left: 50%; 
            transform: translateX(-50%); 
            text-align: center; 
            width: 100%;
        }
        
        .btn { 
            display: block;
            width: 80%;
            margin: 10px auto;
            padding: 15px 0; 
            cursor: pointer; 
            font-size: 18px; 
            border: none; 
            color: #fff; 
            border-radius: 8px;
            font-weight: bold;
        }
        .btn-green { background: #27ae60; box-shadow: 0 4px #219150; }
        .btn-green:active { transform: translateY(2px); box-shadow: 0 2px #219150; }
        
        .btn-blue { background: #2980b9; box-shadow: 0 4px #2c3e50; }
        .btn-blue:active { transform: translateY(2px); box-shadow: 0 2px #2c3e50; }

        /* æŠ€èƒ½è¯´æ˜å¼¹çª— */
        #skill-modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 40;
        }
        .skill-modal-box {
            width: 80%;
            max-width: 320px;
            background: #2c3e50;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            color: #ecf0f1;
            text-align: center;
            border: 1px solid #7f8c8d;
        }
        .skill-title { font-weight: bold; font-size: 18px; margin-bottom: 8px; color: #f1c40f; }
        .skill-desc { font-size: 13px; color: #bdc3c7; margin-bottom: 12px; line-height: 1.5; }

        /* åŸ¹è‚²ç•Œé¢ (æ¨¡æ‹Ÿå¼¹çª—) */
        #breed-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* ä¿®æ­£å›¾ç‰‡è·¯å¾„ï¼šWebæœåŠ¡å™¨æ ¹ç›®å½•åœ¨ e:\horesï¼Œæ‰€ä»¥æ˜¯ assets/... */
            background-image: url('assets/bg/breed_bg.png'); 
            background-size: cover;
            background-position: center;
            display: none;
            z-index: 30;
            flex-direction: column;
            justify-content: flex-end; 
            padding-bottom: 50px;
        }
        
        #breed-panel::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); /* é®ç½©å±‚ï¼Œè®©æ–‡å­—æ›´æ¸…æ™° */
            z-index: -1;
        }

        /* åŸ¹è‚²ç•Œé¢æ ·å¼è¡¥å…¨ */
        .breed-info {
            position: relative;
            background: rgba(255,255,255,0.9);
            color: #333;
            margin: 20px;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* æ´—ç»ƒç•Œé¢ */
        #reforge-panel {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            z-index: 40;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* é€‰ç§€ç•Œé¢ */
        #draft-panel {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 60;
            display: none; align-items: center; justify-content: center; flex-direction: column;
        }
        .draft-container {
            width: 85%; background: #2c3e50; border-radius: 12px; padding: 20px;
            text-align: center; border: 1px solid #f1c40f; box-shadow: 0 0 30px rgba(241, 196, 15, 0.3);
        }

        .reforge-container {
            width: 90%;
            background: #2c3e50;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border: 1px solid #7f8c8d;
        }

        .reforge-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 12px;
        }

        .reforge-box {
            width: 50%;
            background: #34495e;
            padding: 10px;
            border-radius: 5px;
            min-height: 230px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .reforge-title {
            color: #bdc3c7;
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 1px solid #7f8c8d;
            padding-bottom: 5px;
        }

        .reforge-actions {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }

        .reforge-split {
            display: flex;
            gap: 10px;
            flex: 1;
            overflow: hidden;
        }
        .reforge-skill-list {
            width: 56px;
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow: hidden;
        }
        .reforge-skill-item {
            width: 100%;
            height: 26px;
            line-height: 26px;
            padding: 0 4px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
        }
        .reforge-skill-item.is-selected {
            outline: 2px solid rgba(46, 204, 113, 0.95);
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.35);
        }
        .reforge-skill-detail {
            flex: 1;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.10);
            background: rgba(0,0,0,0.14);
            padding: 10px;
            box-sizing: border-box;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .reforge-effect-title {
            color: #ecf0f1;
            font-weight: bold;
            font-size: 14px;
            line-height: 18px;
        }
        .reforge-effect-badge {
            color: #f1c40f;
            font-size: 12px;
            line-height: 16px;
        }
        .reforge-effect-text {
            color: #bdc3c7;
            font-size: 12px;
            line-height: 16px;
            overflow: hidden;
        }
        .reforge-effect-placeholder {
            color: #7f8c8d;
            font-size: 13px;
            line-height: 18px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        /* ç©å®¶å¤´åƒä¸è£èª‰æ¡† */
        .avatar-wrapper {
            position: relative;
            width: 40px; height: 40px;
            margin-right: 10px;
            flex-shrink: 0;
        }
        .avatar {
            width: 100%; height: 100%;
            background: #95a5a6;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
            border: 2px solid #bdc3c7;
            box-sizing: border-box;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            cursor: pointer;
        }
        .avatar.has-img { color: transparent; }
        .avatar-action {
            background: none;
            border: none;
            color: #2ecc71;
            font-weight: bold;
            cursor: pointer;
            font-size: 12px;
            padding: 0;
        }
        #avatar-auth-modal,
        #avatar-picker-modal {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.75);
            z-index: 110;
        }
        .avatar-modal-box {
            width: 86%;
            max-width: 320px;
            background: #2c3e50;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.12);
            box-shadow: 0 8px 20px rgba(0,0,0,0.35);
            padding: 14px;
            box-sizing: border-box;
        }
        .avatar-modal-title {
            font-weight: bold;
            font-size: 16px;
            color: #ecf0f1;
            margin-bottom: 8px;
        }
        .avatar-modal-desc {
            font-size: 12px;
            color: #bdc3c7;
            line-height: 16px;
            margin-bottom: 12px;
        }
        .avatar-modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .avatar-picker-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            max-height: 260px;
            overflow-y: auto;
            padding: 4px;
            box-sizing: border-box;
            margin-bottom: 12px;
        }
        .avatar-pick {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(0,0,0,0.15);
            overflow: hidden;
            cursor: pointer;
            padding: 0;
        }
        .avatar-pick img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        /* å† å†›é‡‘æ¡† */
        .avatar-frame-gold {
            position: absolute;
            top: -5px; left: -5px;
            width: 50px; height: 50px;
            border: 3px solid #f1c40f;
            border-radius: 50%;
            box-shadow: 0 0 10px #f1c40f, inset 0 0 5px #f1c40f;
            pointer-events: none;
            z-index: 2;
        }
        /* è£èª‰çš‡å†  */
        .honor-crown {
            position: absolute;
            top: -12px; left: 50%;
            transform: translateX(-50%) rotate(-10deg);
            font-size: 18px;
            text-shadow: 0 2px 2px rgba(0,0,0,0.5);
            z-index: 3;
            animation: floatCrown 2s ease-in-out infinite;
        }
        @keyframes floatCrown {
            0%, 100% { transform: translateX(-50%) rotate(-10deg) translateY(0); }
            50% { transform: translateX(-50%) rotate(-10deg) translateY(-3px); }
        }
        /* æ¯”èµ›ä¸­é©¬åŒ¹å¤´é¡¶ä¿¡æ¯ */
        .horse-name-tag {
            position: absolute;
            background: rgba(0,0,0,0.5); /* ç¨å¾®é™ä½é€æ˜åº¦ */
            padding: 2px 6px;
            border-radius: 10px; /* èƒ¶å›Šå½¢çŠ¶ */
            color: #fff;
            font-size: 10px;
            text-align: center;
            pointer-events: none; 
            z-index: 101;
            white-space: nowrap;
            display: flex;
            flex-direction: row; /* æ”¹ä¸ºæ¨ªå‘æ’åˆ— */
            align-items: center;
            gap: 4px; /* åå­—å’ŒæŠ€èƒ½ä¹‹é—´çš„é—´è· */
            /* è°ƒæ•´ä½ç½®ï¼š
               - translate(-50%, -100%)ï¼šåŸºå‡†ç‚¹ä½äºå…ƒç´ åº•éƒ¨ä¸­å¿ƒ
               - top: 0ï¼šå®šä½åˆ°é©¬åŒ¹å®¹å™¨çš„é¡¶éƒ¨
               - z-index: ç¡®ä¿åœ¨é©¬åŒ¹ä¸Šæ–¹ï¼Œä½†éœ€è¦æ³¨æ„å±‚çº§å…³ç³»
            */
            transform: translate(-50%, -80%); /* å‘ä¸Šåç§»ï¼Œä½äºå¤´é¡¶ */
            margin-top: 0; 
            z-index: 200; /* æé«˜å±‚çº§ï¼Œé˜²æ­¢è¢«ä¸Šæ–¹è·‘é“çš„é©¬åŒ¹é®æŒ¡ */
        }
        .horse-name-tag .name-row {
            font-weight: bold;
            text-shadow: 0 1px 1px #000;
        }
        .horse-name-tag.is-player .name-row {
            color: #f1c40f;
            font-weight: bold;
        }
        .horse-name-tag .skill-row {
            display: flex;
            gap: 1px;
            justify-content: center;
        }
        .mini-gene-tag {
            font-size: 8px; /* è¿›ä¸€æ­¥å‡å°å­—ä½“ */
            padding: 0 2px;
            border-radius: 2px;
            line-height: 1.2;
        }
    </style>
</head>
<body>
    <h1>èµ›é©¬æ¸¸æˆé€»è¾‘é¢„è§ˆ (Lite)</h1>
    <div id="game-container">
        <div id="track-container">
            <div id="track-layer"></div>
        </div>
        <div id="ui-layer">
            <div id="info-panel"></div>
            <div id="lobby-panel" class="panel">
                <button class="btn btn-green" onclick="game.startRace()">å¼€å§‹æ¯”èµ› (-1é—¨ç¥¨)</button>
                <button class="btn btn-blue" onclick="game.openBreed()">åŸºå› åŸ¹è‚² (-500ç§¯åˆ†)</button>
                <button class="btn btn-blue" style="background:#8e44ad; box-shadow: 0 4px #6c3483;" onclick="game.openReforge()">æŠ€èƒ½æ´—ç»ƒ</button>
                <button class="btn btn-blue" style="background:#16a085; box-shadow: 0 4px #0e6655;" onclick="game.openCodex()">é€ å‹å›¾é‰´</button>
            </div>
            <div id="status-label" class="panel" style="top: 40%; display: none;"></div>
            <div id="result-panel">
                <div class="result-box">
                    <div id="result-title" class="result-title"></div>
                    <div id="result-desc" class="result-desc"></div>
                    <div class="result-actions">
                        <button id="btn-back-lobby" class="btn btn-green btn-small">è¿”å›å¤§å…</button>
                    </div>
                    <div id="result-countdown" class="countdown"></div>
                </div>
            </div>
            <div id="skill-modal">
                <div class="skill-modal-box">
                    <div id="skill-title" class="skill-title"></div>
                    <div id="skill-desc" class="skill-desc"></div>
                    <button class="btn btn-green btn-small" style="width:60%; font-size:14px;" onclick="game.closeSkillModal()">å…³é—­</button>
                </div>
            </div>
            <div id="codex-panel" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.88); z-index:65; align-items:center; justify-content:center;">
                <div style="width:90%; background:#2c3e50; border-radius:12px; padding:15px; border:1px solid #f1c40f; box-shadow:0 0 20px rgba(0,0,0,0.6);">
                    <h3 style="color:#f1c40f; text-align:center; margin-top:0;">ğŸ“– é€ å‹å›¾é‰´</h3>
                    <div id="codex-list" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; max-height:420px; overflow-y:auto;"></div>
                    <button class="btn btn-blue" style="background:#7f8c8d; margin-top:10px; width:100%;" onclick="game.closeCodex()">å…³é—­</button>
                </div>
            </div>
            <div id="avatar-auth-modal">
                <div class="avatar-modal-box">
                    <div class="avatar-modal-title">è·å–å¤´åƒæˆæƒ</div>
                    <div class="avatar-modal-desc">ç™»å½•åå¯è·å–å¾®ä¿¡å¤´åƒç”¨äºå±•ç¤ºã€‚å½“å‰æµ‹è¯•ä»æœ¬åœ°ç›®å½•åŠ è½½ï¼šE:\\hores\\Test Friend Avatar</div>
                    <div class="avatar-modal-actions">
                        <button class="btn btn-green btn-small" style="width:45%;" onclick="game.grantAvatarConsent()">åŒæ„</button>
                        <button class="btn btn-blue btn-small" style="width:45%; background:#7f8c8d; box-shadow:0 4px #666;" onclick="game.denyAvatarConsent()">æ‹’ç»</button>
                    </div>
                </div>
            </div>
            <div id="avatar-picker-modal">
                <div class="avatar-modal-box">
                    <div class="avatar-modal-title">æ›´æ¢å¤´åƒ</div>
                    <div class="avatar-modal-desc">ä»æœ¬åœ°ç›®å½•é€‰æ‹©ä¸€å¼ å›¾ç‰‡ä½œä¸ºå¤´åƒï¼ˆå¯åœ¨æ–‡ä»¶å¤¹é‡Œæ›¿æ¢/æ–°å¢ï¼‰ã€‚</div>
                    <div id="avatar-picker-list" class="avatar-picker-list"></div>
                    <div class="avatar-modal-actions">
                        <button class="btn btn-blue btn-small" style="width:60%; background:#7f8c8d; box-shadow:0 4px #666;" onclick="game.closeAvatarPicker()">å…³é—­</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åŸ¹è‚²ç•Œé¢ -->
        <div id="breed-panel">
            <div class="breed-info">
                <h2>é©¬å©åŸ¹è‚²ä¸­å¿ƒ</h2>
                <p>æ¶ˆè€— 500 ç§¯åˆ†å’Œçˆ¶æœ¬ 10 ç‚¹å¯¿å‘½ï¼Œä¸ºæ‚¨å½“å‰çš„èµ›é©¬å¯»æ‰¾é…å¶ã€‚</p>
                <p id="breed-result" style="font-weight:bold; color:#e67e22;"></p>
                <button class="btn btn-green" onclick="game.confirmBreed()">å¼€å§‹åŸ¹è‚²</button>
                <button class="btn btn-blue" style="background:#7f8c8d" onclick="game.closeBreed()">è¿”å›å¤§å…</button>
            </div>
        </div>

        <!-- æ´—ç»ƒç•Œé¢ -->
        <div id="reforge-panel">
            <div class="reforge-container">
                <h2 style="text-align:center; margin-top:0; color:#e056fd">æŠ€èƒ½æ´—ç»ƒä¸­å¿ƒ</h2>
                <p style="text-align:center; font-size:12px; color:#aaa">æŠ€èƒ½æ§½ä¸­æ¯ä¸ªç¨€æœ‰æŠ€èƒ½å¢åŠ åŸºç¡€é€Ÿåº¦ 3%</p>
                
                <div class="reforge-row">
                    <div class="reforge-box">
                        <div class="reforge-title" style="font-size:16px;">å½“å‰æŠ€èƒ½</div>
                        <div class="reforge-split">
                            <div id="reforge-current-list" class="reforge-skill-list"></div>
                            <div id="reforge-current-detail" class="reforge-skill-detail">
                                <div class="reforge-effect-placeholder">é€‰æ‹©å·¦ä¾§æŠ€èƒ½æŸ¥çœ‹æ•ˆæœ</div>
                            </div>
                        </div>
                    </div>
                    <div class="reforge-box">
                        <div class="reforge-title" style="font-size:16px;">æ´—ç»ƒé¢„è§ˆ</div>
                        <div class="reforge-split">
                            <div id="reforge-new-list" class="reforge-skill-list"></div>
                            <div id="reforge-new-detail" class="reforge-skill-detail">
                                <div class="reforge-effect-placeholder">ç‚¹å‡»æ´—ç»ƒç”Ÿæˆ</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="reforge-actions">
                    <button id="btn-do-reforge" class="btn btn-blue" style="width:40%; background:#8e44ad; font-size:14px;" onclick="game.doReforge()">æ´—ç»ƒ</button>
                    <button id="btn-save-reforge" class="btn btn-green" style="width:40%; display:none; font-size:14px;" onclick="game.saveReforge()">ä¿å­˜ç»“æœ</button>
                    <button id="btn-discard-reforge" class="btn btn-blue" style="width:40%; display:none; background:#7f8c8d; font-size:14px;" onclick="game.discardReforge()">æ”¾å¼ƒ</button>
                </div>
                <button class="btn btn-blue" style="background:#7f8c8d; margin-top:10px;" onclick="game.closeReforge()">å…³é—­</button>
            </div>
        </div>

        <!-- äº¤æ˜“å¸‚åœºç•Œé¢ -->
        <div id="trade-panel" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:70; flex-direction:column; align-items:center; justify-content:center;">
            <div style="width:90%; background:#2c3e50; border-radius:12px; padding:15px; border:1px solid #f39c12; box-shadow:0 0 20px rgba(243,156,18,0.3);">
                <h3 style="color:#f1c40f; text-align:center; margin-top:0;">ğŸ¤ é€‰ç§€æƒäº¤æ˜“å¸‚åœº</h3>
                
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; padding:10px; background:#34495e; border-radius:6px;">
                    <div style="text-align:center; width:45%;">
                        <div style="color:#95a5a6; font-size:12px;">æˆ‘çš„èµ„äº§</div>
                        <div style="color:#2ecc71; font-weight:bold;">ğŸ’° <span id="trade-my-points">0</span></div>
                        <div style="color:#e67e22; font-weight:bold; margin-top:5px;">ğŸ« <span id="trade-my-tier">ç¬¬ - æ¡£</span></div>
                    </div>
                    <div style="display:flex; align-items:center; color:#bdc3c7;">VS</div>
                    <div style="text-align:center; width:45%;">
                        <div style="color:#95a5a6; font-size:12px;">ç›®æ ‡</div>
                        <div style="color:#3498db; font-weight:bold; margin-top:15px;">ğŸ <span id="trade-target-tier">é€‰æ‹©é˜Ÿä¼</span></div>
                    </div>
                </div>

                <div id="trade-list" style="height:150px; overflow-y:auto; background:#222; border-radius:6px; margin-bottom:10px;">
                    <!-- JS ç”Ÿæˆåˆ—è¡¨ -->
                </div>

                <div id="trade-action-area" style="display:none; text-align:center;">
                    <div style="color:#ecf0f1; font-size:12px; margin-bottom:5px;">å‡ºä»·: <span id="trade-offer-val" style="color:#f1c40f;">0</span> ç§¯åˆ† + æˆ‘çš„é€‰ç§€æƒ</div>
                    <input type="range" id="trade-slider" min="0" max="10000" step="100" style="width:80%;" oninput="game.updateTradeCalc()">
                    <div id="trade-msg" style="font-size:12px; height:20px; margin:5px 0;"></div>
                    <button class="btn btn-green" style="width:100%; margin-top:5px;" onclick="game.executeTrade()">ç¡®è®¤äº¤æ˜“</button>
                </div>

                <button class="btn btn-blue" style="background:#7f8c8d; margin-top:10px; width:100%;" onclick="game.closeTrade()">è¿”å›é€‰ç§€å¤§ä¼š</button>
            </div>
        </div>

        <!-- é€‰ç§€ç•Œé¢ -->
        <div id="draft-panel">
            <div class="draft-container">
                <h2 style="color:#f1c40f; margin-bottom:10px;">èµ›å­£é€‰ç§€å¤§ä¼š</h2>
                <div id="draft-status" style="margin-bottom:20px; color:#ecf0f1;"></div>
                
                <!-- æ–°å¢äº¤æ˜“å…¥å£ -->
                <button id="btn-open-trade" class="btn btn-blue" style="background:#8e44ad; margin-bottom:10px; box-shadow: 0 4px #6c3483;" onclick="game.openTrade()">ğŸ¤ äº¤æ˜“é€‰ç§€æƒ</button>

                <div id="draft-result" style="display:none; margin:20px 0; padding:15px; background:#34495e; border-radius:8px; max-height: 400px; overflow-y: auto;">
                    <div style="font-size:18px; color:#2ecc71; margin-bottom:10px;">ğŸ‰ è·å¾— <span id="draft-pick-no" style="color:#f1c40f; font-weight:bold;"></span> é¡ºä½é€‰æ‹©æƒ</div>
                    <p style="font-size:12px; color:#bdc3c7;">è¯·ä»ä¸‹æ–¹å¾…é€‰æ–°ç§€ä¸­é€‰æ‹©ä¸€åŒ¹ï¼š</p>
                    <div id="draft-pool-container" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-top:10px;"></div>
                    
                    <!-- å°†æ“ä½œæŒ‰é’®ç§»åŠ¨åˆ°å±•ç¤ºåŒºå†…éƒ¨åº•éƒ¨ -->
                    <div style="margin-top: 20px; border-top: 1px solid #7f8c8d; padding-top: 15px;">
                         <button id="btn-close-draft" class="btn btn-blue" style="display:none;" onclick="game.closeDraft()">å¼€å¯æ–°èµ›å­£</button>
                         <button id="btn-trade-new-horse" class="btn btn-blue" style="display:none; background:#e67e22;" onclick="game.openHorseTrade()">ğŸ’° å‡ºå”®æ–°é©¬</button>
                         <button id="btn-market-trade" class="btn btn-blue" style="display:none; background:#9b59b6;" onclick="game.openMarket()">ğŸ”„ çƒå‘˜äº¤æ˜“å¸‚åœº</button>
                    </div>
                </div>
                <button id="btn-start-draft" class="btn btn-green" onclick="game.startDraft()">å¼€å§‹æŠ½ç­¾</button>
            </div>
        </div>
        
        <!-- Ticket Menu Modal -->
        <div id="ticket-modal" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100; align-items:center; justify-content:center;">
            <div style="background:#2c3e50; padding:20px; border-radius:10px; width:80%; max-width:300px; text-align:center; border:2px solid #f39c12; box-shadow: 0 0 20px rgba(0,0,0,0.8);">
                <h3 style="color:#f1c40f; margin-top:0; border-bottom:1px solid #7f8c8d; padding-bottom:10px;">ğŸ« è·å–é—¨ç¥¨</h3>
                <p style="color:#bdc3c7; font-size:14px; margin:20px 0;">å½“å‰æ‹¥æœ‰: <span id="ticket-modal-count" style="color:#2ecc71; font-weight:bold; font-size:18px;">0</span> å¼ </p>
                
                <button class="btn btn-blue" onclick="game.buyTicketWithPoints()">
                    ğŸ’° æ¶ˆè€—ç§¯åˆ† (200åˆ†/å¼ )
                </button>
                
                <button id="btn-watch-ad-modal" class="btn btn-green" onclick="game.watchAdForTicket()" style="margin-top:10px;">
                    ğŸ“º è§‚çœ‹å¹¿å‘Š (å…è´¹+5)
                </button>
                
                <button class="btn" style="margin-top:20px; background:#95a5a6; padding:10px; font-size:14px;" onclick="game.closeTicketMenu()">å…³é—­</button>
            </div>
        </div>

        <!-- çƒå‘˜äº¤æ˜“å¸‚åœºç•Œé¢ -->
        <div id="market-panel" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:90; flex-direction:column; align-items:center;">
             <div style="width:100%; height:40px; background:#2c3e50; display:flex; align-items:center; padding:0 10px; box-sizing:border-box; justify-content:space-between;">
                 <span style="color:#f1c40f; font-weight:bold;">ğŸ”„ è‡ªç”±å¸‚åœº</span>
                 <button class="btn btn-blue btn-small" style="background:#e74c3c; width:auto; padding:5px 10px;" onclick="game.closeMarket()">å…³é—­</button>
             </div>
             
             <div style="flex:1; width:100%; overflow-y:auto; padding:10px; box-sizing:border-box;">
                 <!-- äº¤æ˜“åŒºå¸ƒå±€ï¼šä¸Šéƒ¨åˆ†ä¸º AI é©¬åˆ—è¡¨ï¼Œä¸‹éƒ¨åˆ†ä¸ºæˆ‘çš„ç­¹ç  -->
                 
                 <div style="margin-bottom:10px;">
                     <div style="color:#bdc3c7; font-size:12px; margin-bottom:5px;">ğŸ¯ ç›®æ ‡ (AI çš„é©¬)</div>
                     <div id="market-ai-list" style="display:flex; overflow-x:auto; gap:10px; padding-bottom:10px;"></div>
                 </div>
                 
                 <div style="margin-bottom:10px; border-top:1px solid #444; padding-top:10px;">
                     <div style="color:#bdc3c7; font-size:12px; margin-bottom:5px;">ğŸ’° æˆ‘çš„ç­¹ç  (å‹¾é€‰é©¬åŒ¹ + ç§¯åˆ†)</div>
                     <div id="market-my-list" style="display:flex; overflow-x:auto; gap:10px; padding-bottom:10px;"></div>
                 </div>
                 
                 <!-- äº¤æ˜“è®¡ç®—åŒº -->
                 <div style="background:#34495e; padding:15px; border-radius:8px; text-align:center;">
                    <div id="market-target-preview" style="display:flex; justify-content:center; margin-bottom:10px;"></div>
                     <div style="display:flex; justify-content:space-around; align-items:center; margin-bottom:15px;">
                         <div style="text-align:center;">
                             <div style="font-size:12px; color:#95a5a6;">å¯¹æ–¹ä»·å€¼</div>
                             <div id="market-target-val" style="font-size:24px; color:#e74c3c; font-weight:bold;">0</div>
                         </div>
                         <div style="font-size:20px; color:#bdc3c7;">VS</div>
                         <div style="text-align:center;">
                             <div style="font-size:12px; color:#95a5a6;">æˆ‘æ–¹ä»·å€¼</div>
                             <div id="market-my-val" style="font-size:24px; color:#2ecc71; font-weight:bold;">0</div>
                         </div>
                     </div>
                     
                     <div style="margin-bottom:10px;">
                        <span style="color:#ecf0f1; font-size:12px;">è¿½åŠ ç§¯åˆ†: <span id="market-points-val" style="color:#f1c40f;">0</span></span>
                        <input type="range" id="market-points-slider" min="0" max="10000" step="100" style="width:100%;" oninput="game.updateMarketCalc()">
                     </div>
                     
                     <div id="market-msg" style="font-size:12px; margin-bottom:10px; height:20px;"></div>
                     
                     <button class="btn btn-green" onclick="game.executeMarketTrade()">ğŸ¤ ç¡®è®¤äº¤æ˜“</button>
                 </div>
             </div>
        </div>
        
        <!-- é©¬åŒ¹äº¤æ˜“ç¡®è®¤å¼¹çª— -->
        <div id="horse-trade-modal" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:80; flex-direction:column; align-items:center; justify-content:center;">
             <div style="background:#2c3e50; padding:20px; border-radius:10px; text-align:center; border:1px solid #f1c40f;">
                 <h3 style="color:#f1c40f;">é©¬åŒ¹äº¤æ˜“ä¸­å¿ƒ</h3>
                 <p style="color:#ecf0f1;">å½“å‰æœ‰äººå‡ºä»· <span id="horse-trade-price" style="color:#2ecc71; font-weight:bold;">0ç§¯åˆ†</span> æ”¶è´­ä½ çš„æ–°ç§€é©¬</p>
                 <p style="font-size:12px; color:#bdc3c7;">(äº¤æ˜“åé©¬åŒ¹å°†ç¦»å¼€é©¬å©ï¼Œæ— æ³•æ’¤é”€)</p>
                 <div style="margin-top:20px;">
                     <button class="btn btn-green" onclick="game.confirmHorseTrade()">ç¡®è®¤å‡ºå”®</button>
                     <button class="btn btn-blue" style="background:#7f8c8d" onclick="game.cancelHorseTrade()">å–æ¶ˆ</button>
                 </div>
             </div>
        </div>
    </div>
    <script type="module">
        // æ¨¡æ‹Ÿ Cocos æ¨¡å—å¯¼å…¥
        const _decorator = { ccclass: () => {}, property: () => {} };
        
        // --- ç§»æ¤ Config.ts ---
        const Quality = { Normal: 'æ™®é€š', Rare: 'ç¨€æœ‰', Epic: 'å²è¯—', Legendary: 'ç¥å…½' };
        // åŸºå› ç±»å‹ - æ‰©å±•è‡³25ä¸ª
        const GeneType = {
            // åŸºç¡€ç±»
            Speed: 'ç–¾é£', Burst: 'çˆ†å†²', Agile: 'çµæ´»', Swift: 'ç¥é€Ÿ', Dash: 'é£é©°',
            // è€åŠ›ç±»
            Stamina: 'åšéŸ§', Endurance: 'æŒä¹…', Recover: 'å›æ˜¥', IronWill: 'é“å¿—', DeepBreath: 'æ·±æ¯',
            // ç¨³å®šæ€§ç±»
            Stable: 'ç¨³å¥', Calm: 'å†·é™', Focus: 'ä¸“æ³¨', Steady: 'å¦‚å±±', Balance: 'å¹³è¡¡',
            // ç‰¹æ®Šç±»
            Hybrid: 'æ··è¡€', LateBoomer: 'å¤§å™¨', EarlyBird: 'å…ˆé”‹', CornerKing: 'é£˜ç§»', SlopeRider: 'å¡é“',
            // ç¨€æœ‰/ç¥å…½ç±»
            Destiny: 'å¤©å‘½', Miracle: 'å¥‡è¿¹', Shadow: 'æ®‹å½±', Meteor: 'æµæ˜Ÿ', Legend: 'ä¼ è¯´'
        };

        const SpriteSet = {
            Horse: 'horse',
            Base: 'g',
            Rare: 'rare',
            Rare2: 'rare2',
            Epic: 'epic',
            Legendary: 'legendary',
            Legendary2: 'legendary2',
            Legendary3: 'legendary3'
        };

        const SpriteAssets = {
            [SpriteSet.Horse]: { dir: 'assets/sprites/horse_run', file: (i) => `${i}_horesrun.png` },
            [SpriteSet.Base]: { dir: 'assets/sprites/g_hores_run', file: (i) => `g_hores_run_${String((Number(i) || 1) - 1).padStart(4, '0')}.png` },
            [SpriteSet.Rare]: { dir: 'assets/sprites/2horse_run', file: (i) => `g_hores_run_${String((Number(i) || 1) - 1).padStart(4, '0')}.png` },
            [SpriteSet.Rare2]: { dir: 'assets/sprites/2g_hores_run', file: (i) => `3horse_run_${String((Number(i) || 1) - 1).padStart(4, '0')}.png` },
            [SpriteSet.Epic]: { dir: 'assets/sprites/3horse_run', file: (i) => `3horse_run_${String((Number(i) || 1) - 1).padStart(4, '0')}.png` },
            [SpriteSet.Legendary]: { dir: 'assets/sprites/4horse_run', file: (i) => `2horse_run_${String((Number(i) || 1) - 1).padStart(4, '0')}.png` },
            [SpriteSet.Legendary2]: { dir: 'assets/sprites/4g_horse_run/output', file: (i) => `4g_hores_run_${String((Number(i) || 1) - 1).padStart(4, '0')}.png` },
            [SpriteSet.Legendary3]: { dir: 'assets/sprites/5g_horse_run', file: (i) => `3horse_run_${String((Number(i) || 1) - 1).padStart(4, '0')}.png` }
        };

        const RaceSpriteScale = {
            [SpriteSet.Horse]: 1.1,
            [SpriteSet.Rare]: 1.064,
            [SpriteSet.Rare2]: 0.908,
            [SpriteSet.Epic]: 0.911,
            [SpriteSet.Legendary]: 0.966,
            [SpriteSet.Legendary2]: 0.885,
            [SpriteSet.Legendary3]: 0.971
        };

        const BurstAssets = {
            dir: 'assets/effects/chixiao_burst',
            frames: ['ef_001_p_gl_586.png', 'ef_001_p_gl_587.png', 'ef_001_p_gl_588.png']
        };
        const JifengAssets = {
            dir: 'assets/effects/18',
            frames: [
                'battleAttackSkill_20001.png', 'battleAttackSkill_20002.png', 'battleAttackSkill_20003.png', 'battleAttackSkill_20004.png'
            ]
        };
        const LanyingAssets = {
            dir: 'assets/effects/55',
            frames: [
                'battleBufferEffect9_10001.png', 'battleBufferEffect9_10002.png', 'battleBufferEffect9_10003.png',
                'battleBufferEffect9_10004.png', 'battleBufferEffect9_10005.png', 'battleBufferEffect9_10006.png',
                'battleBufferEffect9_10007.png', 'battleBufferEffect9_10008.png', 'battleBufferEffect9_10009.png',
                'battleBufferEffect9_10010.png'
            ]
        };
        const LieyanAssets = {
            dir: 'assets/effects/lieyan_burst',
            frames: [
                'battleAttack_60001.png', 'battleAttack_60002.png', 'battleAttack_60003.png',
                'battleAttack_60004.png', 'battleAttack_60005.png', 'battleAttack_60006.png'
            ]
        };

        const NewYearGreetings = [
            'æ­å–œå‘è´¢','æ–°å¹´å¿«ä¹','ä¸‡äº‹å¦‚æ„','é˜–å®¶å¹¸ç¦','å¿ƒæƒ³äº‹æˆ','å‰æ˜Ÿé«˜ç…§','ç¦æ˜Ÿé«˜ç…§','è´¢æºå¹¿è¿›','å¤§å‰å¤§åˆ©','å¹´å¹´æœ‰ä½™',
            'æ­¥æ­¥é«˜å‡','äº‹ä¸šæœ‰æˆ','é¾™é©¬ç²¾ç¥','ä¸€å¸†é£é¡º','å¹³å®‰å–œä¹','ç¦å¯¿å®‰åº·','å‰ç¥¥å¦‚æ„','èŠ±å¼€å¯Œè´µ','äº”ç¦ä¸´é—¨','å››å­£å¹³å®‰',
            'å–œæ°”ç›ˆé—¨','é¸¿è¿å½“å¤´','é‡‘ç‰æ»¡å ‚','å–œä¹å®‰å®','æ˜¥å›å¤§åœ°','ä¸‡è±¡æ›´æ–°','ç‘æ°”ç›ˆé—¨','è´¢è¿äº¨é€š','ç¦æ»¡äººé—´','å¥½äº‹æˆåŒ',
            'è¿æ˜¥çº³ç¦','ç¦è¿ç»µé•¿','å²å²å®‰åº·','ç¦æ³½æ·±åš','å–œä¸Šçœ‰æ¢¢','å¼€é—¨è§å–œ','ç´«æ°”ä¸œæ¥','ä¸‡ç¦é½è‡»','æ˜¥é£å¾—æ„','ç¦æ¥è¿è½¬'
        ];

        const NewYearPrefixes = ['æ–°æ˜¥','è¿æ˜¥','æ­å–œ','ä¸‡äº‹','é˜–å®¶','äº”ç¦','å››å­£','è´¢æº','ç¦æ˜Ÿ','å‰æ˜Ÿ','é¸¿è¿','ç‘æ°”','å–œæ°”','é‡‘ç‰','èŠ±å¼€','å²å²','ç¦å¯¿','å¹³å®‰'];
        const NewYearSuffixes = ['çº³ç¦','è¿›å®','å¦‚æ„','å®‰åº·','ä¸´é—¨','é«˜ç…§','ç›ˆé—¨','æ»¡å ‚','é¡ºé‚','åº·æ³°','é•¿ä¹…','å‰ç¥¥','åŒåº†','å¤§å‰','å–œä¹','å›¢åœ†','æ˜Œç››','å…´æ—º'];

        const pickLegendarySpriteSet = () => {
            const r = Math.random();
            return r < 1/3 ? SpriteSet.Legendary : (r < 2/3 ? SpriteSet.Legendary2 : SpriteSet.Legendary3);
        };
        
        const InitialPlayer = {
            integral: 2000,
            ticketsNormal: 30,
            seasonNo: 1,
            spriteCodex: {},
            horses: [{
                id: 'h1', name: 'èµ¤å…”', color: '#e63946', quality: 'æ™®é€š',
                baseSpeed: 55, stamina: 70, accel: 0.8, temper: 0.9,
                lifespan: 50, maxLifespan: 50, 
                genes: [{type:'ç–¾é£', quality:'æ™®é€š'}], 
                geneSlots: 6,
                spriteSet: SpriteSet.Horse,
                totalRaces: 0
            }, {
                id: 'g1', name: 'å°ç°', color: '#74b9ff', quality: 'æ™®é€š',
                baseSpeed: 52, stamina: 65, accel: 0.75, temper: 0.8,
                lifespan: 50, maxLifespan: 50,
                genes: [],
                geneSlots: 6,
                spriteSet: SpriteSet.Base,
                totalRaces: 0
            }],
            seasonWins: 0,
            seasonRaces: 0,
            seasonBottoms: 0, // æ–°å¢ï¼šå€’æ•°æ’åï¼ˆ4-5åï¼‰ç´¯è®¡æ¬¡æ•°
            aiStable: [], // æ–°å¢ AI é©¬å©
            trophies: 0, // æ–°å¢ï¼šèµ›å­£å† å†›å¥–æ¯
            hasSeasonChampion: false // æ–°å¢ï¼šå½“å‰æ˜¯å¦æŒæœ‰èµ›å­£å† å†›è£èª‰ï¼ˆæŒç»­ä¸€èµ›å­£ï¼‰
        };

        // åˆå§‹åŒ–ä¸€äº›å¼ºåŠ› AI é©¬
        function initAIStable() {
            // AI é©¬å©åˆå§‹ä¸æ”¾å¤ªå¼ºçš„ï¼Œè€Œæ˜¯æ ¹æ®ç©å®¶åˆå§‹é©¬ç”Ÿæˆç±»ä¼¼çš„
            const stable = [];
            // ç”Ÿæˆ4åŒ¹ä¸ç©å®¶åˆå§‹é©¬è´¨é‡ç›¸è¿‘çš„é©¬
            for (let i = 0; i < 4; i++) {
                stable.push({
                    id: 'ai_base_'+i, name: 'AI-G'+i, color: '#aaa',
                    quality: 'æ™®é€š', // åˆå§‹é»˜è®¤æ™®é€šï¼Œä¸ç©å®¶ä¸€è‡´
                    baseSpeed: 55, stamina: 70, accel: 0.8, lifespan: 999,
                    genes: [], geneSlots: 6, // åˆå§‹ä¸ç©å®¶ä¸€è‡´
                    spriteSet: Math.random() < 0.35 ? SpriteSet.Base : SpriteSet.Horse
                });
            }
            return stable;
        }
        InitialPlayer.aiStable = initAIStable();

        function generateAIHorse(i, player, playerHorseOrQuality = 'æ™®é€š') {
            // å‚æ•°å…¼å®¹ï¼šå¦‚æœæ˜¯å­—ç¬¦ä¸²åˆ™ä¸º qualityï¼Œå¦‚æœæ˜¯å¯¹è±¡åˆ™ä¸º horse
            let playerHorseQuality = 'æ™®é€š';
            let playerBaseSpeed = 55;
            
            if (typeof playerHorseOrQuality === 'string') {
                playerHorseQuality = playerHorseOrQuality;
            } else if (playerHorseOrQuality && typeof playerHorseOrQuality === 'object') {
                playerHorseQuality = playerHorseOrQuality.quality || 'æ™®é€š';
                playerBaseSpeed = playerHorseOrQuality.baseSpeed || 55;
            }

            // ä¼˜å…ˆä» AI é©¬å©ä¸­é€‰æœ€å¼ºçš„å‡ºæˆ˜
            // è¯„åˆ†æ ‡å‡†ï¼šåŸºç¡€é€Ÿåº¦ + æŠ€èƒ½è¯„åˆ†
            const stable = player && player.aiStable ? player.aiStable : [];
            
            // éšç€èµ›å­£è¿›è¡Œï¼ŒAI å¼ºåº¦åŠ¨æ€æå‡
            // ç®€å•æ¨¡æ‹Ÿï¼šèµ›å­£åœºæ¬¡è¶Šå¤šï¼Œç”Ÿæˆçš„ä¸´æ—¶ AI è¶Šå¼º
            const seasonBonus = player ? (player.seasonRaces || 0) * 0.5 : 0;

            if (stable.length > 0) {
                 // ç®€å•æ’åºï¼Œé€‰æœ€å¥½çš„
                 stable.sort((a,b) => b.baseSpeed - a.baseSpeed);
                 const best = stable[i % stable.length]; // å¾ªç¯å–ï¼Œé¿å…éƒ½å–åŒä¸€ä¸ª
                 
                 // å¦‚æœæ˜¯ç¬¬ä¸€èµ›å­£å‰å‡ åœºï¼Œå¼ºåˆ¶å°† AI é©¬çš„è´¨é‡ä¿®æ­£ä¸ºä¸ç©å®¶ä¸€è‡´ï¼Œé¿å…åˆå§‹ AI è¿‡å¼º
                 // è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šå¦‚æœ AI é©¬æ˜¯åˆå§‹ç”Ÿæˆçš„ï¼ˆidåŒ…å« ai_baseï¼‰ï¼Œåˆ™åŠ¨æ€è°ƒæ•´å…¶å±æ€§
                 // è¿™æ ·æ—¢ä¿ç•™äº† AI æˆé•¿æ€§ï¼ˆé€‰ç§€æˆªèƒ¡ï¼‰ï¼Œåˆä¿è¯äº†åˆå§‹å…¬å¹³
                 
                 let finalBaseSpeed = best.baseSpeed + seasonBonus;
                 let finalGeneSlots = best.geneSlots;
                 let finalQuality = best.quality;
                 
                 // åŠ¨æ€ä¿®æ­£åˆå§‹ AI
                 if (best.id.startsWith('ai_base_')) {
                     // å¼ºåˆ¶åŒæ­¥ç©å®¶ç­‰çº§
                     finalQuality = playerHorseQuality;
                     // åŒæ­¥æ§½ä½
                     const slotsMap = { 'æ™®é€š': 3, 'ä¸­çº§': 4, 'é«˜çº§': 5, 'ç¨€æœ‰': 6, 'ç¥å…½': 6 };
                     // æ³¨æ„ï¼šç©å®¶åˆå§‹é©¬è™½ç„¶æ˜¯æ™®é€šï¼Œä½†å¯èƒ½æœ‰6ä¸ªæ§½ï¼ˆä¸ºäº†ä½“éªŒï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œ AI ä¹Ÿè¦å¯¹é½
                     // å¦‚æœç©å®¶æ˜¯æ™®é€šä½†æœ‰6ä¸ªæ§½ï¼ŒAI ä¹Ÿåº”è¯¥æœ‰6ä¸ªæ§½
                     // è¿™é‡Œç®€åŒ–å¤„ç†ï¼šç›´æ¥è¯»å–ç©å®¶å½“å‰é©¬çš„æ§½ä½æ•°æ¯”è¾ƒéš¾ï¼ˆå‚æ•°åªä¼ äº† qualityï¼‰
                     // ä½†æˆ‘ä»¬å¯ä»¥æ ¹æ® quality ç»™ä¸€ä¸ªæ ‡å‡†å€¼ï¼Œæˆ–è€…ç›´æ¥ç”¨ best.geneSlots (åˆå§‹åŒ–æ—¶å·²è®¾ä¸º6)
                     finalGeneSlots = 6; // åˆå§‹ AI ç»Ÿä¸€ç»™ 6 æ§½ï¼Œä¸ç©å®¶ä¸€è‡´
                     
                     // ä¿®æ­£é€Ÿåº¦ï¼šä¸èƒ½åªçœ‹ qualityï¼Œè¦å‚è€ƒç©å®¶å®é™…é€Ÿåº¦
                     // é™åˆ¶ AI é€Ÿåº¦ä¸èƒ½è¶…è¿‡ç©å®¶å¤ªå¤š (ä¾‹å¦‚ +5)
                     const maxAllowed = playerBaseSpeed + 5;
                     
                     let baseSpd = 55;
                     if (finalQuality === 'ä¸­çº§') baseSpd = 60;
                     else if (finalQuality === 'é«˜çº§') baseSpd = 65;
                     else if (finalQuality === 'ç¨€æœ‰') baseSpd = 70;
                     else if (finalQuality === 'ç¥å…½') baseSpd = 75;
                     
                     // åº”ç”¨è½¯ä¸Šé™ï¼šç¡®ä¿ AI æˆé•¿æ˜¯æ¸è¿›çš„
                     finalBaseSpeed = Math.min(baseSpd + seasonBonus, maxAllowed);
                 }

                 // å…‹éš†ä¸€ä¸ªå‡ºæˆ˜å¯¹è±¡ï¼Œé¿å…ä¿®æ”¹åŸæ•°æ®
                 return {
                     ...best,
                     id: 'ai_race_' + i + '_' + Date.now(),
                     quality: finalQuality,
                     geneSlots: finalGeneSlots,
                     baseSpeed: finalBaseSpeed,
                     spriteSet: finalQuality === 'ç¥å…½'
                        ? pickLegendarySpriteSet()
                        : (finalQuality === 'å²è¯—'
                            ? SpriteSet.Epic
                            : (finalQuality === 'ç¨€æœ‰'
                                ? (Math.random() < 0.5 ? SpriteSet.Rare : SpriteSet.Rare2)
                                : (best.spriteSet || (Math.random() < 0.35 ? SpriteSet.Base : SpriteSet.Horse))))
                 };
            }
            
            // å¦‚æœé©¬å©æ²¡é©¬ï¼Œç”Ÿæˆä¸´æ—¶çš„
            // åŠ¨æ€åŒ¹é…ç©å®¶é©¬çš„è´¨é‡ï¼šå°½é‡ç”ŸæˆåŒçº§æˆ–ç¨å¼±çš„é©¬ï¼Œå¶å°”ç”Ÿæˆæ›´å¼ºçš„
            const ladder = ['æ™®é€š','ä¸­çº§','é«˜çº§','ç¨€æœ‰','ç¥å…½'];
            let qIdx = ladder.indexOf(playerHorseQuality);
            if (qIdx === -1) qIdx = 0;
            
            // éšæœºæ³¢åŠ¨ï¼š-1 åˆ° +1 ä¹‹é—´ï¼Œæ¨¡æ‹ŸåŒ¹é…
            let aiQIdx = qIdx + Math.floor(Math.random() * 3) - 1;
            aiQIdx = Math.max(0, Math.min(ladder.length - 1, aiQIdx));
            const aiQuality = ladder[aiQIdx];
            
            // æ ¹æ®è´¨é‡è®¾å®šåŸºç¡€å±æ€§
            let baseSpd = 55;
            let slots = 3;
            // ç©å®¶åˆå§‹é©¬æ˜¯æ™®é€šä½†æœ‰6æ§½ï¼Œä¸ºäº†å…¬å¹³ï¼Œå¦‚æœ AI åŒ¹é…åˆ°æ™®é€šï¼Œä¹Ÿç»™å®ƒå¤šç‚¹æ§½ä½
            if (aiQuality === 'æ™®é€š') slots = 6; 
            else if (aiQuality === 'ä¸­çº§') { baseSpd = 60; slots = 4; }
            else if (aiQuality === 'é«˜çº§') { baseSpd = 65; slots = 5; }
            else if (aiQuality === 'ç¨€æœ‰') { baseSpd = 70; slots = 6; }
            else if (aiQuality === 'ç¥å…½') { baseSpd = 75; slots = 6; }
            
            // é™åˆ¶ AI é€Ÿåº¦ä¸Šé™ï¼šä¸è¶…è¿‡ç©å®¶é€Ÿåº¦ + 5 + èµ›å­£åŠ æˆ
            // è¿™æ ·å³ä½¿éšæœºåˆ°äº†é«˜ç­‰çº§é©¬ï¼Œæ•°å€¼ä¹Ÿä¸ä¼šå¤ªç¦»è°±
            const cappedSpeed = Math.min(baseSpd, playerBaseSpeed + 5);
            
            return {
                id: 'ai_'+i, name: 'AI-'+i, 
                color: aiQuality==='ç¥å…½'?'#e74c3c':(aiQuality==='å²è¯—'?'#9b59b6':(aiQuality==='ç¨€æœ‰'?'#f1c40f':'#ecf0f1')),
                quality: aiQuality,
                baseSpeed: cappedSpeed + Math.random()*5 + seasonBonus, 
                accel: 0.5, lifespan: 50,
                genes: [], geneSlots: slots,
                spriteSet: aiQuality === 'ç¥å…½'
                    ? pickLegendarySpriteSet()
                    : (aiQuality === 'å²è¯—'
                        ? SpriteSet.Epic
                        : (aiQuality === 'ç¨€æœ‰'
                            ? (Math.random() < 0.5 ? SpriteSet.Rare : SpriteSet.Rare2)
                            : (Math.random() < 0.35 ? SpriteSet.Base : SpriteSet.Horse)))
            };
        }

        // --- ç§»æ¤ BreedingSystem.ts (ç®€åŒ–ç‰ˆ) ---
        const BreedingSystem = {
            breedHorse(p1, p2) {
                const name = p1.name[0] + p2.name[p2.name.length-1] + 'é©¹';
                const ladder = ['æ™®é€š','ä¸­çº§','é«˜çº§','ç¨€æœ‰'];
                const quality = ladder[Math.floor(Math.random() * ladder.length)];
                const slotsMap = { 'æ™®é€š': 3, 'ä¸­çº§': 4, 'é«˜çº§': 5, 'ç¨€æœ‰': 6 };
                const geneSlots = slotsMap[quality] || 3;
                
                const allTypes = Object.values(GeneType);
                const poolCount = Math.max(1, Math.min(6, Math.floor(Math.random() * 6) + 1));
                const shuffled = [...allTypes].sort(() => 0.5 - Math.random());
                const chosen = shuffled.slice(0, poolCount);
                const rareIndex = Math.floor(Math.random() * chosen.length);
                let genes = chosen.map((t, idx) => ({ type: t, quality: idx === rareIndex ? 'ç¨€æœ‰' : 'æ™®é€š' }));
                
                // ä»çˆ¶çº§ä¿ç•™ä¸€ä¸ªæœ€é«˜ç¨€æœ‰åº¦æŠ€èƒ½
                const parentGenes = ([]).concat(p1.genes || [], p2.genes || []);
                if (parentGenes.length > 0) {
                    const rank = { 'æ™®é€š': 0, 'ä¸­çº§': 1, 'é«˜çº§': 2, 'ç¨€æœ‰': 3 };
                    const maxRank = parentGenes.reduce((m, g) => Math.max(m, rank[g.quality] ?? 0), 0);
                    const topGenes = parentGenes.filter(g => (rank[g.quality] ?? 0) === maxRank);
                    const keep = topGenes[Math.floor(Math.random() * topGenes.length)];
                    if (keep) {
                        const idx = genes.findIndex(g => g.type === keep.type);
                        if (idx !== -1) {
                            // å‡çº§ä¸ºçˆ¶çº§çš„æœ€é«˜ç¨€æœ‰åº¦
                            const rr = { 'æ™®é€š': 0, 'ä¸­çº§': 1, 'é«˜çº§': 2, 'ç¨€æœ‰': 3 };
                            if ((rr[genes[idx].quality] ?? 0) < (rr[keep.quality] ?? 0)) {
                                genes[idx].quality = keep.quality;
                            }
                        } else {
                            // å°†çˆ¶çº§æŠ€èƒ½åŠ å…¥ï¼Œå¹¶ä¿è¯æ€»æ•°ä¸è¶…è¿‡6
                            genes.unshift({ type: keep.type, quality: keep.quality });
                            // å»é‡å¹¶æˆªæ–­åˆ°æœ€å¤š6ä¸ª
                            const uniq = new Map();
                            genes.forEach(g => { if (!uniq.has(g.type)) uniq.set(g.type, g); });
                            genes = Array.from(uniq.values()).slice(0, 6);
                        }
                    }
                }
                
                return {
                    id: 'bred_'+Date.now(), name,
                    color: quality==='ç¥å…½'?'#e74c3c':(quality==='å²è¯—'?'#9b59b6':(quality==='ç¨€æœ‰'?'#f1c40f':'#ecf0f1')),
                    quality,
                    baseSpeed: (p1.baseSpeed + p2.baseSpeed)/2 * 1.05,
                    stamina: 60, accel: 0.8, temper: 0.5,
                    lifespan: 50, maxLifespan: 50, genes, geneSlots,
                    spriteSet: quality === 'ç¥å…½'
                        ? pickLegendarySpriteSet()
                        : (quality === 'å²è¯—'
                            ? SpriteSet.Epic
                            : (quality === 'ç¨€æœ‰'
                                ? (Math.random() < 0.5 ? SpriteSet.Rare : SpriteSet.Rare2)
                                : (Math.random() < 0.5 ? (p1.spriteSet || SpriteSet.Horse) : (p2.spriteSet || SpriteSet.Horse)))),
                    totalRaces: 0
                };
            },
            
            reforgeSkills(horse) {
                if (!horse.genes || horse.genes.length === 0) return null;
                
                const count = horse.genes.length;
                const newGenes = [];
                const allTypes = Object.values(GeneType);
                // æ´—ç‰Œ
                const shuffled = [...allTypes].sort(() => 0.5 - Math.random());
                
                for(let i=0; i<count; i++) {
                    if (i >= shuffled.length) break;
                    const type = shuffled[i];
                    const quality = Math.random() < 0.1 ? 'ç¨€æœ‰' : 'æ™®é€š';
                    newGenes.push({ type, quality });
                }
                return newGenes;
            }
        };

        // --- ç®€æ˜“æ¸¸æˆå¼•æ“ ---
        class Game {
            constructor() {
                this.player = JSON.parse(JSON.stringify(InitialPlayer));
                this.selectedHorseId = this.player.horses[0].id; // é»˜è®¤é€‰ä¸­ç¬¬ä¸€åŒ¹
                this.horses = [];
                this.racing = false;
                this.stableCap = 5;
                this.idleAnimTimer = null;
                this.avatarDirPath = 'Test Friend Avatar';
                this.avatarList = null;
                this.horseRunFrameCss = null;
                this.horseRunFramesReady = null;
                this.horseRunImages = null;
                this.burstFrameCss = null;
                this.burstFramesReady = null;
                this.burstImages = null;
                this.jifengFrameCss = null;
                this.jifengFramesReady = null;
                this.jifengImages = null;
                this.lanyingFrameCss = null;
                this.lanyingFramesReady = null;
                this.lanyingImages = null;
                this.lieyanFrameCss = null;
                this.lieyanFramesReady = null;
                this.lieyanImages = null;
                this.stableIdleToken = 0;

                if (!this.player.spriteCodex || typeof this.player.spriteCodex !== 'object') this.player.spriteCodex = {};

                const baseHorse = this.player.horses.find(h => h && h.id === 'g1');
                if (baseHorse && (!Array.isArray(baseHorse.genes) || baseHorse.genes.length === 0)) {
                    const allTypes = Object.values(GeneType);
                    const type = allTypes[Math.floor(Math.random() * allTypes.length)];
                    baseHorse.genes = [{ type, quality: 'æ™®é€š' }];
                }
                
                // åˆå§‹åŒ–å®¿æ•Œæ±  (4åŒ¹å›ºå®šå¯¹æ‰‹ï¼Œå‡å°‘æ•°é‡ä»¥ä¼˜åŒ–æ˜¾ç¤º)
                this.rivals = Array.from({length: 4}, (_, i) => generateAIHorse(i));
                
                this.horseRunFramesReady = this.preloadHorseRunFrames();
                this.burstFramesReady = this.preloadBurstFrames();
                this.jifengFramesReady = this.preloadJifengFrames();
                this.lanyingFramesReady = this.preloadLanyingFrames();
                this.lieyanFramesReady = this.preloadLieyanFrames();
                this.updateUI();
                this.initAvatarFlow();
                
                // ä¸´æ—¶å˜é‡
                this.tempReforgeGenes = null;
            }

            escapeHtml(value) {
                return String(value ?? '')
                    .replaceAll('&', '&amp;')
                    .replaceAll('<', '&lt;')
                    .replaceAll('>', '&gt;')
                    .replaceAll('"', '&quot;')
                    .replaceAll("'", '&#39;');
            }

            pickUniqueNewYearName(used) {
                const usedSet = used instanceof Set ? used : new Set();
                const pool = [...NewYearGreetings].sort(() => 0.5 - Math.random());
                for (const n of pool) {
                    if (!usedSet.has(n)) {
                        usedSet.add(n);
                        return n;
                    }
                }
                for (let t = 0; t < 200; t++) {
                    const n = NewYearPrefixes[Math.floor(Math.random() * NewYearPrefixes.length)] +
                        NewYearSuffixes[Math.floor(Math.random() * NewYearSuffixes.length)];
                    if (n.length === 4 && !usedSet.has(n)) {
                        usedSet.add(n);
                        return n;
                    }
                }
                for (let i = 0; i < 9999; i++) {
                    const n = 'æ–°æ˜¥çº³ç¦';
                    const cand = i === 0 ? n : (n.slice(0, 2) + String(i).padStart(2, '0').slice(-2));
                    if (!usedSet.has(cand)) {
                        usedSet.add(cand);
                        return cand;
                    }
                }
                return 'æ–°å¹´å¿«ä¹';
            }

            preloadHorseRunFrames() {
                if (this.horseRunFrameCss && typeof this.horseRunFrameCss === 'object') return this.horseRunFramesReady || Promise.resolve(true);
                const frameCount = 20;
                const sets = {};
                const images = {};
                const decodes = [];

                for (const [key, def] of Object.entries(SpriteAssets)) {
                    const list = new Array(frameCount + 1);
                    const imgList = new Array(frameCount + 1);
                    for (let i = 1; i <= frameCount; i++) {
                        const url = `${def.dir}/${def.file(i)}`;
                        list[i] = `url('${url}')`;
                        const img = new Image();
                        img.decoding = 'async';
                        img.loading = 'eager';
                        const ready = new Promise(resolve => {
                            img.onload = () => resolve(true);
                            img.onerror = () => resolve(false);
                        });
                        img.src = url;
                        imgList[i] = img;
                        decodes.push(typeof img.decode === 'function' ? img.decode().then(() => true).catch(() => ready) : ready);
                    }
                    sets[key] = list;
                    images[key] = imgList;
                }

                this.horseRunFrameCss = sets;
                this.horseRunImages = images;
                this.horseRunFramesReady = Promise.all(decodes).then(() => true);
                return this.horseRunFramesReady;
            }

            preloadBurstFrames() {
                if (this.burstFrameCss && typeof this.burstFrameCss === 'object') return this.burstFramesReady || Promise.resolve(true);
                const frameCount = BurstAssets.frames.length;
                const list = new Array(frameCount + 1);
                const imgList = new Array(frameCount + 1);
                const decodes = [];
                for (let i = 1; i <= frameCount; i++) {
                    const url = `${BurstAssets.dir}/${BurstAssets.frames[i - 1]}`;
                    list[i] = `url('${url}')`;
                    const img = new Image();
                    img.decoding = 'async';
                    img.loading = 'eager';
                    const ready = new Promise(resolve => {
                        img.onload = () => resolve(true);
                        img.onerror = () => resolve(false);
                    });
                    img.src = url;
                    imgList[i] = img;
                    decodes.push(typeof img.decode === 'function' ? img.decode().then(() => true).catch(() => ready) : ready);
                }
                this.burstFrameCss = { chixiao: list };
                this.burstImages = { chixiao: imgList };
                this.burstFramesReady = Promise.all(decodes).then(() => true);
                return this.burstFramesReady;
            }

            preloadJifengFrames() {
                if (this.jifengFrameCss && typeof this.jifengFrameCss === 'object') return this.jifengFramesReady || Promise.resolve(true);
                const frameCount = JifengAssets.frames.length;
                const list = new Array(frameCount + 1);
                const imgList = new Array(frameCount + 1);
                const decodes = [];
                for (let i = 1; i <= frameCount; i++) {
                    const url = `${JifengAssets.dir}/${JifengAssets.frames[i - 1]}`;
                    list[i] = `url('${url}')`;
                    const img = new Image();
                    img.decoding = 'async';
                    img.loading = 'eager';
                    const ready = new Promise(resolve => {
                        img.onload = () => resolve(true);
                        img.onerror = () => resolve(false);
                    });
                    img.src = url;
                    imgList[i] = img;
                    decodes.push(typeof img.decode === 'function' ? img.decode().then(() => true).catch(() => ready) : ready);
                }
                this.jifengFrameCss = { jifeng: list };
                this.jifengImages = { jifeng: imgList };
                this.jifengFramesReady = Promise.all(decodes).then(() => true);
                return this.jifengFramesReady;
            }

            preloadLanyingFrames() {
                if (this.lanyingFrameCss && typeof this.lanyingFrameCss === 'object') return this.lanyingFramesReady || Promise.resolve(true);
                const frameCount = LanyingAssets.frames.length;
                const list = new Array(frameCount + 1);
                const imgList = new Array(frameCount + 1);
                const decodes = [];
                for (let i = 1; i <= frameCount; i++) {
                    const url = `${LanyingAssets.dir}/${LanyingAssets.frames[i - 1]}`;
                    list[i] = `url('${url}')`;
                    const img = new Image();
                    img.decoding = 'async';
                    img.loading = 'eager';
                    const ready = new Promise(resolve => {
                        img.onload = () => resolve(true);
                        img.onerror = () => resolve(false);
                    });
                    img.src = url;
                    imgList[i] = img;
                    decodes.push(typeof img.decode === 'function' ? img.decode().then(() => true).catch(() => ready) : ready);
                }
                this.lanyingFrameCss = { lanying: list };
                this.lanyingImages = { lanying: imgList };
                this.lanyingFramesReady = Promise.all(decodes).then(() => true);
                return this.lanyingFramesReady;
            }

            preloadLieyanFrames() {
                if (this.lieyanFrameCss && typeof this.lieyanFrameCss === 'object') return this.lieyanFramesReady || Promise.resolve(true);
                const frameCount = LieyanAssets.frames.length;
                const list = new Array(frameCount + 1);
                const imgList = new Array(frameCount + 1);
                const decodes = [];
                for (let i = 1; i <= frameCount; i++) {
                    const url = `${LieyanAssets.dir}/${LieyanAssets.frames[i - 1]}`;
                    list[i] = `url('${url}')`;
                    const img = new Image();
                    img.decoding = 'async';
                    img.loading = 'eager';
                    const ready = new Promise(resolve => {
                        img.onload = () => resolve(true);
                        img.onerror = () => resolve(false);
                    });
                    img.src = url;
                    imgList[i] = img;
                    decodes.push(typeof img.decode === 'function' ? img.decode().then(() => true).catch(() => ready) : ready);
                }
                this.lieyanFrameCss = { lieyan: list };
                this.lieyanImages = { lieyan: imgList };
                this.lieyanFramesReady = Promise.all(decodes).then(() => true);
                return this.lieyanFramesReady;
            }

            horseRunFrame(i, spriteSetKey) {
                const idx = Number(i) || 1;
                const key = (spriteSetKey && this.horseRunFrameCss && this.horseRunFrameCss[spriteSetKey]) ? spriteSetKey : SpriteSet.Horse;
                const list = this.horseRunFrameCss && this.horseRunFrameCss[key];
                if (Array.isArray(list) && list[idx]) return list[idx];
                const def = SpriteAssets[key] || SpriteAssets[SpriteSet.Horse];
                return `url('${def.dir}/${def.file(idx)}')`;
            }

            async ensureHorseRunFramesReady() {
                try {
                    if (!this.horseRunFramesReady) this.horseRunFramesReady = this.preloadHorseRunFrames();
                    await this.horseRunFramesReady;
                } catch (_) {}
            }

            async ensureBurstFramesReady() {
                try {
                    if (!this.burstFramesReady) this.burstFramesReady = this.preloadBurstFrames();
                    await this.burstFramesReady;
                } catch (_) {}
            }

            async ensureJifengFramesReady() {
                try {
                    if (!this.jifengFramesReady) this.jifengFramesReady = this.preloadJifengFrames();
                    await this.jifengFramesReady;
                } catch (_) {}
            }

            async ensureLanyingFramesReady() {
                try {
                    if (!this.lanyingFramesReady) this.lanyingFramesReady = this.preloadLanyingFrames();
                    await this.lanyingFramesReady;
                } catch (_) {}
            }

            async ensureLieyanFramesReady() {
                try {
                    if (!this.lieyanFramesReady) this.lieyanFramesReady = this.preloadLieyanFrames();
                    await this.lieyanFramesReady;
                } catch (_) {}
            }

            truncateRaceName(name) {
                const s = String(name ?? '');
                const isAscii = /^[\x00-\x7F]*$/.test(s);
                const maxLen = isAscii ? 6 : 4;
                return s.length > maxLen ? s.slice(0, maxLen) : s;
            }

            setHorseName(horseId, nextName) {
                const horse = this.player.horses.find(h => h.id === horseId);
                if (!horse) return;
                const raw = String(nextName ?? '');
                const cleaned = raw.trim().slice(0, 12);
                horse.name = cleaned || horse.name;
            }

            pushHint(message) {
                if (!this.hints) this.hints = [];
                const text = String(message ?? '').trim();
                if (!text) return;
                this.hints.push(text);
                if (this.hints.length > 12) this.hints = this.hints.slice(-12);
            }

            renderHintsHtml() {
                const list = Array.isArray(this.hints) && this.hints.length > 0
                    ? this.hints
                    : ['å·¦å³æ»‘åŠ¨æŸ¥çœ‹é©¬å©ï¼Œç‚¹æŠ€èƒ½æŸ¥çœ‹è¯´æ˜'];
                return list.map(t => `<div class="hint-chip">${this.escapeHtml(t)}</div>`).join('');
            }

            getAvatarConsent() {
                return localStorage.getItem('wechatAvatarConsent');
            }

            setAvatarConsent(value) {
                localStorage.setItem('wechatAvatarConsent', value);
            }

            initAvatarFlow() {
                const consent = this.getAvatarConsent();
                if (consent === 'granted') {
                    this.ensureAvatarLoaded();
                    return;
                }
                if (consent === 'denied') return;
                this.openAvatarAuthModal();
            }

            openAvatarAuthModal() {
                const modal = document.getElementById('avatar-auth-modal');
                if (modal) modal.style.display = 'flex';
            }

            closeAvatarAuthModal() {
                const modal = document.getElementById('avatar-auth-modal');
                if (modal) modal.style.display = 'none';
            }

            async grantAvatarConsent() {
                this.setAvatarConsent('granted');
                this.closeAvatarAuthModal();
                await this.ensureAvatarLoaded(true);
                this.pushHint('âœ… å·²æˆæƒå¤´åƒå±•ç¤ºï¼Œå¯ç‚¹å‡»å¤´åƒæ›´æ¢');
                this.updateUI();
            }

            denyAvatarConsent() {
                this.setAvatarConsent('denied');
                this.closeAvatarAuthModal();
                this.pushHint('â„¹ï¸ å·²æ‹’ç»å¤´åƒæˆæƒï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ');
                this.updateUI();
            }

            async loadAvatarListFromDirectory() {
                const url = `/${encodeURIComponent(this.avatarDirPath)}/`;
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) return [];
                const html = await res.text();
                const hrefs = Array.from(html.matchAll(/href="([^"]+)"/g)).map(m => m[1] || '');
                const files = hrefs
                    .map(h => h.split('?')[0])
                    .map(h => {
                        const parts = h.split('/').filter(Boolean);
                        return parts.length > 0 ? parts[parts.length - 1] : '';
                    })
                    .filter(h => h && h !== '..' && h !== '.')
                    .map(h => decodeURIComponent(h))
                    .filter(h => /\.(png|jpe?g|webp|gif)$/i.test(h));
                return Array.from(new Set(files));
            }

            getAvatarFile() {
                return localStorage.getItem('playerAvatarFile');
            }

            setAvatarFile(file) {
                localStorage.setItem('playerAvatarFile', file);
            }

            buildAvatarUrl(file) {
                const v = Date.now();
                return `/${encodeURIComponent(this.avatarDirPath)}/${encodeURIComponent(file)}?v=${v}`;
            }

            async ensureAvatarLoaded(forceReloadList = false) {
                if (forceReloadList || !Array.isArray(this.avatarList)) {
                    this.avatarList = await this.loadAvatarListFromDirectory();
                }
                if (!this.avatarList || this.avatarList.length === 0) return;
                const preferred = this.getAvatarFile();
                const selected = preferred && this.avatarList.includes(preferred) ? preferred : this.avatarList[0];
                await this.setAvatarByFile(selected);
            }

            async setAvatarByFile(file) {
                if (!file) return;
                const url = this.buildAvatarUrl(file);
                const ok = await new Promise(resolve => {
                    const img = new Image();
                    img.onload = () => resolve(true);
                    img.onerror = () => resolve(false);
                    img.src = url;
                });
                if (!ok) return;
                this.player.avatarUrl = url;
                this.setAvatarFile(file);
            }

            async openAvatarPicker() {
                if (this.getAvatarConsent() !== 'granted') {
                    this.openAvatarAuthModal();
                    return;
                }
                await this.ensureAvatarLoaded(true);
                const modal = document.getElementById('avatar-picker-modal');
                const listEl = document.getElementById('avatar-picker-list');
                if (!modal || !listEl) return;
                const files = Array.isArray(this.avatarList) ? this.avatarList : [];
                listEl.innerHTML = files.map(f => {
                    const u = this.buildAvatarUrl(f);
                    const encoded = encodeURIComponent(f);
                    return `<button class="avatar-pick" onclick="game.pickAvatarEncoded('${encoded}')"><img src="${u}" alt="${this.escapeHtml(f)}"></button>`;
                }).join('');
                modal.style.display = 'flex';
            }

            closeAvatarPicker() {
                const modal = document.getElementById('avatar-picker-modal');
                if (modal) modal.style.display = 'none';
            }

            async pickAvatarEncoded(encodedFile) {
                if (this.getAvatarConsent() !== 'granted') return;
                const realFile = decodeURIComponent(String(encodedFile ?? ''));
                await this.setAvatarByFile(realFile);
                this.updateUI();
                const hintTrack = document.getElementById('stable-hint-track');
                if (hintTrack) hintTrack.scrollLeft = hintTrack.scrollWidth;
                this.closeAvatarPicker();
            }
            
            skillEffects() {
                return {
                    'ç–¾é£': 'æé«˜ç§»åŠ¨é€Ÿåº¦ï¼ŒæŒç»­åŠ æˆï¼ˆ+8%ï¼‰ï¼Œé€‚åˆç›´çº¿å†²åˆºã€‚',
                    'çˆ†å†²': 'çŸ­æ—¶é—´çˆ†å‘é€Ÿåº¦ï¼ˆ+15%ï¼‰ï¼Œç”¨äºå…³é”®æ—¶åˆ»è¶…è½¦ã€‚',
                    'åšéŸ§': 'æå‡è€åŠ›ä¸é•¿è·ç¦»è¡¨ç°ï¼ˆ+6%ï¼‰ï¼Œåç¨‹ç¨³å®šè¾“å‡ºã€‚',
                    'ç¨³å¥': 'æå‡ç¨³å®šä¸å°å¹…é€Ÿåº¦ï¼ˆ+5%ï¼‰ï¼Œå‡å°‘æ³¢åŠ¨ä¸å¤±è¯¯ã€‚',
                    'çµæ´»': 'æå‡åŠ é€Ÿä¸çµæ•ï¼ˆ+5%ï¼‰ï¼Œæ›´å¿«è¿›å…¥æœ€ä½³é€Ÿåº¦åŒºé—´ã€‚',
                    'ç¥é€Ÿ': 'æ˜¾è‘—æå‡æœ€é«˜é€Ÿåº¦ï¼Œç¬é—´æé€Ÿæ•ˆæœæ›´å¼ºã€‚',
                    'é£é©°': 'æŒç»­å°å¹…é€Ÿåº¦æå‡ï¼Œç¨³æ­¥æ‹‰å¼€å·®è·ã€‚',
                    'æŒä¹…': 'è€åŠ›å¼ºåŒ–ï¼Œé•¿æ—¶é—´ä¿æŒé«˜æ•ˆå¥”è·‘ã€‚',
                    'å›æ˜¥': 'èµ›ä¸­è€åŠ›æ¢å¤ï¼Œç¼“è§£ç–²åŠ³ã€‚',
                    'é“å¿—': 'æ„å¿—åŠ æˆï¼Œé™ä½èµ›ä¸­æŠ–åŠ¨ä¸é€Ÿåº¦æ³¢åŠ¨ã€‚',
                    'æ·±æ¯': 'é•¿è·ç¦»ä¼˜åŠ¿ï¼Œè¶Šè·‘è¶Šç¨³ã€‚',
                    'å†·é™': 'æŠ—å¹²æ‰°ï¼Œå‡å°‘å¤–éƒ¨å› ç´ é€ æˆçš„å‡é€Ÿã€‚',
                    'ä¸“æ³¨': 'èŠ‚å¥æŒæ§ï¼Œåœ¨å…³é”®åŒºæ®µä¿æŒè¾“å‡ºã€‚',
                    'å¦‚å±±': 'å¼ºç¨³å®šæ€§ï¼Œéš¾ä»¥è¢«æ‰°åŠ¨å½±å“ã€‚',
                    'å¹³è¡¡': 'å‡è¡¡å‹å¢ç›Šï¼Œé€Ÿåº¦ä¸ç¨³å®šå°å¹…æå‡ã€‚',
                    'æ··è¡€': 'ç»¼åˆæ€§åŠ æˆï¼Œå„é¡¹å±æ€§å°å¹…æå‡ã€‚',
                    'å¤§å™¨': 'åç¨‹çˆ†å‘ï¼Œæœ€åé˜¶æ®µèƒ½åŠ›æå‡ã€‚',
                    'å…ˆé”‹': 'å¼€å±€å¼ºåŠ¿ï¼Œèµ·æ­¥æ›´å¿«æ›´ç¨³ã€‚',
                    'é£˜ç§»': 'å¼¯é“æ§åˆ¶æå‡ï¼Œè¿‡å¼¯é€Ÿåº¦æŸè€—æ›´ä½ã€‚',
                    'å¡é“': 'å¡é“ä¼˜åŠ¿ï¼Œå¡æ®µé€Ÿåº¦æŸè€—é™ä½ã€‚',
                    'å¤©å‘½': 'ç¥å…½ä¸“å±ï¼Œå…¨é¢å¼ºåŠ›å¢ç›Šã€‚',
                    'å¥‡è¿¹': 'ç»å¢ƒç¿»ç›˜ï¼Œè½åæ—¶è·å¾—é¢å¤–å¢ç›Šã€‚',
                    'æ®‹å½±': 'äº§ç”Ÿè™šå½±ï¼Œå‡å°‘å¯¹æ‰‹å¹²æ‰°åˆ¤å®šã€‚',
                    'æµæ˜Ÿ': 'ç»ˆç›˜æé€Ÿï¼Œå†²çº¿å‰æœ€ååŠ é€Ÿã€‚',
                    'ä¼ è¯´': 'å…¨å±æ€§æå‡ï¼Œå¤§å¹…å¢å¼ºç»¼åˆèƒ½åŠ›ã€‚'
                };
            }

            skillEffectText(type) {
                const effects = this.skillEffects();
                return effects[type] || 'æš‚æ— æŠ€èƒ½æ•ˆæœæè¿°ã€‚';
            }

            renderReforgeSkillBox(which, genes, actives = []) {
                const listEl = document.getElementById(`reforge-${which}-list`);
                const detailEl = document.getElementById(`reforge-${which}-detail`);
                if (!listEl || !detailEl) return;

                const list = Array.isArray(genes) ? genes : [];
                const activeSet = new Set((actives || []).map(a => a.type));

                if (list.length === 0) {
                    listEl.innerHTML = '';
                    const placeholder = which === 'new' ? 'ç‚¹å‡»æ´—ç»ƒç”Ÿæˆ' : 'æš‚æ— æŠ€èƒ½';
                    detailEl.innerHTML = `<div class="reforge-effect-placeholder">${this.escapeHtml(placeholder)}</div>`;
                    if (!this.reforgeSelected) this.reforgeSelected = { current: null, new: null };
                    this.reforgeSelected[which] = null;
                    return;
                }

                listEl.innerHTML = list.map(g => {
                    let cls = 'gene-normal';
                    if (g.quality === 'ç¨€æœ‰') cls = 'gene-rare';
                    else if (g.quality === 'å²è¯—') cls = 'gene-epic';
                    else if (g.quality === 'ç¥å…½') cls = 'gene-legend';
                    const activeCls = activeSet.has(g.type) ? ' gene-active' : '';
                    const encoded = encodeURIComponent(g.type);
                    return `<div class="gene-tag reforge-skill-item ${cls}${activeCls}" data-skill="${this.escapeHtml(g.type)}" onclick="game.selectReforgeSkillEncoded('${which}','${encoded}')">${this.escapeHtml(g.type)}</div>`;
                }).join('');

                if (!this.reforgeSelected) this.reforgeSelected = { current: null, new: null };
                const saved = this.reforgeSelected[which];
                const next = saved && list.some(g => g.type === saved) ? saved : list[0].type;
                this.selectReforgeSkill(which, next);
            }

            selectReforgeSkillEncoded(which, encodedType) {
                const w = String(which || '');
                const type = decodeURIComponent(String(encodedType || ''));
                this.selectReforgeSkill(w, type);
            }

            selectReforgeSkill(which, type) {
                const w = which === 'current' ? 'current' : 'new';
                const listEl = document.getElementById(`reforge-${w}-list`);
                const detailEl = document.getElementById(`reforge-${w}-detail`);
                if (!listEl || !detailEl) return;
                const t = String(type || '').trim();
                if (!t) return;

                if (!this.reforgeSelected) this.reforgeSelected = { current: null, new: null };
                this.reforgeSelected[w] = t;

                const items = Array.from(listEl.querySelectorAll('.reforge-skill-item'));
                for (const el of items) {
                    const key = el.getAttribute('data-skill') || '';
                    if (key === t) el.classList.add('is-selected');
                    else el.classList.remove('is-selected');
                }

                const effect = this.skillEffectText(t);
                const badge = (w === 'new' && this.tempReforgeQuality) ? `<div class="reforge-effect-badge">æ–°ç¨€æœ‰ç­‰çº§: ${this.escapeHtml(this.tempReforgeQuality)}</div>` : '';
                detailEl.innerHTML = `
                    <div class="reforge-effect-title">${this.escapeHtml(t)}</div>
                    ${badge}
                    <div class="reforge-effect-text">${this.escapeHtml(effect)}</div>
                `;
            }
            
            showSkillDetail(type) {
                const titleEl = document.getElementById('skill-title');
                const descEl = document.getElementById('skill-desc');
                const modal = document.getElementById('skill-modal');
                const eff = this.skillEffects()[type] || 'æš‚æ— è¯¥æŠ€èƒ½çš„è¯¦ç»†è¯´æ˜';
                titleEl.innerText = `æŠ€èƒ½ï¼š${type}`;
                descEl.innerText = eff;
                modal.style.display = 'flex';
            }
            
            closeSkillModal() {
                const modal = document.getElementById('skill-modal');
                modal.style.display = 'none';
            }

            openCodex() {
                const panel = document.getElementById('codex-panel');
                if (panel) panel.style.display = 'flex';
                this.renderCodex();
            }

            closeCodex() {
                const panel = document.getElementById('codex-panel');
                if (panel) panel.style.display = 'none';
            }

            renderCodex() {
                const listEl = document.getElementById('codex-list');
                if (!listEl) return;
                if (!this.player.spriteCodex || typeof this.player.spriteCodex !== 'object') this.player.spriteCodex = {};
                listEl.innerHTML = '';
                const sets = Object.values(SpriteSet);
                sets.forEach(spriteSet => {
                    const stars = Number(this.player.spriteCodex[spriteSet]) || 0;
                    const bonus = stars * 3;
                    const card = document.createElement('div');
                    card.style.cssText = 'width:135px; background:#34495e; border:1px solid #555; border-radius:10px; padding:10px; display:flex; gap:10px; align-items:center;';
                    card.innerHTML = `
                        <div class="idle-horse" style="width:54px; height:54px; --idle-scale:1.2;" data-sprite-set="${this.escapeHtml(spriteSet)}" data-idle-horse="1"></div>
                        <div style="text-align:left; flex:1; min-width:0;">
                            <div style="font-size:12px; color:#ecf0f1; font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${this.escapeHtml(spriteSet)}</div>
                            <div style="font-size:10px; color:#f1c40f;">æ˜Ÿçº§: ${stars}</div>
                            <div style="font-size:10px; color:#bdc3c7;">é€Ÿåº¦åŠ æˆ: +${bonus}%</div>
                        </div>
                    `;
                    listEl.appendChild(card);
                });
                const panel = document.getElementById('codex-panel');
                if (panel) this.startStableIdleAnim(panel);
            }
            
            // è®¡ç®—é€Ÿåº¦ï¼šåŸºäº activeGenes (genes)
            // fullGenesï¼šé©¬åŒ¹å·²é¢†æ‚Ÿçš„æŠ€èƒ½æ± ï¼Œç”¨äºè®¡ç®—â€œé¢†æ‚Ÿç¨€æœ‰æŠ€èƒ½â€çš„åŸºç¡€é€Ÿåº¦åŠ æˆ
             computeSpeedWithGenes(baseSpeed, genes, fullGenes = [], withJitter = true, options = null) {
                 const active = Array.isArray(genes) ? genes : [];
                 const spriteSet = options && options.spriteSet ? options.spriteSet : null;
                 const applyCodex = options && options.applyCodex === true;
                 let base = Number(baseSpeed) || 0;
                 if (applyCodex) {
                    if (!this.player.spriteCodex || typeof this.player.spriteCodex !== 'object') this.player.spriteCodex = {};
                    const key = spriteSet || SpriteSet.Horse;
                    const stars = Number(this.player.spriteCodex[key]) || 0;
                    if (stars > 0) base *= (1 + stars * 0.03);
                 }

                 let m = 1.0;
                 active.forEach(g => {
                     const t = g.type;
                    if (t === 'ç–¾é£') m += 0.08;
                    else if (t === 'çˆ†å†²') m += 0.15;
                    else if (t === 'åšéŸ§') m += 0.06;
                    else if (t === 'çµæ´»') m += 0.05;
                    else if (t === 'ç¨³å¥') m += 0.05;
                    else m += 0.03; // å…¶ä»–æŠ€èƒ½ä¹Ÿæœ‰å¾®é‡åŠ æˆ
                });

                if (active.length === 0) m *= 0.98;
                const rareSlots = active.reduce((n, g) => n + (g && g.quality === 'ç¨€æœ‰' ? 1 : 0), 0);
                const rareSlotMult = 1 + rareSlots * 0.03;
                return base * m * rareSlotMult;
             }
            
            slotCountForHorse(h) {
                // ä¼˜å…ˆä½¿ç”¨æ˜¾å¼æŒ‡å®šçš„æ§½ä½æ•°
                if (h.geneSlots) return h.geneSlots;
                
                const q = h.quality;
                if (q === 'ç¨€æœ‰') return 6;
                if (q === 'é«˜çº§') return 5;
                if (q === 'ä¸­çº§') return 4;
                if (q === 'æ™®é€š') return 3;
                return 6;
            }
            
            pickStartGenes(pool, slots) {
                if (!Array.isArray(pool) || pool.length === 0) return [];
                if (pool.length <= slots) return [...pool];
                const shuffled = [...pool].sort(() => 0.5 - Math.random());
                return shuffled.slice(0, slots);
            }
            
            ensureLockedStartGenes(h) {
                const slots = this.slotCountForHorse(h);
                const pool = Array.isArray(h.genes) ? h.genes : [];
                let locked = Array.isArray(h.lockedStartGenes) ? h.lockedStartGenes.slice(0) : [];
                const map = new Map();
                locked.forEach(g => { if (!map.has(g.type)) map.set(g.type, g); });
                let arr = Array.from(map.values());
                if (arr.length > slots) arr = arr.slice(0, slots);
                if (arr.length < slots) {
                    const remain = pool.filter(g => !arr.some(a => a.type === g.type));
                    const shuffled = [...remain].sort(() => 0.5 - Math.random());
                    arr = arr.concat(shuffled.slice(0, slots - arr.length));
                }
                h.lockedStartGenes = arr;
            }

            createNameTag(h) {
                const nameTag = document.createElement('div');
                nameTag.className = 'horse-name-tag'; // ä½¿ç”¨æ–°CSSç±»
                
                // ç»„è£…æ˜¾ç¤ºå†…å®¹ï¼šåå­— + åŸºå› æ ‡ç­¾ (åªæ˜¾ç¤º activeGenes)
                let geneHtml = '';
                if (h.activeGenes && h.activeGenes.length > 0) {
                    geneHtml = h.activeGenes.map(g => 
                        // ä½¿ç”¨ mini-gene-tag ç±»
                        `<span class="mini-gene-tag" style="background:${g.quality==='æ™®é€š'?'#bdc3c7':'#f1c40f'}; color:#000;">${g.type}</span>`
                    ).join('');
                }

                // è®¾ç½® HTMLï¼šç¬¬ä¸€è¡Œæ˜¯åå­—ï¼Œç¬¬äºŒè¡Œæ˜¯æŠ€èƒ½å°æ ‡ç­¾
                // ä¿®æ”¹ï¼šå¦‚æœç©å®¶é©¬åŒ¹ï¼Œåå­—ç”¨ç‰¹æ®Šé¢œè‰²
                // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦åˆ¤æ–­æ˜¯å¦æ˜¯ç©å®¶çš„é©¬ï¼Œè€Œä¸æ˜¯é€‰ä¸­çš„é©¬ï¼ˆè™½ç„¶æ¯”èµ›ä¸­é»˜è®¤é€‰ä¸­çš„å°±æ˜¯ç©å®¶å‚èµ›çš„é©¬ï¼‰
                // æ›´å‡†ç¡®çš„é€»è¾‘æ˜¯æ£€æŸ¥è¿™åŒ¹é©¬æ˜¯å¦åœ¨ç©å®¶çš„ horses åˆ—è¡¨é‡Œï¼Œä½†ç®€å•èµ·è§ï¼Œh.id === this.selectedHorseId é€šå¸¸æœ‰æ•ˆï¼Œ
                // å› ä¸º startRace ä¼šæŠŠç©å®¶é€‰ä¸­çš„é©¬ä½œä¸ºå‚èµ›é©¬ã€‚
                // ä¸è¿‡ä¸ºäº†æ”¯æŒå¤šåŒ¹é©¬å‚èµ›çš„æƒ…å†µï¼ˆå¦‚æœæœªæ¥æ”¯æŒï¼‰ï¼Œæœ€å¥½ç›´æ¥åˆ¤æ–­æ˜¯å¦æ˜¯ç©å®¶æ§åˆ¶çš„ã€‚
                // ç›®å‰é€»è¾‘æ˜¯ç©å®¶åªèƒ½æ´¾ä¸€åŒ¹é€‰ä¸­çš„é©¬ã€‚
                
                const isPlayerHorse = h && h.data && h.data.id === this.selectedHorseId;
                if (isPlayerHorse) nameTag.classList.add('is-player');
                
                nameTag.innerHTML = `
                    <div class="name-row">${this.escapeHtml(this.truncateRaceName(h.data.name))}</div>
                    <div class="skill-row">${geneHtml}</div>
                `;
                
                document.getElementById('ui-layer').appendChild(nameTag);
                h.nameTag = nameTag;
            }

             // æ—§æ–¹æ³•ä¿ç•™å…¼å®¹ (æˆ–åˆ é™¤)
             computeFinalSpeed(data) { return this.computeSpeedWithGenes(data.baseSpeed, data.genes || [], data.genes || [], true, { spriteSet: data && data.spriteSet, applyCodex: true }); }

            selectHorse(id) {
                if (this.racing) return;
                this.selectedHorseId = id;
                this.updateUI();
            }

            promoteHorseToStableFront(horseId) {
                const id = String(horseId ?? '');
                if (!id) return;
                const list = this.player && Array.isArray(this.player.horses) ? this.player.horses : null;
                if (!list || list.length <= 1) return;
                const idx = list.findIndex(h => h && h.id === id);
                if (idx <= 0) return;
                const [horse] = list.splice(idx, 1);
                list.unshift(horse);
            }
            
            prevHorse() {
                if (this.racing) return;
                const list = this.player.horses;
                const idx = list.findIndex(h => h.id === this.selectedHorseId);
                const ni = (idx > 0 ? idx - 1 : list.length - 1);
                this.selectedHorseId = list[ni].id;
                this.updateUI();
            }
            
            nextHorse() {
                if (this.racing) return;
                const list = this.player.horses;
                const idx = list.findIndex(h => h.id === this.selectedHorseId);
                const ni = (idx < list.length - 1 ? idx + 1 : 0);
                this.selectedHorseId = list[ni].id;
                this.updateUI();
            }
            
            scrollSelectedIntoView() {
                const infoPanel = document.getElementById('info-panel');
                const container = infoPanel.querySelector('.stable-container');
                if (!container) return;
                const card = infoPanel.querySelector('.horse-card.selected');
                if (!card) return;
                const center = card.offsetLeft + (card.offsetWidth / 2);
                const target = center - (container.clientWidth / 2);
                container.scrollTo({ left: target, behavior: 'smooth' });
            }

            retireHorse() {
                const horse = this.player.horses.find(h => h.id === this.selectedHorseId);
                if (!horse) return;
                
                if (this.player.horses.length <= 1) {
                    alert("è¿™æ˜¯ä½ æœ€åä¸€åŒ¹é©¬ï¼Œä¸èƒ½é€€å½¹ï¼");
                    return;
                }
                
                const races = horse.totalRaces || 0;
                const refund = races * 100;
                
                if (confirm(`ç¡®å®šè¦è®©ã€${horse.name}ã€‘é€€å½¹å—ï¼Ÿ\nç”Ÿæ¶¯åœºæ¬¡: ${races}\nè¿”è¿˜ç§¯åˆ†: ${refund} (100/åœº)`)) {
                    if (!this.player.spriteCodex || typeof this.player.spriteCodex !== 'object') this.player.spriteCodex = {};
                    const spriteSet = horse.spriteSet || SpriteSet.Horse;
                    const nextStar = (Number(this.player.spriteCodex[spriteSet]) || 0) + 1;
                    this.player.spriteCodex[spriteSet] = nextStar;
                    this.player.integral += refund;
                    const idx = this.player.horses.indexOf(horse);
                    this.player.horses.splice(idx, 1);
                    this.selectedHorseId = this.player.horses[0].id;
                    this.updateUI();
                    alert(`é€€å½¹æˆåŠŸï¼è·å¾— ${refund} ç§¯åˆ†ã€‚\né€ å‹å›¾é‰´ï¼š${spriteSet} æ˜Ÿçº§ +1 (å½“å‰ ${nextStar} æ˜Ÿ)`);
                }
            }

            startStableIdleAnim(rootEl) {
                if (this.idleAnimTimer) {
                    clearInterval(this.idleAnimTimer);
                    this.idleAnimTimer = null;
                }
                if (this.racing) return;

                const horses = Array.from((rootEl || document).querySelectorAll('.idle-horse'));
                if (horses.length === 0) return;
                this.stableIdleToken = (this.stableIdleToken || 0) + 1;
                const token = this.stableIdleToken;

                this.ensureHorseRunFramesReady().then(() => {
                    if (token !== this.stableIdleToken) return;
                    if (this.racing) return;
                    if (this.idleAnimTimer) return;

                    let frameIndex = 1;
                    const applyFrame = () => {
                        for (const el of horses) {
                            const spriteSet = el && el.dataset ? el.dataset.spriteSet : null;
                            el.style.backgroundImage = this.horseRunFrame(frameIndex, spriteSet);
                        }
                    };

                    applyFrame();
                    this.idleAnimTimer = setInterval(() => {
                        frameIndex++;
                        if (frameIndex > 20) frameIndex = 1;
                        applyFrame();
                    }, 80);
                });
            }
            
            updateUI() {
                const p = this.player;
                const infoPanel = document.getElementById('info-panel');
                
                // ä¿ç•™æ¯”èµ›ä¸­é©¬å©æ»šåŠ¨ä½ç½®ï¼Œé˜²æ­¢åˆ·æ–°å¯¼è‡´å¡ç‰‡è·³åŠ¨
                let prevScrollLeft = null;
                const prevContainer = infoPanel.querySelector('.stable-container');
                if (prevContainer) prevScrollLeft = prevContainer.scrollLeft;
                
                // æ¸…é™¤å¯¿å‘½ä¸º0çš„é©¬ (æ”¹ä¸ºä¸è‡ªåŠ¨æ¸…é™¤ï¼Œå…è®¸ç©å®¶æ‰‹åŠ¨é€€å½¹æˆ–ä½œä¸ºç§é©¬ï¼Œé™¤éæ˜¯å¼ºåˆ¶é€»è¾‘)
                // è¿™é‡Œä¸ºäº†é˜²æ­¢åˆ—è¡¨è¿‡é•¿ï¼Œè¿˜æ˜¯ä¿ç•™è‡ªåŠ¨æ¸…ç†å¯¿å‘½è€—å°½çš„é€»è¾‘ï¼Œæˆ–è€…ä»…æç¤º
                // p.horses = p.horses.filter(h => (h.lifespan == null ? true : h.lifespan > 0));
                
                if (p.horses.length === 0) {
                    // ä¿åº•ï¼šå¦‚æœæ¸…ç©ºäº†ï¼Œæ¢å¤åˆå§‹ç¬¬ä¸€åŒ¹ä»¥é¿å…UIç©ºç™½
                    p.horses = JSON.parse(JSON.stringify(InitialPlayer.horses));
                }
                // ä¿è¯é€‰ä¸­IDæœ‰æ•ˆ
                if (!p.horses.find(h => h.id === this.selectedHorseId)) {
                    this.selectedHorseId = p.horses[0].id;
                }
                
                // 1. ç”Ÿæˆèµ„äº§è¡Œ
                const races = p.seasonRaces || 0;
                const wins = p.seasonWins || 0;
                const rate = races > 0 ? Math.floor((wins / races) * 100) : 0;
                
                // åˆ¤æ–­æ˜¯å¦è·å¾—â€œèµ›å­£ç¬¬ä¸€â€è£èª‰ï¼ˆæŒç»­ä¸€èµ›å­£ï¼‰
                // ä½¿ç”¨ hasSeasonChampion æ ‡è®°ï¼Œè€Œä¸æ˜¯å®æ—¶è®¡ç®—
                const isChampion = p.hasSeasonChampion;
                
                // å¥–æ¯é€»è¾‘ï¼šæ¯10ä¸ªå¥–æ¯åˆå¹¶ä¸ºä¸€ä¸ªé«˜çº§å¥–æ¯
                const trophyCount = p.trophies || 0;
                const bigTrophies = Math.floor(trophyCount / 10);
                const smallTrophies = trophyCount % 10;
                let trophyHtml = '';
                if (bigTrophies > 0) trophyHtml += `<span style="color:#f1c40f;">ğŸ†x${bigTrophies}(å¤§)</span> `;
                if (smallTrophies > 0) trophyHtml += `<span style="color:#bdc3c7;">ğŸ†x${smallTrophies}</span>`;
                if (trophyCount === 0) trophyHtml = `<span style="color:#7f8c8d; font-size:10px;">æš‚æ— å¥–æ¯</span>`;

                const avatarUrl = p.avatarUrl || '';
                const avatarCls = avatarUrl ? 'avatar has-img' : 'avatar';
                const avatarStyle = avatarUrl ? `background-image:url('${avatarUrl}');` : '';
                const avatarText = avatarUrl ? '' : 'ğŸ‘¤';

                let html = `
                    <div class="user-panel">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                            <div style="display:flex; align-items:center;">
                                <div class="avatar-wrapper" style="margin-right:10px;">
                                    <div class="${avatarCls}" style="${avatarStyle}" onclick="game.openAvatarPicker()">${avatarText}</div>
                                    ${isChampion ? `<div class="avatar-frame-gold"></div><div class="honor-crown">ğŸ‘‘</div>` : ''}
                                </div>
                                <div>
                                    <div style="font-weight:bold; color:#fff; font-size:16px; display:flex; align-items:center; gap:6px;">
                                        é©¬åœºä¸»
                                        ${isChampion ? '<span style="color:#f1c40f; font-size:10px; background:rgba(241,196,15,0.2); padding:2px 6px; border-radius:4px;">èµ›å­£ç¬¬ä¸€</span>' : ''}
                                    </div>
                                    <div style="display:flex; gap:10px; font-size:12px; color:#bdc3c7; margin-top:3px;">
                                        <span>ğŸ’° ${p.integral}</span>
                                        <span>ğŸ« ${p.ticketsNormal} <button style="background:none; border:none; color:#2ecc71; font-weight:bold; cursor:pointer; font-size:14px; padding:0;" onclick="game.openTicketMenu()">â•</button></span>
                                    </div>
                                    <div style="font-size:10px; margin-top:2px; display:flex; gap:8px; align-items:center;">
                                        <div>${trophyHtml}</div>
                                        <button class="avatar-action" onclick="game.openAvatarPicker()">æ›´æ¢å¤´åƒ</button>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-blue" style="width:auto; height:28px; line-height:28px; font-size:12px; padding:0 12px; background:#c0392b; box-shadow:0 2px #922b21;" onclick="game.retireHorse()">é€€å½¹å½“å‰é©¬</button>
                        </div>

                        <div style="background:#34495e; padding:6px 10px; border-radius:8px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                <span style="color:#f1c40f; font-weight:bold; font-size:12px;">ğŸ† S1 èµ›å­£</span>
                                <span style="color:#ecf0f1; font-size:12px;">èƒœç‡: <span style="color:${rate>=40?'#2ecc71':'#e74c3c'}">${rate}%</span> <span style="color:#7f8c8d; margin-left:4px;">(å·²èµ›${races})</span></span>
                            </div>
                            <div style="height:6px; background:#2c3e50; border-radius:3px; overflow:hidden; border:1px solid #444;">
                                <div style="width:${Math.min(100, (races/8)*100)}%; height:100%; background:linear-gradient(90deg, #f39c12, #f1c40f);"></div>
                            </div>
                            <div style="font-size:10px; color:#95a5a6; margin-top:3px; text-align:right;">
                                ${races >= 8 ? '<span style="color:#2ecc71">âœ… å·²è·é€‰ç§€èµ„æ ¼</span>' : `å†èµ› ${8-races} åœºè·é€‰ç§€èµ„æ ¼`}
                            </div>
                        </div>
                        <div class="stable-hint" style="margin-top:6px;">
                            <div class="stable-hint-track" id="stable-hint-track">${this.renderHintsHtml()}</div>
                        </div>
                    </div>

                    <div class="stable-panel">
                        <div class="stable-container">
                `;

                // æ›´æ–°å¤§å…æŒ‰é’®ï¼šå¦‚æœæ»¡è¶³é€‰ç§€æ¡ä»¶ï¼Œæ·»åŠ é€‰ç§€æŒ‰é’®
                const lobby = document.getElementById('lobby-panel');
                if (lobby) {
                    // ç§»é™¤æ—§çš„é€‰ç§€æŒ‰é’®é¿å…é‡å¤
                    const oldBtn = document.getElementById('btn-open-draft');
                    if (oldBtn) oldBtn.remove();
                    
                    if (races >= 8) {
                        const btn = document.createElement('button');
                        btn.id = 'btn-open-draft';
                        btn.className = 'btn btn-blue';
                        btn.style.background = '#e67e22';
                        btn.style.boxShadow = '0 4px #d35400';
                        btn.innerHTML = 'å‚åŠ é€‰ç§€';
                        btn.onclick = () => this.openDraft();
                        lobby.prepend(btn);
                    }
                }

                // 2. ç”Ÿæˆé©¬åŒ¹å¡ç‰‡
                // let html = ''; // ç¡®ä¿ html å˜é‡è¢«åˆå§‹åŒ– -- ä¿®æ­£ï¼šä¸èƒ½é‡ç½® htmlï¼Œåº”è¯¥è¿½åŠ åˆ°ç°æœ‰çš„ html åé¢
                // ä¸Šé¢çš„ html å˜é‡å·²ç»åœ¨ "1. ç”Ÿæˆèµ„äº§è¡Œ" éƒ¨åˆ†åˆå§‹åŒ–è¿‡äº†ï¼Œè¿™é‡Œæ˜¯è¿½åŠ 
                p.horses.forEach(h => {
                    this.ensureLockedStartGenes(h);
                    
                    // è·å–æ‰€æœ‰æŠ€èƒ½ç±»å‹ï¼Œç”¨äºå±•ç¤ºæŠ€èƒ½æ± ï¼Œå¹¶é«˜äº®æ¯”èµ›ä½¿ç”¨æŠ€èƒ½
                    const allTypes = Object.values(GeneType);
                    const slots = this.slotCountForHorse(h);
                    this.ensureLockedStartGenes(h);
                    const previewActives = (h.lockedStartGenes || []).slice(0, slots);
                    const activeSet = new Set((previewActives || []).map(g => g.type));
                    const rawLearned = ([]).concat(h.learnedThisRace || [], (h.data && h.data.learnedThisRace) ? h.data.learnedThisRace : []);
                    const learnedSet = new Set(rawLearned.filter(t => !activeSet.has(t)));
                    
                    const genesHtml2 = allTypes.map(type => {
                        // ä¼˜å…ˆæ˜¾ç¤ºå½“å‰è£…å¤‡çš„æŠ€èƒ½ (active)ï¼Œå› ä¸ºè¿™å†³å®šäº†æ¯”èµ›èƒ½åŠ›
                        const activeGene = (previewActives || []).find(g => g.type === type);
                        const ownedGene = h.genes && h.genes.find(g => g.type === type);
                        
                        // åªè¦è£…å¤‡äº†æˆ–è€…æ‹¥æœ‰äº†ï¼Œå°±æ˜¾ç¤º
                        if (activeGene || ownedGene) {
                            // ä¼˜å…ˆä½¿ç”¨è£…å¤‡çš„å“è´¨ï¼Œå…¶æ¬¡æ˜¯æ‹¥æœ‰çš„
                            const displayGene = activeGene || ownedGene;
                            
                            let cls = 'gene-normal';
                            if (displayGene.quality === 'ç¨€æœ‰') cls = 'gene-rare';
                            else if (displayGene.quality === 'å²è¯—') cls = 'gene-epic';
                            else if (displayGene.quality === 'ç¥å…½') cls = 'gene-legend';
                            
                            const activeCls = activeSet.has(type) ? ' gene-active' : '';
                            // å¦‚æœæ˜¯æœ¬æ¬¡æ¯”èµ›æ–°é¢†æ‚Ÿçš„ï¼Œä¹Ÿæ ‡è®°ä¸€ä¸‹
                            const learnedCls = learnedSet.has(type) ? ' gene-just' : '';
                            
                            // è¿™é‡Œæ·»åŠ  stopPropagation é˜²æ­¢ç‚¹å‡»æŠ€èƒ½æ—¶è§¦å‘é©¬åŒ¹é€‰æ‹©
                            return `<span class="gene-tag ${cls}${activeCls}${learnedCls}" onclick="event.stopPropagation(); game.showSkillDetail('${type}')">${type}</span>`;
                        } else {
                            return `<span class="gene-tag gene-locked" onclick="event.stopPropagation(); game.showSkillDetail('${type}')">${type}</span>`;
                        }
                    }).join('');

                    
                    const isSelected = h.id === this.selectedHorseId;
                    const selectedClass = isSelected ? 'selected' : '';
                    
                    html += `
                        <div class="horse-card ${selectedClass}" onclick="game.selectHorse('${h.id}')">
                            <div class="card-skills">
                                <input class="horse-name-input" maxlength="12" value="${this.escapeHtml(h.name)}" onclick="event.stopPropagation()" onkeydown="event.stopPropagation(); if(event.key==='Enter'){ this.blur(); }" oninput="game.setHorseName('${h.id}', this.value)" />
                                <div class="gene-tags" onclick="event.stopPropagation()">${genesHtml2}</div>
                            </div>
                            <div class="card-info">
                                <div class="life">å¯¿å‘½: ${h.lifespan}/${h.maxLifespan}</div>
                                <div class="blood">ç¨€æœ‰ç­‰çº§: ${h.quality}</div>
                            <div class="blood">é€Ÿåº¦: ${Math.round(this.computeSpeedWithGenes(h.baseSpeed, previewActives, h.genes, false, { spriteSet: (h.spriteSet || SpriteSet.Horse), applyCodex: true }))}</div>
                            </div>
                            <div class="card-image">
                                <div class="idle-horse" data-sprite-set="${this.escapeHtml(h.spriteSet || SpriteSet.Horse)}" data-idle-horse="1"></div>
                            </div>
                        </div>
                    `;
                });

                html += `</div></div>`;
                infoPanel.innerHTML = html;
                this.startStableIdleAnim(infoPanel);
                const hintTrack = infoPanel.querySelector('#stable-hint-track');
                if (hintTrack) hintTrack.scrollLeft = hintTrack.scrollWidth;
                
                // æ¯”èµ›ä¸­æ¢å¤æ»šåŠ¨ä½ç½®
                const newContainer = infoPanel.querySelector('.stable-container');
                if (this.racing && newContainer && prevScrollLeft !== null) {
                    newContainer.scrollLeft = prevScrollLeft;
                }
                
                // æ»‘åŠ¨æ‰‹åŠ¿
                const container = infoPanel.querySelector('.stable-container');
                if (container) {
                    container.style.overflowX = this.racing ? 'hidden' : 'auto';
                    let startX = 0, deltaX = 0, touching = false;
                    const onStart = (x) => { startX = x; deltaX = 0; touching = true; };
                    const onMove = (x) => { if (touching) deltaX = x - startX; };
                    const onEnd = () => {
                        if (!touching) return;
                        touching = false;
                        if (this.racing) return;
                        if (Math.abs(deltaX) > 40) {
                            if (deltaX < 0) this.nextHorse(); else this.prevHorse();
                        }
                    };
                    container.addEventListener('touchstart', e => onStart(e.touches[0].clientX), {passive:true});
                    container.addEventListener('touchmove', e => onMove(e.touches[0].clientX), {passive:true});
                    container.addEventListener('touchend', onEnd);
                    container.addEventListener('mousedown', e => onStart(e.clientX));
                    container.addEventListener('mousemove', e => onMove(e.clientX));
                    container.addEventListener('mouseup', onEnd);
                    container.addEventListener('mouseleave', onEnd);
                }
                
                // æ»šåŠ¨ä½¿é€‰ä¸­é¡¹å±…ä¸­
                if (!this.racing) this.scrollSelectedIntoView();
            }

            openBreed() {
                document.getElementById('breed-panel').style.display = 'flex';
                document.getElementById('breed-result').innerText = '';
            }

            closeBreed() {
                document.getElementById('breed-panel').style.display = 'none';
            }

            confirmBreed() {
                // é©¬å©å®¹é‡é™åˆ¶
                const aliveCount = this.player.horses.filter(h => (h.lifespan == null ? true : h.lifespan > 0)).length;
                if (aliveCount >= this.stableCap) {
                    alert("é©¬å©å·²æ»¡ (ä¸Šé™5åŒ¹)ã€‚è¯·å…ˆæ¸…ç†å¯¿å‘½ä¸º0çš„é©¬æˆ–å¼ƒç½®åå†åŸ¹è‚²ã€‚");
                    return;
                }
                if (this.player.integral < 500) {
                    alert("ç§¯åˆ†ä¸è¶³ (éœ€è¦500)ï¼å…ˆå»æ¯”èµ›èµ¢ç‚¹åˆ†å§ã€‚");
                    return;
                }
                
                // ä½¿ç”¨å½“å‰é€‰ä¸­çš„é©¬ä½œä¸ºçˆ¶æœ¬
                const parent1 = this.player.horses.find(h => h.id === this.selectedHorseId);
                if (!parent1) {
                    alert("è¯·å…ˆé€‰æ‹©ä¸€åŒ¹é©¬ï¼");
                    return;
                }

                if (parent1.lifespan < 10) {
                    alert("å½“å‰é©¬åŒ¹å¯¿å‘½ä¸è¶³ 10 ç‚¹ï¼Œæ— æ³•è¿›è¡ŒåŸ¹è‚²ï¼");
                    return;
                }

                this.player.integral -= 500;
                parent1.lifespan -= 10; // æ‰£é™¤å¯¿å‘½
                
                const parent2 = generateAIHorse(999);
                const foal = BreedingSystem.breedHorse(parent1, parent2);
                this.player.horses.push(foal);
                
                // è‡ªåŠ¨é€‰ä¸­æ–°é©¬
                this.selectedHorseId = foal.id;
                
                document.getElementById('breed-result').innerText = `åŸ¹è‚²æˆåŠŸï¼è·å¾—æ–°é©¬ï¼š${foal.name}`;
                this.pushHint(`ğŸ‰ è·å¾—æ–°é©¬ï¼š${foal.name}`);
                this.updateUI();
            }

            openReforge() {
                const horse = this.player.horses.find(h => h.id === this.selectedHorseId);
                if (!horse || !horse.genes || horse.genes.length === 0) {
                    alert("è¯¥é©¬åŒ¹æ²¡æœ‰æŠ€èƒ½ï¼Œæ— æ³•æ´—ç»ƒï¼");
                    return;
                }
                
                document.getElementById('reforge-panel').style.display = 'flex';
                this.tempReforgeGenes = null;
                this.tempReforgeQuality = horse.quality;
                
                // æ¸²æŸ“å½“å‰æŠ€èƒ½
                const currentSlots = this.slotCountForHorse(horse);
                const currentLocked = Array.isArray(horse.lockedStartGenes) && horse.lockedStartGenes.length > 0
                    ? horse.lockedStartGenes.slice(0, currentSlots)
                    : this.pickStartGenes(horse.genes, currentSlots);
                this.renderReforgeSkillBox('current', currentLocked, currentLocked);
                this.renderReforgeSkillBox('new', null, null);
                
                // æŒ‰é’®çŠ¶æ€
                document.getElementById('btn-do-reforge').style.display = 'block';
                document.getElementById('btn-save-reforge').style.display = 'none';
                const discardBtn = document.getElementById('btn-discard-reforge');
                if (discardBtn) discardBtn.style.display = 'none';
            }

            closeReforge() {
                document.getElementById('reforge-panel').style.display = 'none';
                this.tempReforgeGenes = null;
                this.tempReforgeQuality = null;
            }

            renderReforgeGenes(genes, containerId, actives = []) {
                const id = String(containerId || '');
                if (id.includes('current')) this.renderReforgeSkillBox('current', genes, actives);
                else this.renderReforgeSkillBox('new', genes, actives);
            }

            doReforge() {
                const horse = this.player.horses.find(h => h.id === this.selectedHorseId);
                
                // æ¦‚ç‡æå‡ç¨€æœ‰ç­‰çº§ï¼šæ™®é€š->ä¸­çº§->é«˜çº§->ç¨€æœ‰
                const ladder = ['æ™®é€š','ä¸­çº§','é«˜çº§','ç¨€æœ‰'];
                let q = horse.quality;
                const idx = ladder.indexOf(q);
                if (idx !== -1 && idx < ladder.length - 1) {
                    if (Math.random() < 0.3) { // 30% å‡ä¸€çº§
                        q = ladder[idx + 1];
                    }
                }
                this.tempReforgeQuality = q;
                
                // æ ¹æ®æ–°ç­‰çº§çš„æ§½ä½ï¼Œç”Ÿæˆå…¨æ–°çš„æŠ€èƒ½ç»„åˆ
                // ä¿®æ”¹ï¼šæ´—ç»ƒåªèƒ½ä»å·²æ¿€æ´»çš„æŠ€èƒ½æ±  (horse.genes) ä¸­é€‰æ‹©ï¼Œä¸èƒ½å‡­ç©ºç”Ÿæˆæ–°æŠ€èƒ½
                // ä½†æ´—ç»ƒå¯ä»¥å°è¯•æå‡å·²æ‹¥æœ‰æŠ€èƒ½çš„ç¨€æœ‰åº¦ï¼ˆæˆ–è€…ä¿æŒåŸæ ·ï¼Œè¿™é‡Œå‡è®¾åªæ”¹å˜ç»„åˆï¼Œä¸æ”¹å˜æ± å­é‡Œçš„ç¨€æœ‰åº¦ï¼‰
                // éœ€æ±‚æ˜¯ï¼šåªèƒ½æ´—å‡ºå·²ç»æ¿€æ´»çš„æŠ€èƒ½ã€‚
                // é‚£ä¹ˆé€»è¾‘æ˜¯ï¼šä» horse.genes é‡ŒéšæœºæŒ‘ slots ä¸ªå‡ºæ¥ã€‚
                // å¦‚æœ horse.genes æ•°é‡ä¸å¤Ÿ slotsï¼Œåˆ™é‡å¤é€‰æˆ–è€…å¡«æ»¡ä¸ºæ­¢ã€‚
                
                const slots = (() => {
                    // è®¡ç®—æ–°ç¨€æœ‰åº¦å¯¹åº”çš„æ§½ä½æ•°
                    // å¦‚æœå‘ç”Ÿäº†çªç ´ï¼ˆç¨€æœ‰åº¦æå‡ï¼‰ï¼Œä¸”å½“å‰æ§½ä½å°‘äºæ–°ç¨€æœ‰åº¦çš„æ ‡å‡†æ§½ä½ï¼Œåˆ™å¢åŠ æ§½ä½
                    if (q !== horse.quality) {
                        const standardSlots = this.slotCountForHorse({ quality: q }); // ä¸ä¼  geneSlots è·å–æ ‡å‡†å€¼
                        if ((horse.geneSlots || 0) < standardSlots) {
                            return standardSlots;
                        }
                    }
                    return this.slotCountForHorse({ quality: q, geneSlots: horse.geneSlots });
                })();
                const pool = horse.genes || [];
                
                if (pool.length === 0) {
                    alert("å½“å‰é©¬åŒ¹æ²¡æœ‰å·²æ¿€æ´»çš„æŠ€èƒ½ï¼Œæ— æ³•æ´—ç»ƒï¼è¯·å…ˆå»æ¯”èµ›é¢†æ‚ŸæŠ€èƒ½ã€‚");
                    // æ¢å¤çŠ¶æ€
                    this.tempReforgeQuality = null;
                    return;
                }

                const newGenes = [];
                // ç®€å•çš„éšæœºæŠ½å–ï¼ˆå…è®¸é‡å¤é€‰ï¼Ÿé€šå¸¸ä¸å…è®¸ï¼Œé™¤éæ± å­å¤ªå°ï¼‰
                // å‡è®¾æ± å­ä¸å¤Ÿæ—¶ï¼Œåªèƒ½é€‰è¿™ä¹ˆå¤š
                
                // æ·±æ‹·è´æ± å­ä»¥ä¾›æŠ½å–
                let available = JSON.parse(JSON.stringify(pool));
                
                // å¦‚æœæ± å­æ¯”æ§½ä½å°ï¼Œç›´æ¥å…¨é€‰ï¼Œä¸å¤Ÿçš„éƒ¨åˆ†ç©ºç€ï¼ˆæˆ–è€…å…è®¸é‡å¤ï¼Ÿæ¸¸æˆé€šå¸¸ä¸å…è®¸é‡å¤è£…å¤‡åŒä¸€æŠ€èƒ½ï¼‰
                // è¿™é‡Œæˆ‘ä»¬é€»è¾‘æ˜¯ï¼šå¦‚æœæ± å­å°ï¼Œå°±å…¨ä¸Šã€‚
                // å¦‚æœæ± å­å¤§ï¼Œå°±éšæœºé€‰ã€‚
                
                // ä¸ºäº†å¢åŠ æ´—ç»ƒçš„æ„ä¹‰ï¼Œæˆ‘ä»¬å…è®¸åœ¨è¿™é‡Œâ€œé‡éšâ€æŠ€èƒ½çš„æ’åˆ—ç»„åˆ
                // è‡³äºç¨€æœ‰åº¦ï¼šåº”è¯¥ç»§æ‰¿æ± å­é‡Œçš„ç¨€æœ‰åº¦ï¼Œè¿˜æ˜¯å…è®¸æ´—ç»ƒæå‡ï¼Ÿ
                // ç”¨æˆ·è¯´â€œæ´—ç»ƒåªèƒ½æ´—å‡ºæŠ€èƒ½æ± é‡Œå·²ç»æ¿€æ´»çš„æŠ€èƒ½â€ï¼Œé€šå¸¸æš—ç¤ºåªæ˜¯æ”¹å˜â€œè£…å¤‡é…ç½®â€ã€‚
                // ä½†ä¹‹å‰çš„éœ€æ±‚æ˜¯â€œæ´—ç»ƒèƒ½å‡ºç¥å…½â€ï¼Œç°åœ¨æ—¢ç„¶é™åˆ¶äº†æ± å­ï¼Œé‚£ç¥å…½åªèƒ½æ˜¯æ± å­é‡Œæœ¬æ¥å°±æœ‰çš„ã€‚
                // æ‰€ä»¥è¿™é‡Œä¸¥æ ¼éµå¾ªï¼šåªä»æ± å­é‡Œæ‹¿ã€‚
                
                // ä¹±åº
                available.sort(() => 0.5 - Math.random());
                
                // å–å‰ slots ä¸ª
                for(let i=0; i<slots; i++) {
                    if (i < available.length) {
                        newGenes.push(available[i]);
                    }
                }
                
                this.tempReforgeGenes = newGenes;
                
                // æ¸²æŸ“æ–°æŠ€èƒ½
                this.renderReforgeSkillBox('new', this.tempReforgeGenes, this.tempReforgeGenes);
                
                // åˆ‡æ¢æŒ‰é’®
                document.getElementById('btn-do-reforge').style.display = 'none';
                document.getElementById('btn-save-reforge').style.display = 'block';
                const discardBtn = document.getElementById('btn-discard-reforge');
                if (discardBtn) discardBtn.style.display = 'block';
            }
            
            saveReforge() {
                if (!this.tempReforgeGenes) return;
                
                const horse = this.player.horses.find(h => h.id === this.selectedHorseId);
                horse.lockedStartGenes = this.tempReforgeGenes;
                if (this.tempReforgeQuality) {
                    horse.quality = this.tempReforgeQuality;
                    // åŒæ­¥ geneSlotsï¼šå¦‚æœæ–°ç¨€æœ‰åº¦æ”¯æŒæ›´å¤šæ§½ä½ï¼Œåˆ™æ‰©å……
                    const standardSlots = this.slotCountForHorse({ quality: horse.quality });
                    if (!horse.geneSlots || horse.geneSlots < standardSlots) {
                        horse.geneSlots = standardSlots;
                    }
                    
                    // ä¿®å¤ï¼šå‡çº§ç¨€æœ‰åº¦æ—¶ï¼Œå¿…é¡»åŒæ­¥æå‡åŸºç¡€é€Ÿåº¦ï¼Œå¦åˆ™æ— æ³•è·‘èµ¢åŒçº§ AI
                    const speedMap = {'æ™®é€š':55, 'ä¸­çº§':60, 'é«˜çº§':65, 'ç¨€æœ‰':70, 'ç¥å…½':75};
                    if (speedMap[horse.quality] > horse.baseSpeed) {
                        horse.baseSpeed = speedMap[horse.quality];
                    }
                }
                
                // å°†æ´—ç»ƒå‡ºçš„æ–°æŠ€èƒ½åˆå¹¶å…¥æŠ€èƒ½æ±  (å¯é€‰ï¼šå¦‚æœå¸Œæœ›æ´—ç»ƒä¹Ÿèƒ½æ‹“å……å›¾é‰´)
                // ä¿®æ”¹ï¼šåªæœ‰é¢†æ‚Ÿå¯ä»¥æ¿€æ´»æŠ€èƒ½æ± ï¼Œæ´—ç»ƒæŠ€èƒ½åªèƒ½æ›¿æ¢æ¯”èµ›ä¸­é»˜è®¤æŠ€èƒ½
                // å› æ­¤è¿™é‡Œä¸å†åˆå¹¶åˆ° horse.genes
                /* 
                if (horse.genes) {
                    this.tempReforgeGenes.forEach(newG => {
                        // ...
                    });
                }
                */
                
                this.ensureLockedStartGenes(horse);
                this.ensureLockedStartGenes(horse);
                alert("ä¿å­˜æˆåŠŸï¼");
                this.closeReforge();
                this.updateUI();
            }
            
            discardReforge() {
                // æ”¾å¼ƒæ´—ç»ƒï¼šæ¸…ç©ºé¢„è§ˆï¼Œæ¢å¤æŒ‰é’®
                this.tempReforgeGenes = null;
                this.tempReforgeQuality = null;
                this.renderReforgeSkillBox('new', null, null);
                document.getElementById('btn-do-reforge').style.display = 'block';
                document.getElementById('btn-save-reforge').style.display = 'none';
                const discardBtn = document.getElementById('btn-discard-reforge');
                if (discardBtn) discardBtn.style.display = 'none';
            }

            openTicketMenu() {
                const modal = document.getElementById('ticket-modal');
                const count = document.getElementById('ticket-modal-count');
                if (modal && count) {
                    count.innerText = this.player.ticketsNormal;
                    modal.style.display = 'flex';
                }
            }

            closeTicketMenu() {
                const modal = document.getElementById('ticket-modal');
                if (modal) modal.style.display = 'none';
            }

            buyTicketWithPoints() {
                if (this.player.integral >= 200) {
                    this.player.integral -= 200;
                    this.player.ticketsNormal += 1;
                    this.updateUI();
                    // æ›´æ–°å¼¹çª—å†…çš„æ•°é‡
                    const count = document.getElementById('ticket-modal-count');
                    if (count) count.innerText = this.player.ticketsNormal;
                    alert("è´­ä¹°æˆåŠŸï¼é—¨ç¥¨ +1 (æ¶ˆè€—200ç§¯åˆ†)");
                } else {
                    alert("ç§¯åˆ†ä¸è¶³ï¼éœ€è¦ 200 ç§¯åˆ†ã€‚");
                }
            }
            
            watchAdForTicket() {
                 // æ¨¡æ‹Ÿçœ‹å¹¿å‘Š 3ç§’ (Modalç‰ˆ)
                const btn = document.getElementById('btn-watch-ad-modal');
                if (!btn) return;
                
                const originalText = "ğŸ“º è§‚çœ‹å¹¿å‘Š (å…è´¹+5)";
                btn.disabled = true;
                btn.innerText = "ğŸ“º è§‚çœ‹ä¸­ (3s)...";
                
                setTimeout(() => {
                    this.player.ticketsNormal += 5;
                    this.updateUI();
                    
                    // æ›´æ–°å¼¹çª—å†…çš„æ•°é‡
                    const count = document.getElementById('ticket-modal-count');
                    if (count) count.innerText = this.player.ticketsNormal;
                    
                    alert("è§‚çœ‹å®Œæ¯•ï¼é—¨ç¥¨ +5");
                    btn.disabled = false;
                    btn.innerText = originalText;
                }, 3000);
            }

            watchAd() {
                // æ¨¡æ‹Ÿçœ‹å¹¿å‘Š 3ç§’
                const btn = document.getElementById('btn-watch-ad');
                const originalText = btn.innerText;
                btn.disabled = true;
                btn.innerText = "ğŸ“º è§‚çœ‹ä¸­ (3s)...";
                
                setTimeout(() => {
                    this.player.ticketsNormal += 5;
                    alert("è§‚çœ‹å®Œæ¯•ï¼é—¨ç¥¨ +5");
                    btn.disabled = false;
                    btn.innerText = originalText;
                    this.updateUI();
                }, 3000);
            }

            async startRace() {
                if (this.player.seasonRaces >= 8) {
                    alert("æœ¬èµ›å­£å·²ç»“æŸï¼ˆ8åœºï¼‰ï¼è¯·ç‚¹å‡»ä¸Šæ–¹ã€å‚åŠ é€‰ç§€ã€‘è¿›å…¥é€‰ç§€å¤§ä¼šå¼€å¯æ–°èµ›å­£ã€‚");
                    return;
                }

                if (this.player.ticketsNormal < 1) {
                    alert("é—¨ç¥¨ä¸è¶³ï¼è¯·è§‚çœ‹å¹¿å‘Šè·å–ã€‚");
                    return;
                }
                
                // ä½¿ç”¨å½“å‰é€‰ä¸­çš„é©¬å‚èµ›
                const myHorse = this.player.horses.find(h => h.id === this.selectedHorseId);
                
                if (myHorse.lifespan <= 0) {
                    alert("å½“å‰é€‰ä¸­çš„é©¬åŒ¹å¯¿å‘½å·²å°½ï¼è¯·é€‰æ‹©å…¶ä»–é©¬åŒ¹ã€‚");
                    return;
                }

                await this.ensureHorseRunFramesReady();
                await this.ensureBurstFramesReady();
                await this.ensureJifengFramesReady();
                await this.ensureLanyingFramesReady();
                await this.ensureLieyanFramesReady();

                // åˆ‡æ¢åˆ°æ¯”èµ›æ¨¡å¼
                document.getElementById('game-container').classList.add('racing-mode');

                this.player.ticketsNormal--;
                myHorse.lifespan--;
                this.updateUI();

                this.currentRaceHorseId = myHorse.id;

                document.getElementById('lobby-panel').style.display = 'none';
                document.getElementById('status-label').style.display = 'none';

                // ç”Ÿæˆé©¬åŒ¹ï¼šä¸€å…±3ç»„ï¼Œæ¯ç»„6åŒ¹ï¼Œå…±18åŒ¹
                this.allGroups = [];
                this.horses = []; // ä»…å­˜å‚¨å½“å‰è§†è§‰å±•ç¤ºç»„ï¼ˆç©å®¶æ‰€åœ¨ç»„ï¼‰
                
                // 1. å‡†å¤‡æ‰€æœ‰å‚èµ›é©¬åŒ¹ (1 Player + 17 AI)
                const allParticipants = [myHorse];
                for(let i=0; i<17; i++) {
                    allParticipants.push(generateAIHorse(i, this.player, myHorse));
                }
                
                // 2. éšæœºæ‰“ä¹±å¹¶åˆ†ç»„
                // Fisher-Yates Shuffle
                for (let i = allParticipants.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allParticipants[i], allParticipants[j]] = [allParticipants[j], allParticipants[i]];
                }
                
                // åˆ†3ç»„ï¼Œæ¯ç»„6åŒ¹
                const groupNames = ['A', 'B', 'C'];
                for(let g=0; g<3; g++) {
                    const groupHorses = allParticipants.slice(g*6, (g+1)*6);
                    this.allGroups.push({
                        name: groupNames[g] + ' ç»„',
                        data: groupHorses
                    });
                }
                
                // 3. æ‰¾åˆ°ç©å®¶æ‰€åœ¨çš„ç»„ï¼Œä½œä¸ºè§†è§‰å±•ç¤ºç»„
                let playerGroupIndex = this.allGroups.findIndex(g => g.data.some(h => h.id === myHorse.id));
                const visualGroupData = this.allGroups[playerGroupIndex].data;
                this.playerGroupIndex = playerGroupIndex;
                
                // æ˜¾ç¤ºåˆ†ç»„ä¿¡æ¯æç¤º
                const groupMsg = document.createElement('div');
                groupMsg.style.cssText = 'position:absolute; top:60px; left:50%; transform:translateX(-50%); color:#f1c40f; font-weight:bold; font-size:24px; text-shadow:0 0 5px #000; z-index:100; pointer-events:none; opacity:0; transition:opacity 0.5s;';
                groupMsg.innerText = `å½“å‰è¿›è¡Œ: ${this.allGroups[playerGroupIndex].name}`;
                document.getElementById('game-container').appendChild(groupMsg);
                
                // åŠ¨ç”»æ˜¾ç¤º
                requestAnimationFrame(() => groupMsg.style.opacity = '1');
                setTimeout(() => {
                    groupMsg.style.opacity = '0';
                    setTimeout(() => groupMsg.remove(), 500);
                }, 2000);
                
                const track = document.getElementById('track-layer'); // ä¿®å¤ï¼šé‡æ–°å®šä¹‰ track å˜é‡
                
                // æ·»åŠ è·‘é“åˆ†éš”çº¿ (æ¨ªå‘)
                track.innerHTML = '';
                // è·‘é“æ€»é«˜åº¦çº¦ 667 - 250 = 417px
                // 5æ¡è·‘é“ï¼Œæ¯æ¡çº¦ 80px
                
                // åˆå§‹åŒ–é©¬åŒ¹æ¯”èµ›æ•°æ® (ä»…åˆå§‹åŒ–ç©å®¶æ‰€åœ¨ç»„)
                visualGroupData.forEach((data, i) => {
                    // å¦‚æœæ˜¯ AI é©¬ï¼ˆidä»¥ai_å¼€å¤´ï¼‰ï¼Œéœ€è¦æ ¹æ®å½“å‰èµ›å­£åœºæ¬¡ï¼Œé€‚å½“åŠ å¼ºä¸€ç‚¹ï¼ˆæ¨¡æ‹Ÿ AI ä¹Ÿåœ¨æˆé•¿ï¼‰
                    // å·²ç»åœ¨ generateAIHorse é‡Œåšäº†ä¸€éƒ¨åˆ†ï¼Œè¿™é‡Œç¡®ä¿ AI ä¹Ÿèƒ½å¸¦ä¸ŠæŠ€èƒ½
                    if (data.id.startsWith('ai_')) {
                        // AI è‡ªåŠ¨é…æŠ€èƒ½ï¼šæ ¹æ®ç©å®¶å½“å‰é©¬åŒ¹çš„æŠ€èƒ½æ•°é‡åŠ¨æ€è°ƒæ•´
                        // ç¡®ä¿ AI æŠ€èƒ½æ•°é‡ä¸è¶…è¿‡ç©å®¶
                        const slots = this.slotCountForHorse(data);
                        const playerSkillCount = myHorse.genes ? myHorse.genes.length : 0;
                        
                        if (!data.genes || data.genes.length === 0) {
                            const pool = Object.values(GeneType).map(t => ({type:t, quality:'æ™®é€š'}));
                            // é™åˆ¶ AI æŠ€èƒ½æ•°ï¼šç›´æ¥å¯¹é½ç©å®¶æŠ€èƒ½æ•°ï¼Œä¸”ä¸èƒ½è¶…è¿‡è‡ªèº«æ§½ä½
                            let count = Math.min(playerSkillCount, slots);
                            data.genes = this.pickStartGenes(pool, count);
                        }
                    }

                    this.ensureLockedStartGenes(data);
                    const el = document.createElement('div');
                    el.className = 'horse';
                    el.dataset.spriteSet = data.spriteSet || SpriteSet.Horse;
                    const raceScale = RaceSpriteScale[el.dataset.spriteSet] || 1;
                    el.style.setProperty('--race-scale', String(raceScale));
                    const startFrame = ((i * 4) % 20) + 1;
                    el.style.backgroundImage = this.horseRunFrame(startFrame, data.spriteSet);
                    // è°ƒæ•´èµ›é©¬å‚ç›´ä½ç½®ï¼šå¢åŠ é—´è·ï¼Œæ•´ä½“ä¸‹ç§»
                    // æ”¹ä¸º6åŒ¹é©¬ï¼Œé—´è·è°ƒæ•´ä¸º 90pxï¼Œèµ·å§‹ 40px
                    const baseTop = i * 90 + 40;
                    el.style.top = baseTop + 'px'; 
                    el.style.left = '50px';
                    track.appendChild(el);

                    const isMythicalLegendary = data && data.quality === 'ç¥å…½' && (data.spriteSet || SpriteSet.Horse) === SpriteSet.Legendary;
                    let jifengEl = null;
                    if (isMythicalLegendary) {
                        const fx = document.createElement('div');
                        fx.className = 'horse-jifeng';
                        fx.style.top = Math.round((baseTop + 74) - (170 / 2)) + 'px';
                        fx.style.left = '-9999px';
                        fx.style.setProperty('--race-scale', String(raceScale));
                        const list = this.jifengFrameCss && this.jifengFrameCss.jifeng;
                        if (Array.isArray(list) && list[1]) fx.style.backgroundImage = list[1];
                        track.appendChild(fx);
                        jifengEl = fx;
                    }

                    const isMythicalLegendary2 = data && data.quality === 'ç¥å…½' && (data.spriteSet || SpriteSet.Horse) === SpriteSet.Legendary2;
                    let lanyingEl = null;
                    if (isMythicalLegendary2) {
                        const fx = document.createElement('div');
                        fx.className = 'horse-lanying';
                        fx.style.top = Math.round((baseTop + 74) - (170 / 2)) + 'px';
                        fx.style.left = '-9999px';
                        fx.style.setProperty('--race-scale', String(raceScale));
                        const list = this.lanyingFrameCss && this.lanyingFrameCss.lanying;
                        if (Array.isArray(list) && list[1]) fx.style.backgroundImage = list[1];
                        track.appendChild(fx);
                        lanyingEl = fx;
                    }

                    const isMythicalLegendary3 = data && data.quality === 'ç¥å…½' && (data.spriteSet || SpriteSet.Horse) === SpriteSet.Legendary3;
                    let lieyanEl = null;
                    if (isMythicalLegendary3) {
                        const fx = document.createElement('div');
                        fx.className = 'horse-lieyan';
                        fx.style.top = Math.round((baseTop + 74) - (175 / 2)) + 'px';
                        fx.style.left = '-9999px';
                        fx.style.setProperty('--race-scale', String(raceScale));
                        const list = this.lieyanFrameCss && this.lieyanFrameCss.lieyan;
                        if (Array.isArray(list) && list[1]) fx.style.backgroundImage = list[1];
                        track.appendChild(fx);
                        lieyanEl = fx;
                    }
                     
                     // æ¯”èµ›åˆå§‹æŠ€èƒ½ï¼šæ ¹æ®ç¨€æœ‰ç­‰çº§çš„æ§½ä½æ•°ï¼Œä»æŠ€èƒ½æ± é”å®š
                     // æ¸…ç©ºå½“å±€çš„â€œæ–°é¢†æ‚Ÿâ€æ ‡è®°
                     data.learnedThisRace = [];
                     const slots = this.slotCountForHorse(data);
                     const activeGenes = (data.lockedStartGenes || []).slice(0, slots);
                     data.activeGenes = activeGenes;
                     const isPlayerOwned = Array.isArray(this.player.horses) && this.player.horses.some(h => h && h.id === data.id);

                     this.horses.push({ 
                         el, 
                         nameTag: null, 
                         data, // å¼•ç”¨åŸå§‹æ•°æ® (ç”¨äºèµ›åä¿å­˜)
                         activeGenes, // å½“å±€ç”Ÿæ•ˆçš„æŠ€èƒ½ (6ä¸ªåŸºç¡€ + 1ä¸ªé¢†æ‚Ÿ)
                         distance: 0, 
                         // ä½¿ç”¨ activeGenes è®¡ç®—åˆå§‹é€Ÿåº¦ï¼Œä¼ å…¥å®Œæ•´æŠ€èƒ½æ± ä»¥è®¡ç®—ç¨€æœ‰åŠ æˆ
                        speed: this.computeSpeedWithGenes(data.baseSpeed, activeGenes, data.genes, true, { spriteSet: (data.spriteSet || SpriteSet.Horse), applyCodex: isPlayerOwned }), 
                         frameIndex: startFrame,
                        frameTimer: (i % 4),
                        baseTop: baseTop,
                        _learned: false, 
                        boostTimer: 0,
                        afterimageTimer: 0,
                        burstCooldown: 0,
                        jifengEl,
                        jifengFrameIndex: 1,
                        jifengFrameTimer: (i % 4),
                        lanyingEl,
                        lanyingFrameIndex: 1,
                        lanyingFrameTimer: (i % 4),
                        lieyanEl,
                        lieyanFrameIndex: 1,
                        lieyanFrameTimer: (i % 4),
                        ghostCooldown: 0,
                        _prevSpeed: null,
                        debuffTimer: 0,
                        raceScale
                     });
                 });

                // ç”Ÿæˆåç‰Œ
                this.horses.forEach(h => {
                     this.createNameTag(h);
                });

                // é‡ç½®è·‘é“ä½ç½®
                track.style.left = '0px'; // æ¨ªå‘é‡ç½®
                track.style.top = '0px';

                this.racing = true;
                requestAnimationFrame(this.loop.bind(this));
            }

            spawnGhost(h, intensity = 1) {
                const track = document.getElementById('track-layer');
                const ghost = document.createElement('div');
                ghost.className = 'horse-ghost';
                ghost.style.top = h.baseTop + 'px';
                ghost.style.left = (Math.round(50 + h.distance) - 20) + 'px';
                ghost.style.backgroundImage = h.el.style.backgroundImage;
                ghost.dataset.spriteSet = h.data?.spriteSet || SpriteSet.Horse;
                const raceScale = h.raceScale || RaceSpriteScale[ghost.dataset.spriteSet] || 1;
                ghost.style.setProperty('--race-scale', String(raceScale));
                const baseOpacity = 0.26 * Math.max(0.4, Math.min(1.6, intensity));
                track.appendChild(ghost);
                let op = baseOpacity, dx = 0;
                const anim = () => {
                    dx += 1.5;
                    op -= 0.04;
                    ghost.style.transform = `translateZ(0) scaleX(-1) scale(${raceScale}) translateX(-${dx}px)`;
                    ghost.style.opacity = String(op);
                    if (op > 0) requestAnimationFrame(anim);
                    else if (ghost.parentNode) ghost.parentNode.removeChild(ghost);
                };
                requestAnimationFrame(anim);
            }

            spawnBurst(h, intensity = 1) {
                const list = this.burstFrameCss && this.burstFrameCss.chixiao;
                const imgs = this.burstImages && this.burstImages.chixiao;
                if (!Array.isArray(list) || list.length < 2) return;

                const track = document.getElementById('track-layer');
                const burst = document.createElement('div');
                burst.className = 'horse-burst';
                burst.style.top = (h.baseTop - 20) + 'px';
                burst.style.left = (Math.round(50 + h.distance) - 70) + 'px';
                burst.style.setProperty('--race-scale', String(h.raceScale || 1));
                burst.style.backgroundImage = list[1];
                track.appendChild(burst);

                let op = 0.9 * Math.max(0.6, Math.min(1.4, intensity));
                let frame = 1;
                let tick = 0;
                let dx = 0;
                const anim = () => {
                    tick++;
                    dx += 1.8;
                    op -= 0.06;
                    if (tick % 2 === 0) {
                        const next = frame >= 3 ? 3 : (frame + 1);
                        const img = imgs && imgs[next];
                        if (img && img.complete && img.naturalWidth > 0) {
                            frame = next;
                            burst.style.backgroundImage = list[frame];
                        }
                    }
                    burst.style.opacity = String(Math.max(0, op));
                    burst.style.transform = `translateZ(0) scaleX(-1) scale(${h.raceScale || 1}) translateX(-${dx}px)`;
                    if (op > 0) requestAnimationFrame(anim);
                    else if (burst.parentNode) burst.parentNode.removeChild(burst);
                };
                requestAnimationFrame(anim);
            }

            loop() {
                if (!this.racing) return;

                let finishedCount = 0;
                let playerHorse = this.horses[0];
                const uiLayer = document.getElementById('ui-layer');
                
                this.horses.forEach(h => {
                    const prevSpeed = h._prevSpeed ?? h.speed;
                    const prevDist = h.distance;

                    if (h.jifengEl) {
                        const anchorX = 50 + h.distance + 60;
                        const anchorY = h.baseTop + 74;
                        h.jifengEl.style.left = Math.round(anchorX - (170 / 2)) + 'px';
                        h.jifengEl.style.top = Math.round(anchorY - (170 / 2)) + 'px';
                        h.jifengFrameTimer++;
                        if (h.jifengFrameTimer > 2) {
                            const frameCount = Math.max(1, ((this.jifengFrameCss && this.jifengFrameCss.jifeng) ? (this.jifengFrameCss.jifeng.length - 1) : 1));
                            const next = (h.jifengFrameIndex >= frameCount ? 1 : (h.jifengFrameIndex + 1));
                            const imgs = this.jifengImages && this.jifengImages.jifeng;
                            const list = this.jifengFrameCss && this.jifengFrameCss.jifeng;
                            const img = imgs && imgs[next];
                            if (img && img.complete && img.naturalWidth > 0 && list && list[next]) {
                                h.jifengFrameIndex = next;
                                h.jifengEl.style.backgroundImage = list[next];
                            }
                            h.jifengFrameTimer = 0;
                        }
                    }

                    if (h.lanyingEl) {
                        const anchorX = 50 + h.distance + 60;
                        const anchorY = h.baseTop + 74;
                        h.lanyingEl.style.left = Math.round(anchorX - (170 / 2)) + 'px';
                        h.lanyingEl.style.top = Math.round(anchorY - (170 / 2)) + 'px';
                        h.lanyingFrameTimer++;
                        if (h.lanyingFrameTimer > 2) {
                            const frameCount = Math.max(1, ((this.lanyingFrameCss && this.lanyingFrameCss.lanying) ? (this.lanyingFrameCss.lanying.length - 1) : 1));
                            const next = (h.lanyingFrameIndex >= frameCount ? 1 : (h.lanyingFrameIndex + 1));
                            const imgs = this.lanyingImages && this.lanyingImages.lanying;
                            const list = this.lanyingFrameCss && this.lanyingFrameCss.lanying;
                            const img = imgs && imgs[next];
                            if (img && img.complete && img.naturalWidth > 0 && list && list[next]) {
                                h.lanyingFrameIndex = next;
                                h.lanyingEl.style.backgroundImage = list[next];
                            }
                            h.lanyingFrameTimer = 0;
                        }
                    }

                    if (h.lieyanEl) {
                        const anchorX = 50 + h.distance + 60;
                        const anchorY = h.baseTop + 74;
                        h.lieyanEl.style.left = Math.round(anchorX - (175 / 2)) + 'px';
                        h.lieyanEl.style.top = Math.round(anchorY - (175 / 2)) + 'px';
                        h.lieyanFrameTimer++;
                        if (h.lieyanFrameTimer > 2) {
                            const frameCount = Math.max(1, ((this.lieyanFrameCss && this.lieyanFrameCss.lieyan) ? (this.lieyanFrameCss.lieyan.length - 1) : 1));
                            const next = (h.lieyanFrameIndex >= frameCount ? 1 : (h.lieyanFrameIndex + 1));
                            const imgs = this.lieyanImages && this.lieyanImages.lieyan;
                            const list = this.lieyanFrameCss && this.lieyanFrameCss.lieyan;
                            const img = imgs && imgs[next];
                            if (img && img.complete && img.naturalWidth > 0 && list && list[next]) {
                                h.lieyanFrameIndex = next;
                                h.lieyanEl.style.backgroundImage = list[next];
                            }
                            h.lieyanFrameTimer = 0;
                        }
                    }

                    // æ›´æ–°åŠ¨ç”»å¸§
                    h.frameTimer++;
                    if (h.frameTimer > 3) { 
                        const nextFrame = (h.frameIndex >= 20 ? 1 : (h.frameIndex + 1));
                        const spriteSetKey = (h.data && h.data.spriteSet) ? h.data.spriteSet : SpriteSet.Horse;
                        const key = (spriteSetKey && this.horseRunFrameCss && this.horseRunFrameCss[spriteSetKey]) ? spriteSetKey : SpriteSet.Horse;
                        const img = this.horseRunImages && this.horseRunImages[key] && this.horseRunImages[key][nextFrame];
                        if (img && img.complete && img.naturalWidth > 0) {
                            h.frameIndex = nextFrame;
                            h.el.style.backgroundImage = this.horseRunFrameCss[key][nextFrame];
                        }
                        h.frameTimer = 0;
                    }

                    // å³ä½¿å·²ç»åˆ°è¾¾ç»ˆç‚¹ï¼Œä¹Ÿè¦ç»§ç»­æ’­æ”¾åŠ¨ç”»ï¼Œç›´åˆ°æ¯”èµ›å½»åº•ç»“æŸ
                    if (h.distance < 2000) { 
                        h.distance += h.speed * 0.05; 
                        h.el.style.left = Math.round(50 + h.distance) + 'px'; // æ¨ªå‘ç§»åŠ¨
                    } else {
                        // åˆ°è¾¾ç»ˆç‚¹åï¼Œå¯ä»¥ç»§ç»­è·‘ä¸€æ®µï¼Œæˆ–è€…ä¿æŒåŸåœ°è·‘åŠ¨åŠ¨ç”»
                        finishedCount++;
                    }

                    if (h.boostTimer && h.boostTimer > 0) {
                        h.boostTimer--;
                        h.afterimageTimer = Math.max(h.afterimageTimer || 0, 18);
                    }

                    const accelUp = h.speed > prevSpeed * 1.015;
                    if (accelUp) {
                        h.afterimageTimer = Math.max(h.afterimageTimer || 0, 22);
                    }
                    h._prevSpeed = h.speed;

                    if (h.burstCooldown && h.burstCooldown > 0) h.burstCooldown--;
                    const q = h.data && h.data.quality;
                    const isRarePlus = q === 'ç¨€æœ‰' || q === 'å²è¯—' || q === 'ç¥å…½';
                    if (isRarePlus && h.distance < 2000 && h.burstCooldown <= 0 && (h.boostTimer > 0 || accelUp)) {
                        const intensity = 1 + (h.boostTimer ? Math.min(0.6, h.boostTimer / 100) : 0);
                        this.spawnBurst(h, intensity);
                        h.burstCooldown = 10;
                    }

                    if (h.afterimageTimer && h.afterimageTimer > 0) {
                        h.afterimageTimer--;
                        h.ghostCooldown = Math.max(0, (h.ghostCooldown || 0) - 1);
                        if (h.ghostCooldown <= 0 && h.distance < 2000 && (h.distance - prevDist) > 0) {
                            const intensity = Math.min(1.6, 0.8 + (h.afterimageTimer / 22));
                            this.spawnGhost(h, intensity);
                            h.ghostCooldown = 3;
                        }
                    } else {
                        h.ghostCooldown = Math.max(0, (h.ghostCooldown || 0) - 1);
                    }

                    // èµ›ä¸­é¢†æ‚Ÿé€»è¾‘ï¼šæ‰€æœ‰é©¬åŒ¹éƒ½æœ‰æœºä¼š
                    if (!h._learned && h.distance > 600) {
                        h._learned = true;
                        
                        // ç©å®¶å¿…è§¦å‘ï¼ŒAI 30% æ¦‚ç‡è§¦å‘
                        const isPlayer = (h === playerHorse);
                        const shouldTrigger = isPlayer || (Math.random() < 0.3);

                        if (shouldTrigger) {
                             // è®¡ç®—å¯é¢†æ‚Ÿçš„éé‡å¤æŠ€èƒ½ OR å¯å‡çº§çš„ç¨€æœ‰æŠ€èƒ½
                            const existing = Array.isArray(h.data.genes) ? h.data.genes : [];
                            const allTypes = Object.values(GeneType);
                            
                            // åŠ¨æ€æ¦‚ç‡ï¼šç¨€æœ‰åº¦è¶Šé«˜ï¼Œé¢†æ‚Ÿç¨€æœ‰æŠ€èƒ½æ¦‚ç‡è¶Šé«˜
                            let rareProb = 0.1; // é»˜è®¤æ™®é€šé©¬ 10%
                            if (h.data.quality === 'ä¸­çº§') rareProb = 0.15;
                            else if (h.data.quality === 'é«˜çº§') rareProb = 0.2;
                            else if (h.data.quality === 'ç¨€æœ‰') rareProb = 0.3;
                            else if (h.data.quality === 'ç¥å…½') rareProb = 0.5;
                            
                            const isRare = Math.random() < rareProb; 
                            
                            // å€™é€‰åˆ—è¡¨ (å…¨æŠ€èƒ½æ± )
                            const candidates = allTypes.filter(t => {
                                // æ£€æŸ¥å·²æ‹¥æœ‰çš„æœ€é«˜ç­‰çº§ (åŒ…æ‹¬å½“å‰æºå¸¦ activeGenes å’Œä»“åº“ data.genes)
                                const activeG = h.activeGenes.find(g => g.type === t);
                                const permG = (h.data.genes || []).find(g => g.type === t);
                                
                                const qMap = {'æ™®é€š':0, 'ä¸­çº§':1, 'é«˜çº§':2, 'ç¨€æœ‰':3, 'å²è¯—':4, 'ç¥å…½':5};
                                const newQVal = qMap[isRare ? 'ç¨€æœ‰' : 'æ™®é€š'];
                                
                                let maxOwnedVal = -1;
                                if (activeG) maxOwnedVal = Math.max(maxOwnedVal, qMap[activeG.quality] || 0);
                                if (permG) maxOwnedVal = Math.max(maxOwnedVal, qMap[permG.quality] || 0);
                                
                                // å¦‚æœå·²æ‹¥æœ‰çš„ç­‰çº§ >= æ–°é¢†æ‚Ÿçš„ç­‰çº§ï¼Œåˆ™ä¸å†é¢†æ‚Ÿ
                                if (maxOwnedVal >= newQVal) return false;
                                
                                return true;
                            });

                            // åªè¦æ²¡å­¦è¿‡ï¼Œå°±èƒ½å­¦
                            if (candidates.length > 0) {
                                let type = null;
                                let isUpgrade = false;
                                
                                type = candidates[Math.floor(Math.random() * candidates.length)];
                                const exist = h.activeGenes.find(g => g.type === type);
                                if (exist) isUpgrade = true;

                                if (type) {
                                    const quality = isRare ? 'ç¨€æœ‰' : 'æ™®é€š';
                                    const newGene = { type, quality };
                                    const slots = this.slotCountForHorse(h.data);
                                    if (isUpgrade) {
                                        const upgradeIdx = h.activeGenes.findIndex(g => g.type === type);
                                        if (upgradeIdx !== -1) h.activeGenes[upgradeIdx] = newGene;
                                        if (Array.isArray(h.data.lockedStartGenes)) {
                                            const lIdx = h.data.lockedStartGenes.findIndex(g => g.type === type);
                                            if (lIdx !== -1) h.data.lockedStartGenes[lIdx] = newGene;
                                        }
                                    } else {
                                        const limit = slots + 1; // é€‰ä¸­æŠ€èƒ½ + 1ä¸ªæ–°é¢†æ‚Ÿ
                                        const existsActive = h.activeGenes.some(g => g.type === type);
                                        if (!existsActive && h.activeGenes.length < limit) h.activeGenes.push(newGene);
                                    }
                                    
                                    // åŒæ—¶ä¹Ÿå†™å…¥ data.genes (æ°¸ä¹…ä¿å­˜ï¼Œæ»¡è¶³æ”¶é›†éœ€æ±‚)
                                    // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦å†æ¬¡æ£€æŸ¥ data.genes é‡Œæ˜¯å¦å·²æœ‰ï¼Œå› ä¸º activeGenes æ˜¯å­é›†
                                    if (!h.data.genes) h.data.genes = [];
                                    const permIdx = h.data.genes.findIndex(g => g.type === type);
                                    if (permIdx !== -1) {
                                        // å¦‚æœæ°¸ä¹…æ± é‡Œå·²æœ‰ï¼Œçœ‹æ˜¯å¦éœ€è¦å‡çº§
                                        if (h.data.genes[permIdx].quality === 'æ™®é€š' && isRare) {
                                            h.data.genes[permIdx] = newGene;
                                        }
                                    } else {
                                        // æ°¸ä¹…æ± é‡Œæ²¡æœ‰ï¼Œç›´æ¥æ·»åŠ 
                                        h.data.genes.push(newGene);
                                    }
                                    // åŒæ­¥å½“å±€æ¿€æ´»åˆ—è¡¨åˆ°æ•°æ®å¯¹è±¡ï¼Œä¾›æŠ€èƒ½æ± é«˜äº®
                                    h.data.activeGenes = h.activeGenes;
                                    // è®°å½•æœ¬å±€æ–°é¢†æ‚Ÿçš„æŠ€èƒ½ï¼Œç”¨äºæŠ€èƒ½æ± çº¢æ¡†é«˜äº®
                                    if (!h.data.learnedThisRace) h.data.learnedThisRace = [];
                                    if (!h.data.learnedThisRace.includes(type)) h.data.learnedThisRace.push(type);
                                    
                                    // é£˜å­—æ•ˆæœ
                                    const float = document.createElement('div');
                                    float.innerText = `ğŸ’¡ é¡¿æ‚Ÿ: ${type}${isRare?'(ç¨€æœ‰)':''}!`;
                                float.style.position = 'absolute';
                                // ä¿®æ­£åæ ‡è®¡ç®—
                                const cameraOffset = 150 - (50 + playerHorse.distance);
                                const nameLeft = (50 + h.distance) + cameraOffset;
                                const nameTop = 250 + h.baseTop + 20;

                                float.style.left = (nameLeft + 20) + 'px';
                                float.style.top = nameTop + 'px';
                                float.style.color = isRare ? '#e74c3c' : '#f1c40f'; // ç¨€æœ‰ç”¨çº¢è‰²
                                float.style.fontWeight = 'bold';
                                float.style.textShadow = '1px 1px 2px #000';
                                float.style.zIndex = '200';
                                float.style.whiteSpace = 'nowrap';
                                uiLayer.appendChild(float);
                                
                                // åŠ¨ç”»ä¸Šé£˜æ·¡å‡º
                            let op = 1, y = 0;
                            const anim = () => {
                                y += 1.5;
                                op -= 0.02;
                                float.style.transform = `translateY(-${y}px)`;
                                float.style.opacity = String(op);
                                    if (op > 0) requestAnimationFrame(anim);
                                    else if (float.parentNode) {
                                        float.parentNode.removeChild(float);
                                        if (window.game) window.game._pendingRaceUiRefresh = true;
                                    }
                            };
                            requestAnimationFrame(anim);
                                
                                // åˆ·æ–°åç‰Œ
                                if (h.nameTag) {
                                    let geneHtml = '';
                                    if (h.activeGenes && h.activeGenes.length > 0) {
                                        geneHtml = h.activeGenes.map(g => 
                                            `<span class="mini-gene-tag" style="background:${g.quality==='æ™®é€š'?'#bdc3c7':'#f1c40f'}; color:#000;">${g.type}</span>`
                                        ).join('');
                                    }
                                    if (h.data && h.data.id === this.selectedHorseId) h.nameTag.classList.add('is-player');
                                    else h.nameTag.classList.remove('is-player');
                                    h.nameTag.innerHTML = `<div class="name-row">${this.escapeHtml(this.truncateRaceName(h.data.name))}</div><div class="skill-row">${geneHtml}</div>`;
                                }
                                
                                // é¢†æ‚Ÿåç¨å¾®åŠ é€Ÿ
                                h.speed *= 1.05;
                                h.boostTimer = 60;
                            }
                        }
                    }
                }

                });

                const leader = this.horses.reduce((prev, curr) => (curr.distance > prev.distance) ? curr : prev, this.horses[0]);
                const cameraX = Math.max(0, 50 + leader.distance - 200);
                const trackLayer = document.getElementById('track-layer');
                trackLayer.style.transform = `translateX(${-cameraX}px)`;

                const trackContainer = document.getElementById('track-container');
                const trackContainerTop = trackContainer ? trackContainer.offsetTop : 0;
                const horseLeftBase = 50;
                const horseWidth = 120;
                this.horses.forEach(h => {
                    if (!h.nameTag) return;
                    const nameLeft = horseLeftBase + h.distance - cameraX + (horseWidth / 2);
                    const nameTop = trackContainerTop + h.baseTop;
                    h.nameTag.style.left = nameLeft + 'px';
                    h.nameTag.style.top = nameTop + 'px';
                    h.nameTag.style.transform = 'translate(-50%, -100%)';
                    if (h.data && h.data.id === this.selectedHorseId) h.nameTag.classList.add('is-player');
                    else h.nameTag.classList.remove('is-player');
                });

                // é•œå¤´è·Ÿéšé€»è¾‘ (å·²æ•´åˆåˆ°ä¸Šé¢å¾ªç¯ä¸­)
                // const targetX = 150 - playerHorse.distance;
                // const trackLayer = document.getElementById('track-layer');
                // trackLayer.style.transform = `translateX(${-playerHorse.distance}px)`;
                
                if (finishedCount >= this.horses.length) {
                    this.racing = false;
                    this.endRace();
                } else {
                    requestAnimationFrame(this.loop.bind(this));
                }
            }

            endRace() {
                // 1. ç»“ç®—å½“å‰è§†è§‰ç»„ (Player Group)
                this.horses.sort((a, b) => b.speed - a.speed);
                const visualWinner = this.horses[0];
                const raceHorseId = this.currentRaceHorseId || this.selectedHorseId;
                const myHorseRankInGroup = this.horses.findIndex(h => h.data.id === raceHorseId) + 1;
                
                // 2. æ¨¡æ‹Ÿå…¶ä»–ç»„çš„æ¯”èµ›ç»“æœ
                // æˆ‘ä»¬ä¸éœ€è¦çœŸçš„è·‘ï¼Œåªéœ€è¦æ ¹æ®å±æ€§è®¡ç®—ä¸€ä¸ªâ€œæ¨¡æ‹Ÿé€Ÿåº¦â€å¹¶æ’åº
                const allGroupResults = [];
                
                this.allGroups.forEach((group, gIdx) => {
                    let groupRankings = [];
                    if (gIdx === this.playerGroupIndex) {
                        // ç©å®¶ç»„ä½¿ç”¨å®é™…è·‘å®Œçš„ç»“æœ
                        groupRankings = this.horses.map(h => h.data);
                    } else {
                        // å…¶ä»–ç»„æ¨¡æ‹Ÿï¼šè®¡ç®—é€Ÿåº¦å¹¶æ’åº
                        // ç®€å•æ¨¡æ‹Ÿé€Ÿåº¦ï¼šbaseSpeed + æŠ€èƒ½åŠ æˆ
                        groupRankings = group.data.map(h => {
                            // ä¸´æ—¶è®¡ç®—ä¸€ä¸ªé€Ÿåº¦
                            const active = (h.lockedStartGenes||[]).slice(0, this.slotCountForHorse(h));
                            const speed = this.computeSpeedWithGenes(h.baseSpeed, active, h.genes, false);
                            return { horse: h, speed: speed };
                        }).sort((a,b) => b.speed - a.speed).map(o => o.horse);
                    }
                    allGroupResults.push({ name: group.name, rankings: groupRankings });
                });
                
                // 3. è®°å½•æ•°æ®å’Œå‘æ”¾å¥–åŠ± (ä»…åŸºäºç©å®¶åœ¨è‡ªå·±ç»„çš„æ’å)
                this.player.seasonRaces = (this.player.seasonRaces || 0) + 1;
                let reward = 0;
                // å¥–åŠ±è§„åˆ™ï¼š1st=300, 2nd=250, 3rd=200, 4th=150, 5th=100, 6th=50
                const rewards = [300, 250, 200, 150, 100, 50];
                reward = rewards[myHorseRankInGroup - 1] || 10;
                
                this.player.integral += reward;
                
                if (myHorseRankInGroup === 1) {
                    this.player.seasonWins = (this.player.seasonWins || 0) + 1;
                    // æ‰¾åˆ°ç©å®¶é©¬æ•°æ®æ›´æ–°èƒœåœº
                    const myH = this.player.horses.find(h => h.id === raceHorseId);
                    if(myH) myH.wins = (myH.wins || 0) + 1;
                }
                
                if (myHorseRankInGroup >= 4) {
                    this.player.seasonBottoms = (this.player.seasonBottoms || 0) + 1;
                }
                
                const myHorse = this.player.horses.find(h => h.id === raceHorseId);
                if (myHorse) {
                    myHorse.totalRaces = (myHorse.totalRaces || 0) + 1;
                }

                this.promoteHorseToStableFront(raceHorseId);
                
                // 4. æ„å»ºç»“ç®—é¢æ¿ä¿¡æ¯ (æ˜¾ç¤ºæ‰€æœ‰ç»„çš„å‰3å)
                let msg = `<div style="font-size:16px; color:#f1c40f; margin-bottom:10px;">${this.allGroups[this.playerGroupIndex].name} æ’å: ç¬¬ ${myHorseRankInGroup} (å¥–åŠ± ${reward})</div>`;
                
                msg += `<div style="display:flex; gap:10px; justify-content:center; text-align:left; font-size:10px;">`;
                allGroupResults.forEach(res => {
                    msg += `<div style="background:#34495e; padding:5px; border-radius:4px;">`;
                    msg += `<div style="color:#bdc3c7; border-bottom:1px solid #555; margin-bottom:3px;">${res.name}</div>`;
                    res.rankings.slice(0, 6).forEach((h, i) => {
                        const isMe = h.id === raceHorseId;
                        const color = isMe ? '#2ecc71' : (i===0 ? '#f1c40f' : '#ecf0f1');
                        msg += `<div style="color:${color};">${i+1}. ${h.name}</div>`;
                    });
                    msg += `</div>`;
                });
                msg += `</div>`;
                
                this.updateUI();
                this._pendingRaceUiRefresh = false;
                this.showResultPanel(msg); // è¿™é‡Œä¼ å…¥çš„æ˜¯ HTMLï¼Œéœ€è¦ä¿®æ”¹ showResultPanel æ”¯æŒ HTML
                this.currentRaceHorseId = null;

                // ç§»é™¤æ‰€æœ‰è·Ÿéšåç‰Œ
                this.horses.forEach(h => {
                    if (h.nameTag && h.nameTag.parentNode) {
                        h.nameTag.parentNode.removeChild(h.nameTag);
                    }
                });

                // æ¸…ç©ºè·‘é“å†…å®¹ï¼Œä½†ä¸ç«‹åˆ»è¿”å›å¤§å…ï¼Œäº¤ç”±ç»“ç®—é¢æ¿å¤„ç†è¿”å›é€»è¾‘
                document.getElementById('track-layer').innerHTML = '';
                document.getElementById('track-layer').style.transform = 'translateX(0)';
            }

            openDraft() {
                const races = this.player.seasonRaces || 0;
                const wins = this.player.seasonWins || 0;
                const bottoms = this.player.seasonBottoms || 0; // å€’æ•°æ’åæ¬¡æ•°
                if (races < 8) {
                    alert("æœ¬èµ›å­£æœªç»“æŸï¼ˆéœ€å®Œæˆ 8 åœºæ¯”èµ›ï¼‰æ‰å¯è¿›å…¥é€‰ç§€ã€‚");
                    return;
                }
                
                // ç¡®å®šç§å­é¡ºä½ (1-14)
                if (!this.player.heldDraftPick || this.player.heldDraftPick.seasonNo !== this.player.seasonNo) {
                    // åŸºäºå€’æ•°æ’åæ¬¡æ•°åˆ¤å®šç§å­é¡ºä½
                    // å€’æ•°æ¬¡æ•° >= 6: ç§å­ 1-3 (å¹¶åˆ—å€’æ•°ç¬¬ä¸€ï¼Œå‡ç­‰æ¦‚ç‡)
                    // å€’æ•°æ¬¡æ•° 5: ç§å­ 4
                    // ...
                    let seed = 14;
                    if (bottoms >= 6) seed = Math.floor(Math.random() * 3) + 1; // 1, 2, 3
                    else if (bottoms === 5) seed = 4;
                    else if (bottoms === 4) seed = 5;
                    else if (bottoms === 3) seed = 6;
                    else if (bottoms === 2) seed = 7;
                    else if (bottoms === 1) seed = Math.floor(Math.random() * 3) + 8; // 8-10
                    else seed = Math.floor(Math.random() * 4) + 11; // 11-14
                    
                    this.player.heldDraftPick = { 
                        seed: seed, 
                        isTraded: false,
                        originalOwner: 'ç©å®¶',
                        seasonNo: this.player.seasonNo,
                        seasonStats: { races, wins, bottoms }
                    };
                }
                
                const seed = this.player.heldDraftPick.seed;
                // ç®€å•çš„èƒœç‡æè¿°
                const odds = seed <= 3 ? "14.0%" : (seed === 4 ? "12.5%" : "ä½");
                
                const statusHtml = `
                    <p>æœ¬èµ›å­£æˆ˜ç»©: ${wins}èƒœ / ${races}åœº (å€’æ•°æ’å: ${bottoms}æ¬¡)</p>
                    <p>è·å¾—ä¹é€ç§å­: <span style="color:#e74c3c; font-weight:bold; font-size:20px;">ç¬¬ ${seed} å·</span> ${this.player.heldDraftPick.isTraded ? '(å·²äº¤æ˜“)' : ''}</p>
                    <p style="font-size:12px; color:#95a5a6;">(çŠ¶å…ƒæ¦‚ç‡: ${odds}ï¼Œå°†é€šè¿‡14çƒä¹’ä¹“çƒæ‘‡å·å†³å®šå½’å±)</p>
                `;
                document.getElementById('draft-status').innerHTML = statusHtml;
                document.getElementById('draft-result').style.display = 'none';
                document.getElementById('btn-start-draft').style.display = 'block';
                document.getElementById('btn-close-draft').style.display = 'none';
                document.getElementById('btn-open-trade').style.display = 'block';
                document.getElementById('draft-panel').style.display = 'flex';
                
                this.currentDraftSeed = seed;
            }

            openTrade() {
                document.getElementById('draft-panel').style.display = 'none';
                document.getElementById('trade-panel').style.display = 'flex';
                this.updateTradeUI();
            }

            closeTrade() {
                document.getElementById('trade-panel').style.display = 'none';
                document.getElementById('draft-panel').style.display = 'flex';
                this.openDraft();
            }

            updateTradeUI() {
                document.getElementById('trade-my-points').innerText = this.player.integral;
                document.getElementById('trade-my-tier').innerText = `ç§å­ ${this.player.heldDraftPick.seed}`;
                document.getElementById('trade-target-tier').innerText = 'è¯·é€‰æ‹©';
                document.getElementById('trade-action-area').style.display = 'none';
                
                const list = document.getElementById('trade-list');
                list.innerHTML = '';
                
                // ç”Ÿæˆ 14 ä¸ª AI å¯¹æ‰‹ (å¯¹åº”ç§å­ 1-14)
                const aiTeams = [];
                for (let s = 1; s <= 14; s++) {
                    let name = `AI é˜Ÿä¼ ${s}`;
                    let desc = `ç§å­ ${s}`;
                    if (s <= 3) {
                        name = `âš¡ æ‘†çƒ‚å¤§é˜Ÿ ${s}`;
                        desc = `çŠ¶å…ƒçƒ­é—¨ (14.0%)`;
                    } else if (s <= 6) {
                        name = `ğŸ›¡ï¸ é‡å»ºå†›å›¢ ${s}`;
                        desc = `ä¸­æ¸¸çƒé˜Ÿ`;
                    } else if (s <= 10) {
                        name = `âš”ï¸ å­£åèµ›è¾¹ç¼˜ ${s}`;
                        desc = `å†²å‡»é¡ºä½`;
                    } else {
                        name = `ğŸŒªï¸ å¤ºå† çƒ­é—¨ ${s}`;
                        desc = `å¼ºé˜Ÿ (0.5%çŠ¶å…ƒ)`;
                    }
                    
                    aiTeams.push({ name: name, seed: s, desc: desc });
                }
                
                aiTeams.forEach((ai, idx) => {
                    const item = document.createElement('div');
                    item.style.padding = '10px';
                    item.style.borderBottom = '1px solid #333';
                    item.style.display = 'flex';
                    item.style.justifyContent = 'space-between';
                    item.style.alignItems = 'center';
                    item.style.cursor = 'pointer';
                    item.innerHTML = `
                        <div>
                            <div style="color:#ecf0f1; font-weight:bold;">${ai.name}</div>
                            <div style="font-size:10px; color:#7f8c8d;">${ai.desc}</div>
                        </div>
                        <div style="color:#f1c40f; font-weight:bold;">ç§å­ ${ai.seed}</div>
                    `;
                    item.onclick = () => this.selectTradeTarget(ai);
                    list.appendChild(item);
                });
            }

            selectTradeTarget(ai) {
                this.selectedTradeTarget = ai;
                document.getElementById('trade-target-tier').innerText = `ç§å­ ${ai.seed}`;
                document.getElementById('trade-action-area').style.display = 'block';
                document.getElementById('trade-slider').value = 0;
                this.updateTradeCalc();
            }

            updateTradeCalc() {
                const addPoints = parseInt(document.getElementById('trade-slider').value);
                document.getElementById('trade-offer-val').innerText = addPoints;
                
                const mySeed = this.player.heldDraftPick.seed;
                const targetSeed = this.selectedTradeTarget.seed;
                
                // ä»·å€¼ä¼°ç®—: ç§å­è¶Šå°è¶Šå€¼é’±
                // ç§å­1: 5000, ç§å­14: 100
                const getValue = (s) => Math.floor(5000 / Math.pow(1.2, s-1));
                const myVal = getValue(mySeed);
                const targetVal = getValue(targetSeed);
                
                const totalOffer = myVal + addPoints;
                const reqVal = targetVal * 1.1; 
                
                const msg = document.getElementById('trade-msg');
                if (totalOffer >= reqVal) {
                    msg.innerHTML = '<span style="color:#2ecc71">âœ… å¯¹æ–¹çœ‹èµ·æ¥å¾ˆæ„Ÿå…´è¶£</span>';
                    this.canTrade = true;
                } else {
                    const diff = reqVal - totalOffer;
                    msg.innerHTML = `<span style="color:#e74c3c">âŒ å¯¹æ–¹è§‰å¾—ç­¹ç ä¸å¤Ÿ (å·®çº¦${Math.ceil(diff)})</span>`;
                    this.canTrade = false;
                }
            }

            executeTrade() {
                if (!this.canTrade) {
                    alert("å¯¹æ–¹æ‹’ç»äº†ä½ çš„æŠ¥ä»·ï¼è¯·å¢åŠ ç­¹ç ã€‚");
                    return;
                }
                const points = parseInt(document.getElementById('trade-slider').value);
                if (this.player.integral < points) {
                    alert("ä½ çš„ç§¯åˆ†ä¸è¶³ï¼");
                    return;
                }
                
                this.player.integral -= points;
                this.player.heldDraftPick.seed = this.selectedTradeTarget.seed;
                this.player.heldDraftPick.isTraded = true;
                
                alert(`äº¤æ˜“æˆåŠŸï¼ä½ è·å¾—äº†ã€${this.selectedTradeTarget.name}ã€‘çš„ç¬¬ ${this.selectedTradeTarget.seed} å·ç§å­ï¼`);
                this.closeTrade();
            }

            startDraft() {
                // æ¨¡æ‹ŸæŠ½ç­¾åŠ¨ç”»
                const btn = document.getElementById('btn-start-draft');
                btn.style.display = 'none';
                // æŠ½ç­¾å¼€å§‹åï¼Œç¦ç”¨/éšè—äº¤æ˜“å…¥å£ï¼Œé˜²æ­¢ä½œå¼Š
                document.getElementById('btn-open-trade').style.display = 'none';
                
                const status = document.getElementById('draft-status');
                status.innerHTML = "ğŸ² æ­£åœ¨è¿›è¡Œä¹é€æŠ½ç­¾...";
                
                setTimeout(() => {
                    this.performDraft();
                }, 1500);
            }

            performDraft() {
                const playerSeed = this.currentDraftSeed;
                const statusEl = document.getElementById('draft-status');
                
                // 14ä¸ªçƒæŠ½4ä¸ªçš„ä¹é€é€»è¾‘
                statusEl.innerHTML = "ğŸ² æ­£åœ¨æŠ½å– 4 ä¸ªä¹’ä¹“çƒç»„åˆ...";
                
                // å®šä¹‰å„ç§å­é˜Ÿçš„ç»„åˆæ•° (æ€»å…±1000)
                const seedCombos = {
                    1: 140, 2: 140, 3: 140,
                    4: 125, 5: 105, 6: 90, 7: 75,
                    8: 60, 9: 45, 10: 30,
                    11: 20, 12: 15, 13: 10, 14: 5
                };
                
                // æ¨¡æ‹ŸæŠ½ç­¾è¿‡ç¨‹
                // å®é™…ä¸Šæˆ‘ä»¬ä¸éœ€è¦çœŸçš„ç”Ÿæˆç»„åˆï¼Œåªéœ€è¦æŒ‰æ¦‚ç‡æŠ½å–
                // æŠ½ Top 4
                const lotteryResults = [];
                const remainingSeeds = new Set([1,2,3,4,5,6,7,8,9,10,11,12,13,14]);
                
                for (let pick = 1; pick <= 4; pick++) {
                    let totalPool = 0;
                    remainingSeeds.forEach(s => totalPool += seedCombos[s]);
                    
                    let rnd = Math.random() * totalPool;
                    let winner = -1;
                    
                    for (let s of remainingSeeds) {
                        if (rnd < seedCombos[s]) {
                            winner = s;
                            break;
                        }
                        rnd -= seedCombos[s];
                    }
                    
                    lotteryResults.push(winner);
                    remainingSeeds.delete(winner);
                }
                
                // å‰©ä¸‹çš„æŒ‰ç§å­é¡ºä½æ’åº (ç§å­å·å°çš„æ’å‰é¢)
                const rest = Array.from(remainingSeeds).sort((a,b) => a - b);
                const finalOrder = lotteryResults.concat(rest);
                
                // æ‰¾åˆ°ç©å®¶çš„æœ€ç»ˆé¡ºä½
                // finalOrder çš„ç´¢å¼•+1 å³ä¸ºé¡ºä½
                const playerPick = finalOrder.indexOf(playerSeed) + 1;
                
                this.currentPick = playerPick;
                
                setTimeout(() => {
                    const lotteryInfo = `
                        <div style="font-size:12px; color:#bdc3c7; text-align:left; margin:10px auto; width:80%;">
                            <div>ç¬¬1é¡ºä½: ç§å­${lotteryResults[0]} (ä¸­ç­¾)</div>
                            <div>ç¬¬2é¡ºä½: ç§å­${lotteryResults[1]} (ä¸­ç­¾)</div>
                            <div>ç¬¬3é¡ºä½: ç§å­${lotteryResults[2]} (ä¸­ç­¾)</div>
                            <div>ç¬¬4é¡ºä½: ç§å­${lotteryResults[3]} (ä¸­ç­¾)</div>
                        </div>
                    `;
                    
                    document.getElementById('draft-pick-no').innerText = `ç¬¬ ${playerPick}`;
                    statusEl.innerHTML = `
                        ${lotteryInfo}
                        <div style="margin-top:10px;">ä½ çš„ç§å­: ${playerSeed}</div>
                        <div style="color:#f1c40f; font-size:20px; font-weight:bold;">æœ€ç»ˆè·å¾—: ç¬¬ ${playerPick} é¡ºä½</div>
                    `;
                    
                    this.generateDraftPool();
                    document.getElementById('draft-result').style.display = 'block';
                    document.getElementById('btn-close-draft').style.display = 'none';
                    this.updateUI();
                }, 1000);
            }
            
            generateDraftPool() {
                const container = document.getElementById('draft-pool-container');
                container.innerHTML = '';
                this.draftPool = [];
                
                let hasMythical = false; // æ ‡è®°æ˜¯å¦å·²ç»ç”Ÿæˆè¿‡ç¥å…½
                const usedNames = new Set();
                (this.player.horses || []).forEach(h => { if (h && h.name) usedNames.add(String(h.name)); });
                (this.player.aiStable || []).forEach(h => { if (h && h.name) usedNames.add(String(h.name)); });

                // ç”Ÿæˆ 14 åŒ¹é©¬ä½œä¸ºå€™é€‰ (å¯¹åº”14ä¸ªä¹é€ç­¾)
                for (let i = 1; i <= 14; i++) {
                    // åªæœ‰é¡ºä½1æœ‰æœºä¼šå‡ºç¥å…½ï¼Œå‰3å‡ºå²è¯—ï¼Œå…¶ä»–æ™®é€š
                    // è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šæ± å­é‡Œä»€ä¹ˆé©¬éƒ½æœ‰ï¼Œä½†æ˜¯èƒ½ä¸èƒ½é€‰åˆ°çœ‹é¡ºä½
                    
                    let quality = 'æ™®é€š';
                    
                    // ä¿®æ­£ï¼šç¡®ä¿åªæœ‰ä¸€åªç¥å…½
                    if (i === 1) {
                         // 30% æ¦‚ç‡å‡ºç¥å…½
                        if (Math.random() < 0.3) {
                            quality = 'ç¥å…½';
                            hasMythical = true;
                        } else {
                            quality = 'ç¨€æœ‰'; // æ²¡å‡ºç¥å…½ï¼Œä¿åº•ç¨€æœ‰ï¼ˆåŸé€»è¾‘æ˜¯å²è¯—æˆ–ç¨€æœ‰ï¼Œè¿™é‡Œç®€åŒ–ï¼‰
                        }
                    } 
                    // å…œåº•ï¼šå¦‚æœå‰é¢æ²¡å‡ºç¥å…½ï¼Œåé¢ä¹Ÿä¸å…è®¸å‡ºäº†
                    else if (i <= 3) quality = Math.random() < 0.5 ? 'å²è¯—' : 'ç¨€æœ‰';
                    else if (i <= 6) quality = Math.random() < 0.4 ? 'é«˜çº§' : 'ä¸­çº§';
                    else quality = 'æ™®é€š';
                    
                    const name = this.pickUniqueNewYearName(usedNames);
                    // ç”Ÿæˆé©¬åŒ¹æ•°æ®
                    const horse = {
                        id: 'pool_' + i,
                        name: name,
                        color: quality==='ç¥å…½'?'#e74c3c':(quality==='å²è¯—'?'#9b59b6':(quality==='ç¨€æœ‰'?'#f1c40f':'#ecf0f1')),
                        quality: quality,
                        // è¯„çº§é€»è¾‘ï¼šåŸºäºæ’ååŒºé—´
                        rating: this.getRatingByRank(i, quality),
                        data: this.createDraftHorseData(quality, name)
                    };
                    this.draftPool.push(horse);
                }
                
                // å¦‚æœå½“å‰æ˜¯ç©å®¶é¡ºä½(currentPick)ï¼Œå‰é¢çš„é©¬å·²ç»è¢«AIé€‰èµ°äº†
                // ç®€å•æ¨¡æ‹Ÿï¼šå¦‚æœç©å®¶æ˜¯ç¬¬3é¡ºä½ï¼Œé‚£ä¹ˆæ± å­é‡Œæœ€å¥½çš„2åŒ¹é©¬å·²ç»è¢«ç§»é™¤äº†
                // æˆ‘ä»¬ç›´æ¥ç§»é™¤å‰ (pick-1) ä¸ªé«˜è´¨é‡çš„é©¬
                // å…ˆæŒ‰çœŸå®è´¨é‡æ’åº
                const sortedPool = [...this.draftPool].sort((a,b) => {
                    const qMap = {'ç¥å…½':5, 'ç¨€æœ‰':4, 'å²è¯—':3, 'é«˜çº§':2, 'ä¸­çº§':1, 'æ™®é€š':0};
                    return qMap[b.quality] - qMap[a.quality];
                });
                
                // ç©å®¶é¡ºä½
                const playerPick = this.currentPick || parseInt(document.getElementById('draft-pick-no').innerText) || 14;

                // AI é€‰èµ°å‰ (currentPick - 1) ä¸ª
                const available = sortedPool.slice(playerPick - 1);
                
                // æ¨¡æ‹Ÿï¼šè¢« AI é€‰èµ°çš„é©¬ï¼ŒçœŸæ­£åŠ å…¥ AI é©¬å©
                const aiPicked = sortedPool.slice(0, playerPick - 1);
                aiPicked.forEach(h => {
                    // AI å¾—åˆ°è¿™åŒ¹é©¬
                    if (!this.player.aiStable) this.player.aiStable = [];
                    this.player.aiStable.push(h.data);
                });

                // ç¡®ä¿ AI é©¬å©é‡Œçš„ç¥å…½æ•°é‡ä¹Ÿå—åˆ°é™åˆ¶
                // éå† aiStableï¼Œå¦‚æœæœ‰è¶…è¿‡1åªç¥å…½ï¼ŒæŠŠå¤šä½™çš„é™çº§ä¸ºå²è¯—æˆ–ç¨€æœ‰
                if (this.player.aiStable) {
                    const mythicals = this.player.aiStable.filter(h => h.quality === 'ç¥å…½');
                    if (mythicals.length > 1) {
                        // ä¿ç•™æœ€æ–°çš„ä¸€åªï¼Œå…¶ä»–çš„é™çº§
                        // ä»ç¬¬äºŒä¸ªå¼€å§‹é™çº§
                        for (let i = 1; i < mythicals.length; i++) {
                            mythicals[i].quality = 'å²è¯—';
                            mythicals[i].color = '#9b59b6';
                            mythicals[i].name = mythicals[i].name.replace('ç¥å…½', 'å²è¯—'); // æ”¹å
                        }
                    }
                }

                // æ‰“ä¹±é¡ºåºæ˜¾ç¤ºï¼Œä¸è®©ç©å®¶ç›´æ¥çœ‹å‡ºå“ªä¸ªæœ€å¥½ï¼ˆè™½ç„¶è¯„çº§èƒ½çœ‹å‡ºæ¥ï¼‰
                const displayList = available.sort(() => 0.5 - Math.random());
                
                displayList.forEach(h => {
                    const div = document.createElement('div');
                    div.className = 'draft-card';
                    div.style.cssText = `
                        width: 90px; height: 110px;
                        background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('assets/icon.png');
                        background-position: center;
                        background-size: cover;
                        background-repeat: no-repeat;
                        border: 1px solid #555;
                        border-radius: 6px; display: flex; flex-direction: column;
                        align-items: center; justify-content: flex-start; cursor: pointer;
                        transition: transform 0.1s;
                        padding-top: 10px;
                    `;
                    const spMin = (h.data && typeof h.data.speedRangeMin === 'number') ? h.data.speedRangeMin : '';
                    const spMax = (h.data && typeof h.data.speedRangeMax === 'number') ? h.data.speedRangeMax : '';
                    const skillCount = (h.data && Array.isArray(h.data.genes)) ? h.data.genes.length : 0;
                    div.innerHTML = `
                        <div style="font-size:12px; margin-top:28px; color:#f1c40f; font-weight:800; text-shadow:0 1px 2px rgba(0,0,0,0.9), 0 0 6px rgba(241,196,15,0.35);">${h.name}</div>
                        <div style="font-size:14px; color:#f1c40f; font-weight:bold;">${h.rating}</div>
                        <div style="font-size:10px; color:#ecf0f1; text-shadow:0 1px 2px rgba(0,0,0,0.9);">é€Ÿåº¦: ${spMin}-${spMax}</div>
                        <div style="font-size:10px; color:#ecf0f1; text-shadow:0 1px 2px rgba(0,0,0,0.9);">æŠ€èƒ½æ± æ•°é‡: ${skillCount}</div>
                    `;
                    div.onclick = () => this.selectDraftHorse(h, div);
                    container.appendChild(div);
                });
            }
            
            getRatingByRank(rank, realQuality) {
                // åŸºäºæ’ååŒºé—´çš„è¯„çº§é€»è¾‘
                // 1-5å: æ˜¾ç¤º S
                // 6-10å: æ˜¾ç¤º A
                // 11-15å: æ˜¾ç¤º B (å®é™…ä¸Šæˆ‘ä»¬åªç”Ÿæˆ10ä¸ªï¼Œæ‰€ä»¥æ˜¯ 6-10=A)
                // ä½†è¿™é‡Œæˆ‘ä»¬åªæœ‰10ä¸ªæ± å­ï¼Œæ‰€ä»¥è°ƒæ•´ä¸€ä¸‹ï¼š
                // 1-3: S
                // 4-7: A
                // 8-10: B
                
                let rating = 'B';
                if (rank <= 3) rating = 'S';
                else if (rank <= 7) rating = 'A';
                
                // å¢åŠ è¿·æƒ‘æ€§ï¼šæœ‰æ¦‚ç‡æ˜¾ç¤ºä¸å‡†
                // æ¯”å¦‚æŠŠ S æ˜¾ç¤ºæˆ A (è¢«ä½ä¼°)ï¼Œæˆ–è€… B æ˜¾ç¤ºæˆ A (è¢«é«˜ä¼°)
                const rnd = Math.random();
                if (rnd < 0.2) {
                    if (rating === 'S') rating = 'A';
                    else if (rating === 'A') rating = Math.random()<0.5 ? 'S' : 'B';
                    else if (rating === 'B') rating = 'A';
                }
                
                return rating;
            }
            
            getRatingByQuality(q) {
                // åºŸå¼ƒï¼Œæ”¹ç”¨ getRatingByRank
                return 'C';
            }
            
            createDraftHorseData(quality, nameOverride) {
                 // ä¿®å¤ï¼šç¡®ä¿ ID å”¯ä¸€æ€§ï¼Œé¿å…å¤šåªç¥å…½é©¬å› éšæœºæ•°ç¢°æ’æˆ–é€»è¾‘å¤åˆ¶å¯¼è‡´ ID ç›¸åŒ
                 // è™½ç„¶ Date.now() å¾ˆå¿«ï¼Œä½†å¾ªç¯ä¸­å¯èƒ½ç›¸åŒï¼ŒåŠ ä¸ªå¤§çš„éšæœºæ•°
                 const id = 'draft_' + Date.now() + '_' + Math.floor(Math.random() * 1000000);
                 const lifespan = quality==='ç¥å…½'?80 : (quality==='å²è¯—'?70 : 60);
                 const horse = {
                    id: id,
                    name: String(nameOverride || (quality + 'æ–°ç§€')),
                    color: quality==='ç¥å…½'?'#e74c3c':(quality==='å²è¯—'?'#9b59b6':(quality==='ç¨€æœ‰'?'#f1c40f':'#ecf0f1')),
                    quality: quality,
                    baseSpeed: 60 + Math.random() * 10,
                    stamina: 70,
                    accel: 0.8,
                    temper: 0.5,
                    lifespan: lifespan,
                    maxLifespan: lifespan,
                    genes: [],
                    geneSlots: Math.max(5, this.slotCountForHorse({quality})), // é€‰ç§€é©¬è‡³å°‘5ä¸ªæ§½
                    totalRaces: 0,
                    lockedStartGenes: [],
                    spriteSet: quality === 'ç¥å…½'
                        ? pickLegendarySpriteSet()
                        : (quality === 'å²è¯—'
                            ? SpriteSet.Epic
                            : (quality === 'ç¨€æœ‰'
                                ? (Math.random() < 0.5 ? SpriteSet.Rare : SpriteSet.Rare2)
                                : (Math.random() < 0.35 ? SpriteSet.Base : SpriteSet.Horse)))
                };
                // éšæœºç»™ç‚¹æŠ€èƒ½ (é€‰ç§€é©¬è‡³å°‘æ¿€æ´»5ä¸ªæŠ€èƒ½)
                const slots = horse.geneSlots;
                const pool = Object.values(GeneType).map(t => ({type:t, quality:'æ™®é€š'}));
                // ç¡®ä¿æ¿€æ´»æ•°é‡ä¸è¶…æ§½ä½æ•°ï¼Œä¸”è‡³å°‘5ä¸ª(å› ä¸ºä¸Šé¢å¼ºåˆ¶slots>=5äº†)
                horse.genes = this.pickStartGenes(pool, Math.min(slots, Math.max(5, Math.floor(slots/2))));
                if (quality === 'ç¥å…½' || quality === 'ç¨€æœ‰') {
                    if (horse.genes.length > 0) horse.genes[0].quality = 'ç¨€æœ‰';
                }
                this.ensureLockedStartGenes(horse);
                const speedSlots = this.slotCountForHorse(horse);
                const active = (horse.lockedStartGenes || []).slice(0, speedSlots);
                const actual = Math.round(this.computeSpeedWithGenes(horse.baseSpeed, active, horse.genes, false));
                const down = 3 + Math.floor(Math.random() * 3);
                const up = 3 + Math.floor(Math.random() * 3);
                horse.speedRangeMin = Math.max(1, actual - down);
                horse.speedRangeMax = Math.max(horse.speedRangeMin + 1, actual + up);
                return horse;
            }
            
            selectDraftHorse(horseObj, el) {
                if (this.hasDrafted) return;
                
                // é€‰ä¸­è§†è§‰åé¦ˆ
                const cards = document.querySelectorAll('.draft-card');
                cards.forEach(c => c.style.border = '1px solid #555');
                el.style.border = '2px solid #2ecc71';
                
                if (confirm(`ç¡®å®šé€‰æ‹©è¯„çº§ä¸ºã€${horseObj.rating}ã€‘çš„é©¬åŒ¹å—ï¼Ÿ\n(æŠ€èƒ½å°†åœ¨å…¥é˜Ÿåæ­æ™“)`)) {
                    this.hasDrafted = true;
                    
                    // æ·±åº¦å…‹éš†ï¼šé˜²æ­¢å¼•ç”¨åŒä¸€å¯¹è±¡å¯¼è‡´æ•°æ®äº’é€š
                    // é€‰ç§€æ± é‡Œçš„ horseObj.data æ˜¯åŸå§‹å¯¹è±¡ï¼Œå¦‚æœä¸å…‹éš†ï¼Œ
                    // å¯èƒ½ä¼šå‡ºç° AI é©¬å©å’Œç©å®¶é©¬å©å¼•ç”¨åŒä¸€ä¸ªå¯¹è±¡çš„æƒ…å†µï¼ˆå¦‚æœé€»è¾‘æœ‰æ¼æ´ï¼‰
                    // å°¤å…¶æ˜¯å½“æ´—ç»ƒä¿®æ”¹å±æ€§æ—¶ï¼Œå¿…é¡»ç¡®ä¿æ˜¯ç‹¬ç«‹å¯¹è±¡
                    const newHorse = JSON.parse(JSON.stringify(horseObj.data));
                    
                    // å†æ¬¡ç¡®ä¿ ID å”¯ä¸€ï¼šè™½ç„¶ createDraftHorseData å·²ç»éšæœºäº†ï¼Œä½†å…¥é˜Ÿæ—¶å†åˆ·æ–°ä¸€æ¬¡æœ€ç¨³å¦¥
                    newHorse.id = 'h_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
                    
                    this.draftedHorse = newHorse;
                    
                    // åŠ å…¥é©¬å©
                    this.player.horses.push(newHorse);
                    
                    // è‡ªåŠ¨é€‰ä¸­æ–°é©¬
                    this.selectedHorseId = newHorse.id;
                    this.pushHint(`ğŸ‰ ç­¾çº¦æ–°é©¬ï¼š${newHorse.name}`);
                    this.updateUI();
                    
                    // æ˜¾ç¤ºç»“æœ
                    document.getElementById('draft-pool-container').innerHTML = `
                        <div style="text-align:center;">
                            <h3 style="color:#2ecc71">ğŸ‰ ç­¾çº¦æˆåŠŸï¼</h3>
                            <p>çœŸå®èµ„è´¨: <span style="color:#f1c40f; font-weight:bold;">${newHorse.quality}</span></p>
                            <p>å·²åŠ å…¥é©¬å©ï¼Œå¯åœ¨å¤§å…æŸ¥çœ‹è¯¦ç»†å±æ€§ã€‚</p>
                        </div>
                    `;
                    
                    // æ˜¾ç¤ºä¸‹ä¸€æ­¥æŒ‰é’®
                    document.getElementById('btn-close-draft').style.display = 'inline-block';
                    document.getElementById('btn-trade-new-horse').style.display = 'inline-block';
                    document.getElementById('btn-market-trade').style.display = 'inline-block';
                    
                    // å°†å‰©ä½™çš„é€‰ç§€é©¬åŒ¹åŠ å…¥ AI é©¬å©ï¼Œä½¿å…¶å¯äº¤æ˜“
                    this.draftPool.forEach(poolHorse => {
                        // è·³è¿‡ç©å®¶é€‰ä¸­çš„é©¬ï¼ˆé€šè¿‡åŸå§‹IDåˆ¤æ–­ï¼Œæˆ–è€…ç›´æ¥æ ¹æ®å¼•ç”¨ï¼‰
                        // æ³¨æ„ï¼šè¿™é‡Œ poolHorse.data è¿˜æ˜¯åŸå§‹å¯¹è±¡ï¼Œè€Œæˆ‘ä»¬åˆšæ‰å…‹éš†äº† newHorse
                        // æ‰€ä»¥è¦å¯¹æ¯” poolHorse.data.id å’Œ horseObj.data.id
                        if (poolHorse.data.id === horseObj.data.id) return;
                        
                        // åŒæ ·æ·±åº¦å…‹éš† AI çš„é©¬ï¼Œé˜²æ­¢ä»»ä½•æ½œåœ¨å¼•ç”¨å…³è”
                        const aiHorse = JSON.parse(JSON.stringify(poolHorse.data));
                        
                        // ç¡®ä¿ AI é©¬åŒ¹æœ‰åå­— (å»æ‰ "æ–°ç§€-" å‰ç¼€ï¼Œæˆ–è€…éšæœºä¸ªåå­—)
                        // ... (åŸæœ‰ AI å‘½åé€»è¾‘)
                        // ç¡®ä¿ AI é©¬å©é‡Œçš„ç¥å…½æ•°é‡ä¹Ÿå—åˆ°é™åˆ¶
                        // ...
                        
                        // è¿™é‡Œéœ€è¦æŠŠä¹‹å‰çš„ AI å…¥é˜Ÿé€»è¾‘æ¬è¿‡æ¥ï¼Œå¹¶åº”ç”¨åˆ° clone çš„å¯¹è±¡ä¸Š
                         if (!this.player.aiStable) this.player.aiStable = [];
                         
                         if (aiHorse.quality === 'ç¥å…½') {
                             const suffixes = ['å¤©å‘½', 'ä¼ å¥‡', 'æ— åŒ', 'è‡³å°Š', 'å¹»å½±', 'éœ¸ä¸»', 'æ˜Ÿè¾°'];
                             const suffix = suffixes[Math.floor(Math.random() * suffixes.length)];
                             aiHorse.name = "AI-ç¥å…½Â·" + suffix;
                             // AI ç¥å…½å†æ¬¡åˆ·æ–° ID
                             aiHorse.id = 'ai_' + Date.now() + '_' + Math.floor(Math.random() * 100000);
                         } else {
                             aiHorse.name = 'AI-' + aiHorse.name;
                         }
                         
                         // èµ‹äºˆéšæœºæŠ€èƒ½ (æ¨¡æ‹Ÿ AI é¢†æ‚Ÿ)
                        if (!aiHorse.genes || aiHorse.genes.length === 0) {
                            const slots = this.slotCountForHorse(aiHorse);
                            const pool = Object.values(GeneType).map(t => ({type:t, quality:'æ™®é€š'}));
                            aiHorse.genes = this.pickStartGenes(pool, Math.floor(Math.random() * slots));
                        }
                         
                         this.player.aiStable.push(aiHorse);
                    });
                    
                    // AI é©¬å©ç¥å…½å»é‡é€»è¾‘ (åŒä¸Š)
                    if (this.player.aiStable) {
                        const mythicals = this.player.aiStable.filter(h => h.quality === 'ç¥å…½');
                        if (mythicals.length > 1) {
                            for (let i = 1; i < mythicals.length; i++) {
                                mythicals[i].quality = 'å²è¯—';
                                mythicals[i].color = '#9b59b6';
                                mythicals[i].name = mythicals[i].name.replace('ç¥å…½', 'å²è¯—');
                            }
                        }
                    }
                    
                    // ç®€å•çš„ AI é©¬å©æ¸…ç† (ä¿ç•™æœ€æ–°çš„ 30 åŒ¹ï¼Œé¿å…æ— é™è†¨èƒ€)
                    if (this.player.aiStable.length > 30) {
                        // æŒ‰ä»·å€¼æ’åºï¼Œä¿ç•™ä»·å€¼é«˜çš„
                        this.player.aiStable.sort((a,b) => this.calculateHorseValue(b) - this.calculateHorseValue(a));
                        this.player.aiStable = this.player.aiStable.slice(0, 30);
                    }
                    
                    if (this.player.horses.length > this.stableCap) {
                        alert("é©¬å©çˆ†æ»¡ï¼è¯·å°½å¿«æ¸…ç†æ—§é©¬ã€‚");
                    }
                }
            }
            
            openHorseTrade() {
                if (!this.draftedHorse) return;
                
                // è®¡ç®—äº¤æ˜“ä»·æ ¼ï¼šåŸºäºèµ„è´¨åŠ¨æ€å®šä»·
                const quality = this.draftedHorse.quality;
                // ç¥å…½=4000, ç¨€æœ‰=3000, å²è¯—=2500, é«˜çº§=2000, ä¸­çº§=1500, æ™®é€š=1000
                const priceMap = {'ç¥å…½':4000, 'ç¨€æœ‰':3000, 'å²è¯—':2500, 'é«˜çº§':2000, 'ä¸­çº§':1500, 'æ™®é€š':1000};
                this.currentTradePrice = priceMap[quality] || 1000;
                
                document.getElementById('horse-trade-price').innerText = this.currentTradePrice + 'ç§¯åˆ†';
                document.getElementById('horse-trade-modal').style.display = 'flex';
            }
            
            cancelHorseTrade() {
                document.getElementById('horse-trade-modal').style.display = 'none';
            }
            
            confirmHorseTrade() {
                // å–æ‰åˆšé€‰çš„é©¬
                const idx = this.player.horses.findIndex(h => h.id === this.draftedHorse.id);
                if (idx !== -1) {
                    this.player.horses.splice(idx, 1);
                    this.player.integral += this.currentTradePrice;
                    alert(`äº¤æ˜“æˆåŠŸï¼è·å¾— ${this.currentTradePrice} ç§¯åˆ†ã€‚`);
                }
                this.cancelHorseTrade();
                this.closeDraft();
            }

            closeDraft() {
                this.hasDrafted = false;
                this.draftedHorse = null;
                document.getElementById('draft-panel').style.display = 'none';
                document.getElementById('btn-trade-new-horse').style.display = 'none'; // éšè—æŒ‰é’®
                document.getElementById('btn-market-trade').style.display = 'none'; // éšè—æŒ‰é’®
                
                // --- æ–°å¢ï¼šå¥–æ¯ç»“ç®—é€»è¾‘ ---
                // èµ›å­£ç»“ç®—ï¼šæŒ‰æ€»èƒœç‡åˆ¤æ–­ï¼Œæ¨¡æ‹Ÿå’Œå…¶ä»–AIå¯¹æ¯”
                // å‡è®¾ï¼šå¦‚æœèƒœç‡ >= 40% ä¸” åœºæ¬¡ >= 8ï¼Œç®—ä½œèµ›å­£ç¬¬ä¸€ï¼ˆç®€åŒ–é€»è¾‘ï¼‰
                const races = this.player.seasonRaces || 0;
                const wins = this.player.seasonWins || 0;
                const rate = races > 0 ? (wins / races) * 100 : 0;
                
                // é‡ç½®è£èª‰çŠ¶æ€
                this.player.hasSeasonChampion = false;

                if (races >= 8 && rate >= 40) {
                    this.player.trophies = (this.player.trophies || 0) + 1;
                    this.player.hasSeasonChampion = true; // è·å¾—ä¸‹èµ›å­£çš„è£èª‰æ˜¾ç¤º
                    
                    // æ£€æŸ¥æ˜¯å¦åˆå¹¶é«˜çº§å¥–æ¯
                    const total = this.player.trophies;
                    if (total % 10 === 0) {
                        alert(`ğŸ† æ­å–œï¼ä½ è·å¾—äº†ç¬¬ ${total} ä¸ªå¥–æ¯ï¼Œå·²è‡ªåŠ¨åˆæˆé«˜çº§è£èª‰ï¼\n(æœ¬èµ›å­£èƒœç‡: ${rate.toFixed(1)}%)`);
                    } else {
                        alert(`ğŸ† èµ›å­£ç»“ç®—ï¼šæ­å–œè·å¾—èµ›å­£ç¬¬ä¸€ï¼\nå¥–æ¯ +1 (å½“å‰: ${total})\n(æœ¬èµ›å­£èƒœç‡: ${rate.toFixed(1)}%)`);
                    }
                } else if (races >= 8) {
                    alert(`èµ›å­£ç»“æŸã€‚\nèƒœç‡: ${rate.toFixed(1)}% (æœªè¾¾åˆ°å† å†›æ ‡å‡† 40%)\nç»§ç»­åŠ æ²¹ï¼`);
                }
                // -------------------------

                // é‡ç½®èµ›å­£
                this.player.seasonRaces = 0;
                this.player.seasonWins = 0;
                this.player.seasonBottoms = 0;
                // é‡ç½®é€‰ç§€æƒï¼Œç¡®ä¿æ–°èµ›å­£é‡æ–°æ ¹æ®èƒœç‡è®¡ç®—
                this.player.heldDraftPick = null;
                this.player.seasonNo = (this.player.seasonNo || 1) + 1;
                
                this.updateUI();
                alert("æ–°èµ›å­£å·²å¼€å¯ï¼");
            }
            
            // --- çƒå‘˜äº¤æ˜“å¸‚åœºé€»è¾‘ ---
            openMarket() {
                document.getElementById('market-panel').style.display = 'flex';
                this.selectedMarketTarget = null;
                this.selectedMarketChips = new Set();
                this.renderMarket();
                this.updateMarketCalc();
            }
            
            closeMarket() {
                document.getElementById('market-panel').style.display = 'none';
            }
            
            renderMarket() {
                // 1. æ¸²æŸ“ AI é©¬åˆ—è¡¨ (åªæ˜¾ç¤º player.aiStable é‡Œçš„)
                const aiList = document.getElementById('market-ai-list');
                aiList.innerHTML = '';
                const aiStable = this.player.aiStable || [];
                
                if (aiStable.length === 0) {
                    aiList.innerHTML = '<div style="color:#7f8c8d; padding:10px;">AI æš‚æ— å¯äº¤æ˜“é©¬åŒ¹</div>';
                } else {
                    aiStable.forEach(h => {
                        const val = this.calculateHorseValue(h);
                        const card = document.createElement('div');
                        card.style.cssText = `min-width:100px; background:#2c3e50; border:1px solid #7f8c8d; border-radius:6px; padding:5px; text-align:center; cursor:pointer; position:relative;`;
                        card.innerHTML = `
                            <div style="font-size:12px; font-weight:bold; color:${h.quality==='ç¥å…½'?'#e74c3c':(h.quality==='å²è¯—'?'#9b59b6':(h.quality==='ç¨€æœ‰'?'#f1c40f':'#ecf0f1'))}">${h.name}</div>
                            <div style="font-size:10px; color:#bdc3c7;">${h.quality}</div>
                            <div style="font-size:10px; color:#f1c40f;">è¯„åˆ†: ${val}</div>
                        `;
                        card.onclick = () => {
                            // å•é€‰
                            this.selectedMarketTarget = h;
                            Array.from(aiList.children).forEach(c => c.style.border = '1px solid #7f8c8d');
                            card.style.border = '2px solid #e74c3c';
                            this.updateMarketCalc();
                        };
                        aiList.appendChild(card);
                    });
                }
                
                // 2. æ¸²æŸ“æˆ‘çš„ç­¹ç  (æ˜¾ç¤ºæ‰€æœ‰é©¬åŒ¹ï¼ŒåŒ…æ‹¬åˆšé€‰çš„)
                const myList = document.getElementById('market-my-list');
                myList.innerHTML = '';
                this.player.horses.forEach(h => {
                    const val = this.calculateHorseValue(h);
                    const card = document.createElement('div');
                    card.style.cssText = `min-width:100px; background:#2c3e50; border:1px solid #7f8c8d; border-radius:6px; padding:5px; text-align:center; cursor:pointer;`;
                    card.innerHTML = `
                        <div style="font-size:12px; font-weight:bold; color:${h.color}">${h.name}</div>
                        <div style="font-size:10px; color:#bdc3c7;">${h.quality}</div>
                        <div style="font-size:10px; color:#2ecc71;">è¯„åˆ†: ${val}</div>
                    `;
                    card.onclick = () => {
                        // å¤šé€‰
                        if (this.selectedMarketChips.has(h)) {
                            this.selectedMarketChips.delete(h);
                            card.style.border = '1px solid #7f8c8d';
                        } else {
                            this.selectedMarketChips.add(h);
                            card.style.border = '2px solid #2ecc71';
                        }
                        this.updateMarketCalc();
                    };
                    myList.appendChild(card);
                });
            }
            
            calculateHorseValue(h) {
                // ç®€å•çš„ä»·å€¼è¯„ä¼°å…¬å¼
                const qMap = {'ç¥å…½':5000, 'å²è¯—':3000, 'ç¨€æœ‰':2000, 'é«˜çº§':1200, 'ä¸­çº§':800, 'æ™®é€š':500};
                let val = qMap[h.quality] || 500;
                
                // é€Ÿåº¦åŠ æˆ
                val += Math.floor((h.baseSpeed - 55) * 50);
                
                // æŠ€èƒ½åŠ æˆ (æ°¸ä¹…æŠ€èƒ½)
                if (h.genes) {
                    h.genes.forEach(g => {
                        if (g.quality === 'ç¥å…½') val += 800;
                        else if (g.quality === 'å²è¯—') val += 500;
                        else if (g.quality === 'ç¨€æœ‰') val += 300;
                        else val += 50;
                    });
                }
                return Math.floor(val);
            }
            
            updateMarketCalc() {
                const targetVal = this.selectedMarketTarget ? this.calculateHorseValue(this.selectedMarketTarget) : 0;
                document.getElementById('market-target-val').innerText = targetVal;

                const targetPreview = document.getElementById('market-target-preview');
                if (targetPreview) {
                    if (this.selectedMarketTarget) {
                        const spriteSet = this.selectedMarketTarget.spriteSet || SpriteSet.Horse;
                        targetPreview.innerHTML = `
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div class="idle-horse market-idle-horse" data-sprite-set="${this.escapeHtml(spriteSet)}" data-idle-horse="1"></div>
                                <div style="text-align:left;">
                                    <div style="font-size:12px; font-weight:bold; color:${this.selectedMarketTarget.quality==='ç¥å…½'?'#e74c3c':(this.selectedMarketTarget.quality==='å²è¯—'?'#9b59b6':(this.selectedMarketTarget.quality==='ç¨€æœ‰'?'#f1c40f':'#ecf0f1'))}">${this.escapeHtml(this.selectedMarketTarget.name)}</div>
                                    <div style="font-size:10px; color:#bdc3c7;">${this.escapeHtml(this.selectedMarketTarget.quality)}</div>
                                </div>
                            </div>
                        `;
                        this.startStableIdleAnim(targetPreview);
                    } else {
                        targetPreview.innerHTML = '<div style="color:#95a5a6; font-size:12px;">æœªé€‰æ‹©ç›®æ ‡é©¬</div>';
                    }
                }
                
                let myVal = 0;
                this.selectedMarketChips.forEach(h => {
                    myVal += this.calculateHorseValue(h);
                });
                
                const points = parseInt(document.getElementById('market-points-slider').value);
                // ç§¯åˆ†æŠ˜ç®—ä»·å€¼ï¼š1ç§¯åˆ† = 1ä»·å€¼ (æˆ–è€…æ‰“æŠ˜)
                myVal += points;
                
                document.getElementById('market-my-val').innerText = myVal;
                document.getElementById('market-points-val').innerText = points;
                
                const msg = document.getElementById('market-msg');
                
                if (!this.selectedMarketTarget) {
                    msg.innerHTML = '<span style="color:#bdc3c7">è¯·é€‰æ‹©ç›®æ ‡é©¬åŒ¹</span>';
                    return;
                }
                
                // äº¤æ˜“é—¨æ§›ï¼šéœ€è¦æº¢ä»· 10%
                const reqVal = Math.floor(targetVal * 1.1);
                
                if (myVal >= reqVal) {
                    msg.innerHTML = '<span style="color:#2ecc71">âœ… äº¤æ˜“å¯è¡Œ</span>';
                } else {
                    msg.innerHTML = `<span style="color:#e74c3c">âŒ ç­¹ç ä¸è¶³ (å·®å€¼: ${reqVal - myVal})</span>`;
                }
            }
            
            executeMarketTrade() {
                if (!this.selectedMarketTarget) {
                    alert("è¯·å…ˆé€‰æ‹©è¦äº¤æ˜“çš„ç›®æ ‡é©¬åŒ¹ï¼");
                    return;
                }
                
                const targetVal = this.calculateHorseValue(this.selectedMarketTarget);
                let myVal = 0;
                this.selectedMarketChips.forEach(h => myVal += this.calculateHorseValue(h));
                const points = parseInt(document.getElementById('market-points-slider').value);
                myVal += points;
                
                const reqVal = Math.floor(targetVal * 1.1);
                
                if (myVal < reqVal) {
                    alert(`å¯¹æ–¹è®¤ä¸ºæ‚¨çš„ç­¹ç ä¸è¶³ï¼\nç›®æ ‡ä»·å€¼(å«æº¢ä»·): ${reqVal}\nå½“å‰ä»·å€¼: ${myVal}`);
                    return;
                }
                
                if (this.player.integral < points) {
                    alert("æ‚¨çš„ç§¯åˆ†ä¸è¶³ï¼");
                    return;
                }
                
                // æ£€æŸ¥é©¬å©å®¹é‡
                // é€»è¾‘ï¼šå¤±å» N åŒ¹ï¼Œå¾—åˆ° 1 åŒ¹ã€‚å®¹é‡å˜åŒ– = 1 - N
                // å¦‚æœ N=0 (çº¯ç§¯åˆ†ä¹°)ï¼Œåˆ™å®¹é‡+1ï¼Œéœ€æ£€æŸ¥ä¸Šé™
                const chipsCount = this.selectedMarketChips.size;
                const newCount = this.player.horses.length - chipsCount + 1;
                
                // è¿™é‡Œå…è®¸æš‚æ—¶è¶…ä¸Šé™ï¼Ÿæˆ–è€…ä¸¥æ ¼é™åˆ¶
                if (newCount > this.stableCap) {
                    alert(`äº¤æ˜“åé©¬å©å°†è¶…å‘˜ (${newCount}/${this.stableCap})ï¼è¯·å¢åŠ ç­¹ç é©¬åŒ¹æ•°é‡ã€‚`);
                    return;
                }
                
                if (confirm(`ç¡®å®šæ‰§è¡Œäº¤æ˜“å—ï¼Ÿ\nå°†å¤±å»: ${chipsCount}åŒ¹é©¬ + ${points}ç§¯åˆ†\nè·å¾—: ${this.selectedMarketTarget.name}`)) {
                    // æ‰£é™¤ç§¯åˆ†
                    this.player.integral -= points;
                    
                    // ç§»é™¤ç­¹ç é©¬åŒ¹
                    this.selectedMarketChips.forEach(chip => {
                        const idx = this.player.horses.indexOf(chip);
                        if (idx !== -1) this.player.horses.splice(idx, 1);
                    });
                    
                    // è·å¾—ç›®æ ‡é©¬åŒ¹
                    const target = this.selectedMarketTarget;
                    // ä» AI é©¬å©ç§»é™¤
                    const aiIdx = this.player.aiStable.indexOf(target);
                    if (aiIdx !== -1) this.player.aiStable.splice(aiIdx, 1);
                    
                    // æ”¹ä¸ªåå½’æˆ‘
                    if (target.name.startsWith('AI-')) target.name = target.name.replace('AI-', '');
                    this.player.horses.push(target);
                    
                    // ç­¹ç é©¬åŒ¹ç»™ AI (å¯é€‰ï¼Œè¿™é‡Œç›´æ¥ç§»é™¤ä¹Ÿå°±æ˜¯é€€å½¹/æµæ”¾)
                    
                    alert("äº¤æ˜“æˆåŠŸï¼");
                    this.closeMarket();
                    this.updateUI();
                    
                    // åˆ·æ–° Draft ç•Œé¢æŒ‰é’®çŠ¶æ€ (å¦‚æœå–æ‰äº† draftedHorseï¼ŒæŒ‰é’®è¦å¤„ç†å—ï¼Ÿ)
                    // å¦‚æœæŠŠ draftedHorse å–äº†ï¼ŒdraftedHorse å˜é‡è¿˜åœ¨å¼•ç”¨å®ƒå—ï¼Ÿ
                    // æœ€å¥½é‡ç½® draftedHorse
                    if (this.selectedMarketChips.has(this.draftedHorse)) {
                        this.draftedHorse = null;
                        document.getElementById('btn-trade-new-horse').style.display = 'none';
                    }
                }
            }
        }

        window.game = new Game();
        
        // ç»“ç®—é¢æ¿é€»è¾‘
        Game.prototype.showResultPanel = function(text) {
            const panel = document.getElementById('result-panel');
            const titleEl = document.getElementById('result-title');
            const descEl = document.getElementById('result-desc');
            const cdEl = document.getElementById('result-countdown');
            const btnBack = document.getElementById('btn-back-lobby');
            
            titleEl.innerText = "æ¯”èµ›ç»“ç®—";
            descEl.innerHTML = text; // å…è®¸ HTML
            panel.style.display = 'flex';
            
            let left = 5; // å»¶é•¿åˆ°5ç§’
            cdEl.innerText = `è‡ªåŠ¨è¿”å› (${left}s)`;
            
            let timer = setInterval(() => {
                left--;
                cdEl.innerText = `è‡ªåŠ¨è¿”å› (${left}s)`;
                if (left <= 0) {
                    clearInterval(timer);
                    this.closeResultPanel();
                }
            }, 1000);
            
            btnBack.onclick = () => {
                clearInterval(timer);
                this.closeResultPanel();
            };
        };
        
        Game.prototype.closeResultPanel = function() {
            const panel = document.getElementById('result-panel');
            panel.style.display = 'none';
            document.getElementById('lobby-panel').style.display = 'block';
            document.getElementById('status-label').style.display = 'none';
            
            // é€€å‡ºæ¯”èµ›æ¨¡å¼ï¼Œæ¢å¤UI
            document.getElementById('game-container').classList.remove('racing-mode');
        };
    </script>
</body>
</html>
