
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èµ›é©¬æ¸¸æˆé€»è¾‘é¢„è§ˆ (Lite)</title>
    <style>
        body { background: #1a1a1a; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 0; height: 100vh; justify-content: center; }
        /* ç«–å±å®¹å™¨ï¼š375x667 (iPhone SE) æˆ– 360x800 (å¸¸è§å®‰å“) */
        #game-container { 
            width: 375px; 
            height: 667px; 
            border: 2px solid #444; 
            position: relative; 
            background: #000; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            overflow: hidden; /* é˜²æ­¢è·‘å‡ºç•Œ */
        }
        
        /* é¡¶éƒ¨ä¿¡æ¯æ  - æ”¹ä¸º Flex å¸ƒå±€ï¼Œåˆ†ä¸¤è¡Œ */
        #info-panel { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 250px; /* è¿›ä¸€æ­¥å¢é«˜ä»¥å®¹çº³å®Œæ•´æŠ€èƒ½æ±  */
            background: rgba(0,0,0,0.6); 
            padding: 10px; 
            box-sizing: border-box;
            z-index: 10;
            display: flex;
            flex-direction: column;
        }

        /* ç©å®¶èµ„äº§è¡Œ */
        .asset-row {
            display: flex;
            justify-content: space-between;
            color: #f1c40f;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
            padding: 0 10px;
            flex-shrink: 0;
        }

        /* é©¬å©å®¹å™¨ - æ¨ªå‘æ»šåŠ¨ */
        .stable-container {
            flex: 1;
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 5px;
            /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
            scrollbar-width: none; 
        }
        .stable-container::-webkit-scrollbar { display: none; }

        /* é©¬åŒ¹åç‰Œå¡ç‰‡ */
        .horse-card {
            min-width: 160px; /* å¢åŠ å®½åº¦ä»¥å®¹çº³5åˆ—æŠ€èƒ½ */
            background: #34495e;
            border-radius: 8px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #7f8c8d;
            position: relative;
        }

        /* é€‰ä¸­çŠ¶æ€çš„é©¬åŒ¹å¡ç‰‡ */
        .horse-card.selected {
            border: 2px solid #2ecc71;
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
            transform: scale(1.02); /* ç¨å¾®å‡å°ç¼©æ”¾é˜²æ­¢æ¨¡ç³Š */
        }

        .horse-card:active {
            transform: scale(0.98);
        }
        
        /* åŸºå› æ ‡ç­¾å®¹å™¨ */
        .gene-tags {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 5åˆ—æ•´é½æ’åˆ— */
            gap: 3px;
            margin-top: 8px;
            width: 100%;
            padding: 2px;
            box-sizing: border-box;
            background: rgba(0,0,0,0.2); /* å¢åŠ èƒŒæ™¯è‰²åŒºåˆ† */
            border-radius: 4px;
        }
        
        .gene-tag {
            font-size: 10px; /* æ¢å¤å­—å·æ¸…æ™°åº¦ */
            line-height: 14px;
            padding: 2px 0;
            border-radius: 2px;
            color: #ecf0f1; /* é»˜è®¤äº®è‰²æ–‡å­— */
            font-weight: normal;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            /* ç§»é™¤ ellipsis ä»¥å…åªæ˜¾ç¤ºç‚¹ç‚¹ï¼Œä¾é å®½åº¦è¶³å¤Ÿæ˜¾ç¤º */
        }
        .gene-normal { background: #27ae60; color: #fff; } /* å·²æ‹¥æœ‰æ™®é€š-ç»¿è‰² */
        .gene-rare { background: #f1c40f; color: #000; box-shadow: 0 0 5px rgba(241, 196, 15, 0.5); font-weight: bold; } /* å·²æ‹¥æœ‰ç¨€æœ‰-é‡‘è‰² */
        .gene-locked { background: #2c3e50; color: #555; border: 1px solid #444; } /* æœªè§£é”æ ·å¼ */
        .gene-active { border: 2px solid #3498db; box-shadow: 0 0 6px rgba(52,152,219,0.6); }
        .gene-just { border: 2px solid #e74c3c !important; box-shadow: 0 0 6px rgba(231, 76, 60, 0.6); }


        /* è·‘é“å±‚å®¹å™¨ */
        #track-container {
            position: absolute;
            top: 250px; /* é¿å¼€é¡¶éƒ¨ä¿¡æ¯æ  */
            bottom: 0;
            left: 0;
            width: 100%;
            overflow: hidden; 
        }

        #track-layer {
            position: absolute;
            top: 0;
            left: 0;
            /* è·‘é“æ”¹ä¸ºæ¨ªå‘è¶…é•¿ */
            width: 10000px; 
            height: 100%; 
            background-color: #5da629; 
            background-image: 
                /* ç»ˆç‚¹çº¿ */
                linear-gradient(90deg, transparent 95%, rgba(255,255,255,0.8) 96%, transparent 97%),
                /* è‰åœ°çº¹ç†æ”¹ä¸ºæ¨ªå‘ */
                repeating-linear-gradient(
                    90deg,
                    transparent 0px,
                    transparent 19px,
                    rgba(0,0,0,0.05) 20px,
                    rgba(0,0,0,0.05) 40px
                );
            background-size: 1000px 100%, 40px 100%;
            overflow: hidden;
        }

        /* è·‘é“åˆ†éš”çº¿æ”¹ä¸ºæ¨ªå‘ */
        .lane-divider {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255,255,255,0.3);
            border-top: 1px dashed rgba(255,255,255,0.5);
        }

        .horse { 
            position: absolute; 
            width: 120px; 
            height: 120px; 
            /* ... æ ·å¼ä¿æŒä¸å˜ ... */
            border: none; 
            background-color: transparent !important;
            
            background-size: contain;
            background-repeat: no-repeat;
            display: flex;
            align-items: flex-end; 
            justify-content: center; 
            font-size: 10px; 
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
            transition: left 0.1s linear; 
            z-index: 100; 
            
            background-image: url('assets/sprites/horse_run/1_horesrun.png'); 
            
            /* é•œåƒç¿»è½¬ï¼šè®©é©¬å¤´æœå³ */
            transform: scaleX(-1); 
        }
        .horse-ghost {
            position: absolute;
            width: 120px;
            height: 120px;
            background-size: contain;
            background-repeat: no-repeat;
            pointer-events: none;
            opacity: 0.35;
            filter: brightness(1.2);
            z-index: 90;
            transform: scaleX(-1);
        }
        
        /* ä¿®æ­£æ–‡å­—æ–¹å‘ï¼šå› ä¸ºçˆ¶å…ƒç´ ç¿»è½¬äº†ï¼Œæ–‡å­—ä¹Ÿä¼šç¿»è½¬ï¼Œéœ€è¦æŠŠæ–‡å­—ç¿»è½¬å›æ¥ */
        /* ä½†ç”±äºæˆ‘ä»¬æŠŠæ–‡å­—ç›´æ¥å†™åœ¨ .horse é‡Œï¼Œå¤„ç†èµ·æ¥æ¯”è¾ƒéº»çƒ¦ */
        /* æ›´å¥½çš„åšæ³•æ˜¯æŠŠæ–‡å­—å•ç‹¬æ”¾ä¸€ä¸ªå­å…ƒç´ ï¼Œæˆ–è€…ä¸ç¿»è½¬çˆ¶å…ƒç´ ï¼Œè€Œæ˜¯ç”¨ scaleX(-1) ç¿»è½¬èƒŒæ™¯å›¾ */
        /* ä¸è¿‡ background-image ä¸æ”¯æŒç›´æ¥ scaleXï¼Œæ‰€ä»¥å¿…é¡»ç¿»è½¬å®¹å™¨ */
        /* æˆ‘ä»¬ç»™æ–‡å­—åŠ ä¸€ä¸ªåå‘ç¿»è½¬ */


        /* ç§»é™¤ä¹‹å‰çš„ CSS ç»˜åˆ¶ */
        .horse::before { content: none; }
        .horse::after { content: none; }

        /* å®šä¹‰åŠ¨ç”»ç±» - æˆ‘ä»¬ç”¨ JS åŠ¨æ€åˆ‡æ¢èƒŒæ™¯å›¾æ¥å®ç°åºåˆ—å¸§ï¼Œå› ä¸ºå›¾ç‰‡æ˜¯ç‹¬ç«‹çš„ png */
        /* æˆ–è€…ä½¿ç”¨ CSS keyframes å¦‚æœå›¾ç‰‡æ‹¼åœ¨ä¸€èµ· */


        /* UI æ“ä½œå±‚ */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }
        #ui-layer * { pointer-events: auto; }
        
        /* ç»“ç®—é¢æ¿ */
        #result-panel {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
            background: rgba(0,0,0,0.6);
        }
        .result-box {
            width: 80%;
            background: #2c3e50;
            border: 1px solid #7f8c8d;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        .result-title {
            font-size: 20px;
            margin-bottom: 8px;
            color: #f1c40f;
        }
        .result-desc {
            font-size: 14px;
            color: #ecf0f1;
            margin-bottom: 12px;
        }
        .result-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .btn-small {
            padding: 8px 12px;
            font-size: 14px;
            width: auto;
        }
        .countdown {
            margin-top: 8px;
            font-size: 12px;
            color: #bdc3c7;
        }
        /* åº•éƒ¨æŒ‰é’®åŒº */
        .panel { 
            position: absolute; 
            bottom: 50px; 
            left: 50%; 
            transform: translateX(-50%); 
            text-align: center; 
            width: 100%;
        }
        
        .btn { 
            display: block;
            width: 80%;
            margin: 10px auto;
            padding: 15px 0; 
            cursor: pointer; 
            font-size: 18px; 
            border: none; 
            color: #fff; 
            border-radius: 8px;
            font-weight: bold;
        }
        .btn-green { background: #27ae60; box-shadow: 0 4px #219150; }
        .btn-green:active { transform: translateY(2px); box-shadow: 0 2px #219150; }
        
        .btn-blue { background: #2980b9; box-shadow: 0 4px #2c3e50; }
        .btn-blue:active { transform: translateY(2px); box-shadow: 0 2px #2c3e50; }

        /* æŠ€èƒ½è¯´æ˜å¼¹çª— */
        #skill-modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 40;
        }
        .skill-modal-box {
            width: 80%;
            max-width: 320px;
            background: #2c3e50;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            color: #ecf0f1;
            text-align: center;
            border: 1px solid #7f8c8d;
        }
        .skill-title { font-weight: bold; font-size: 18px; margin-bottom: 8px; color: #f1c40f; }
        .skill-desc { font-size: 13px; color: #bdc3c7; margin-bottom: 12px; line-height: 1.5; }

        /* åŸ¹è‚²ç•Œé¢ (æ¨¡æ‹Ÿå¼¹çª—) */
        #breed-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* ä¿®æ­£å›¾ç‰‡è·¯å¾„ï¼šWebæœåŠ¡å™¨æ ¹ç›®å½•åœ¨ e:\horesï¼Œæ‰€ä»¥æ˜¯ assets/... */
            background-image: url('assets/bg/breed_bg.png'); 
            background-size: cover;
            background-position: center;
            display: none;
            z-index: 30;
            flex-direction: column;
            justify-content: flex-end; 
            padding-bottom: 50px;
        }
        
        #breed-panel::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); /* é®ç½©å±‚ï¼Œè®©æ–‡å­—æ›´æ¸…æ™° */
            z-index: -1;
        }

        /* åŸ¹è‚²ç•Œé¢æ ·å¼è¡¥å…¨ */
        .breed-info {
            position: relative;
            background: rgba(255,255,255,0.9);
            color: #333;
            margin: 20px;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* æ´—ç»ƒç•Œé¢ */
        #reforge-panel {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none;
            z-index: 40;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .reforge-container {
            width: 90%;
            background: #2c3e50;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border: 1px solid #7f8c8d;
        }

        .reforge-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .reforge-box {
            width: 48%;
            background: #34495e;
            padding: 10px;
            border-radius: 5px;
            min-height: 150px;
        }

        .reforge-title {
            color: #bdc3c7;
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 1px solid #7f8c8d;
            padding-bottom: 5px;
        }

        .reforge-actions {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>èµ›é©¬æ¸¸æˆé€»è¾‘é¢„è§ˆ (Lite)</h1>
    <div id="game-container">
        <div id="track-container">
            <div id="track-layer"></div>
        </div>
        <div id="ui-layer">
            <div id="info-panel"></div>
            <div id="lobby-panel" class="panel">
                <button class="btn btn-green" onclick="game.startRace()">å¼€å§‹æ¯”èµ› (-1é—¨ç¥¨)</button>
                <button class="btn btn-blue" onclick="game.openBreed()">åŸºå› åŸ¹è‚² (-500ç§¯åˆ†)</button>
                <button class="btn btn-blue" style="background:#8e44ad; box-shadow: 0 4px #6c3483;" onclick="game.openReforge()">æŠ€èƒ½æ´—ç»ƒ</button>
            </div>
            <div id="status-label" class="panel" style="top: 40%; display: none;"></div>
            <div id="result-panel">
                <div class="result-box">
                    <div id="result-title" class="result-title"></div>
                    <div id="result-desc" class="result-desc"></div>
                    <div class="result-actions">
                        <button id="btn-back-lobby" class="btn btn-green btn-small">è¿”å›å¤§å…</button>
                    </div>
                    <div id="result-countdown" class="countdown"></div>
                </div>
            </div>
            <div id="skill-modal">
                <div class="skill-modal-box">
                    <div id="skill-title" class="skill-title"></div>
                    <div id="skill-desc" class="skill-desc"></div>
                    <button class="btn btn-green btn-small" style="width:60%; font-size:14px;" onclick="game.closeSkillModal()">å…³é—­</button>
                </div>
            </div>
        </div>
        
        <!-- åŸ¹è‚²ç•Œé¢ -->
        <div id="breed-panel">
            <div class="breed-info">
                <h2>é©¬å©åŸ¹è‚²ä¸­å¿ƒ</h2>
                <p>æ¶ˆè€— 500 ç§¯åˆ†ï¼Œä¸ºæ‚¨å½“å‰çš„èµ›é©¬å¯»æ‰¾é…å¶ã€‚</p>
                <p id="breed-result" style="font-weight:bold; color:#e67e22;"></p>
                <button class="btn btn-green" onclick="game.confirmBreed()">å¼€å§‹åŸ¹è‚²</button>
                <button class="btn btn-blue" style="background:#7f8c8d" onclick="game.closeBreed()">è¿”å›å¤§å…</button>
            </div>
        </div>

        <!-- æ´—ç»ƒç•Œé¢ -->
        <div id="reforge-panel">
            <div class="reforge-container">
                <h2 style="text-align:center; margin-top:0; color:#e056fd">æŠ€èƒ½æ´—ç»ƒä¸­å¿ƒ</h2>
                <p style="text-align:center; font-size:12px; color:#aaa">æ¶ˆè€— 1 ç§¯åˆ†é‡ç½®å½“å‰æŠ€èƒ½ç»„åˆ</p>
                
                <div class="reforge-row">
                    <div class="reforge-box">
                        <div class="reforge-title">å½“å‰å±æ€§</div>
                        <div id="reforge-current-genes" class="gene-tags" style="grid-template-columns: repeat(3, 1fr);"></div>
                    </div>
                    <div class="reforge-box">
                        <div class="reforge-title">æ´—ç»ƒé¢„è§ˆ</div>
                        <div id="reforge-new-genes" class="gene-tags" style="grid-template-columns: repeat(3, 1fr);">
                            <div style="grid-column:1/-1; text-align:center; color:#7f8c8d; margin-top:40px;">ç‚¹å‡»æ´—ç»ƒç”Ÿæˆ</div>
                        </div>
                    </div>
                </div>

                <div class="reforge-actions">
                    <button id="btn-do-reforge" class="btn btn-blue" style="width:40%; background:#8e44ad; font-size:14px;" onclick="game.doReforge()">æ´—ç»ƒ (-1)</button>
                    <button id="btn-save-reforge" class="btn btn-green" style="width:40%; display:none; font-size:14px;" onclick="game.saveReforge()">ä¿å­˜ç»“æœ</button>
                    <button id="btn-discard-reforge" class="btn btn-blue" style="width:40%; display:none; background:#7f8c8d; font-size:14px;" onclick="game.discardReforge()">æ”¾å¼ƒ</button>
                </div>
                <button class="btn btn-blue" style="background:#7f8c8d; margin-top:10px;" onclick="game.closeReforge()">å…³é—­</button>
            </div>
        </div>
    </div>
    <script type="module">
        // æ¨¡æ‹Ÿ Cocos æ¨¡å—å¯¼å…¥
        const _decorator = { ccclass: () => {}, property: () => {} };
        
        // --- ç§»æ¤ Config.ts ---
        const Quality = { Normal: 'æ™®é€š', Rare: 'ç¨€æœ‰', Epic: 'å²è¯—', Legendary: 'ç¥å…½' };
        // åŸºå› ç±»å‹ - æ‰©å±•è‡³25ä¸ª
        const GeneType = {
            // åŸºç¡€ç±»
            Speed: 'ç–¾é£', Burst: 'çˆ†å†²', Agile: 'çµæ´»', Swift: 'ç¥é€Ÿ', Dash: 'é£é©°',
            // è€åŠ›ç±»
            Stamina: 'åšéŸ§', Endurance: 'æŒä¹…', Recover: 'å›æ˜¥', IronWill: 'é“å¿—', DeepBreath: 'æ·±æ¯',
            // ç¨³å®šæ€§ç±»
            Stable: 'ç¨³å¥', Calm: 'å†·é™', Focus: 'ä¸“æ³¨', Steady: 'å¦‚å±±', Balance: 'å¹³è¡¡',
            // ç‰¹æ®Šç±»
            Hybrid: 'æ··è¡€', LateBoomer: 'å¤§å™¨', EarlyBird: 'å…ˆé”‹', CornerKing: 'é£˜ç§»', SlopeRider: 'å¡é“',
            // ç¨€æœ‰/ç¥å…½ç±»
            Destiny: 'å¤©å‘½', Miracle: 'å¥‡è¿¹', Shadow: 'æ®‹å½±', Meteor: 'æµæ˜Ÿ', Legend: 'ä¼ è¯´'
        };
        
        const InitialPlayer = {
            integral: 2000,
            ticketsNormal: 30,
            horses: [{
                id: 'h1', name: 'èµ¤å…”', color: '#e63946', quality: 'æ™®é€š',
                baseSpeed: 55, stamina: 70, accel: 0.8, temper: 0.9,
                lifespan: 50, maxLifespan: 50, 
                genes: [{type:'ç–¾é£', quality:'æ™®é€š'}], // åˆå§‹åªç»™ä¸€ä¸ªåŸºå› 
                geneSlots: 6, // åˆå§‹è§£é” 6 ä¸ªæ§½ä½ (æœ€é«˜ç¨€æœ‰åº¦)
                totalRaces: 0
            }],
            seasonWins: 0
        };

        function generateAIHorse(i) {
            return {
                id: 'ai_'+i, name: 'AI-'+i, color: ['#fff','#ccc','#888'][i%3],
                // ä¸‹è°ƒ AI åŸºç¡€é€Ÿåº¦ï¼Œé¿å…æ— åŸºå›  AI è¿‡å¿«
                baseSpeed: 55 + Math.random()*5, accel: 0.5, lifespan: 50
            };
        }

        // --- ç§»æ¤ BreedingSystem.ts (ç®€åŒ–ç‰ˆ) ---
        const BreedingSystem = {
            breedHorse(p1, p2) {
                const name = p1.name[0] + p2.name[p2.name.length-1] + 'é©¹';
                const ladder = ['æ™®é€š','ä¸­çº§','é«˜çº§','ç¨€æœ‰'];
                const quality = ladder[Math.floor(Math.random() * ladder.length)];
                const slotsMap = { 'æ™®é€š': 3, 'ä¸­çº§': 4, 'é«˜çº§': 5, 'ç¨€æœ‰': 6 };
                const geneSlots = slotsMap[quality] || 3;
                
                const allTypes = Object.values(GeneType);
                const poolCount = Math.max(1, Math.min(6, Math.floor(Math.random() * 6) + 1));
                const shuffled = [...allTypes].sort(() => 0.5 - Math.random());
                const chosen = shuffled.slice(0, poolCount);
                const rareIndex = Math.floor(Math.random() * chosen.length);
                let genes = chosen.map((t, idx) => ({ type: t, quality: idx === rareIndex ? 'ç¨€æœ‰' : 'æ™®é€š' }));
                
                // ä»çˆ¶çº§ä¿ç•™ä¸€ä¸ªæœ€é«˜ç¨€æœ‰åº¦æŠ€èƒ½
                const parentGenes = ([]).concat(p1.genes || [], p2.genes || []);
                if (parentGenes.length > 0) {
                    const rank = { 'æ™®é€š': 0, 'ä¸­çº§': 1, 'é«˜çº§': 2, 'ç¨€æœ‰': 3 };
                    const maxRank = parentGenes.reduce((m, g) => Math.max(m, rank[g.quality] ?? 0), 0);
                    const topGenes = parentGenes.filter(g => (rank[g.quality] ?? 0) === maxRank);
                    const keep = topGenes[Math.floor(Math.random() * topGenes.length)];
                    if (keep) {
                        const idx = genes.findIndex(g => g.type === keep.type);
                        if (idx !== -1) {
                            // å‡çº§ä¸ºçˆ¶çº§çš„æœ€é«˜ç¨€æœ‰åº¦
                            const rr = { 'æ™®é€š': 0, 'ä¸­çº§': 1, 'é«˜çº§': 2, 'ç¨€æœ‰': 3 };
                            if ((rr[genes[idx].quality] ?? 0) < (rr[keep.quality] ?? 0)) {
                                genes[idx].quality = keep.quality;
                            }
                        } else {
                            // å°†çˆ¶çº§æŠ€èƒ½åŠ å…¥ï¼Œå¹¶ä¿è¯æ€»æ•°ä¸è¶…è¿‡6
                            genes.unshift({ type: keep.type, quality: keep.quality });
                            // å»é‡å¹¶æˆªæ–­åˆ°æœ€å¤š6ä¸ª
                            const uniq = new Map();
                            genes.forEach(g => { if (!uniq.has(g.type)) uniq.set(g.type, g); });
                            genes = Array.from(uniq.values()).slice(0, 6);
                        }
                    }
                }
                
                return {
                    id: 'bred_'+Date.now(), name,
                    color: p1.color, quality,
                    baseSpeed: (p1.baseSpeed + p2.baseSpeed)/2 * 1.05,
                    stamina: 60, accel: 0.8, temper: 0.5,
                    lifespan: 50, maxLifespan: 50, genes, geneSlots, totalRaces: 0
                };
            },
            
            reforgeSkills(horse) {
                if (!horse.genes || horse.genes.length === 0) return null;
                
                const count = horse.genes.length;
                const newGenes = [];
                const allTypes = Object.values(GeneType);
                // æ´—ç‰Œ
                const shuffled = [...allTypes].sort(() => 0.5 - Math.random());
                
                for(let i=0; i<count; i++) {
                    if (i >= shuffled.length) break;
                    const type = shuffled[i];
                    const quality = Math.random() < 0.1 ? 'ç¨€æœ‰' : 'æ™®é€š';
                    newGenes.push({ type, quality });
                }
                return newGenes;
            }
        };

        // --- ç®€æ˜“æ¸¸æˆå¼•æ“ ---
        class Game {
            constructor() {
                this.player = JSON.parse(JSON.stringify(InitialPlayer));
                this.selectedHorseId = this.player.horses[0].id; // é»˜è®¤é€‰ä¸­ç¬¬ä¸€åŒ¹
                this.horses = [];
                this.racing = false;
                this.stableCap = 5;
                
                // åˆå§‹åŒ–å®¿æ•Œæ±  (4åŒ¹å›ºå®šå¯¹æ‰‹ï¼Œå‡å°‘æ•°é‡ä»¥ä¼˜åŒ–æ˜¾ç¤º)
                this.rivals = Array.from({length: 4}, (_, i) => generateAIHorse(i));
                
                this.updateUI();
                
                // ä¸´æ—¶å˜é‡
                this.tempReforgeGenes = null;
            }
            
            skillEffects() {
                return {
                    'ç–¾é£': 'æé«˜ç§»åŠ¨é€Ÿåº¦ï¼ŒæŒç»­åŠ æˆï¼ˆ+8%ï¼‰ï¼Œé€‚åˆç›´çº¿å†²åˆºã€‚',
                    'çˆ†å†²': 'çŸ­æ—¶é—´çˆ†å‘é€Ÿåº¦ï¼ˆ+15%ï¼‰ï¼Œç”¨äºå…³é”®æ—¶åˆ»è¶…è½¦ã€‚',
                    'åšéŸ§': 'æå‡è€åŠ›ä¸é•¿è·ç¦»è¡¨ç°ï¼ˆ+6%ï¼‰ï¼Œåç¨‹ç¨³å®šè¾“å‡ºã€‚',
                    'ç¨³å¥': 'æå‡ç¨³å®šä¸å°å¹…é€Ÿåº¦ï¼ˆ+5%ï¼‰ï¼Œå‡å°‘æ³¢åŠ¨ä¸å¤±è¯¯ã€‚',
                    'çµæ´»': 'æå‡åŠ é€Ÿä¸çµæ•ï¼ˆ+5%ï¼‰ï¼Œæ›´å¿«è¿›å…¥æœ€ä½³é€Ÿåº¦åŒºé—´ã€‚',
                    'ç¥é€Ÿ': 'æ˜¾è‘—æå‡æœ€é«˜é€Ÿåº¦ï¼Œç¬é—´æé€Ÿæ•ˆæœæ›´å¼ºã€‚',
                    'é£é©°': 'æŒç»­å°å¹…é€Ÿåº¦æå‡ï¼Œç¨³æ­¥æ‹‰å¼€å·®è·ã€‚',
                    'æŒä¹…': 'è€åŠ›å¼ºåŒ–ï¼Œé•¿æ—¶é—´ä¿æŒé«˜æ•ˆå¥”è·‘ã€‚',
                    'å›æ˜¥': 'èµ›ä¸­è€åŠ›æ¢å¤ï¼Œç¼“è§£ç–²åŠ³ã€‚',
                    'é“å¿—': 'æ„å¿—åŠ æˆï¼Œé™ä½èµ›ä¸­æŠ–åŠ¨ä¸é€Ÿåº¦æ³¢åŠ¨ã€‚',
                    'æ·±æ¯': 'é•¿è·ç¦»ä¼˜åŠ¿ï¼Œè¶Šè·‘è¶Šç¨³ã€‚',
                    'å†·é™': 'æŠ—å¹²æ‰°ï¼Œå‡å°‘å¤–éƒ¨å› ç´ é€ æˆçš„å‡é€Ÿã€‚',
                    'ä¸“æ³¨': 'èŠ‚å¥æŒæ§ï¼Œåœ¨å…³é”®åŒºæ®µä¿æŒè¾“å‡ºã€‚',
                    'å¦‚å±±': 'å¼ºç¨³å®šæ€§ï¼Œéš¾ä»¥è¢«æ‰°åŠ¨å½±å“ã€‚',
                    'å¹³è¡¡': 'å‡è¡¡å‹å¢ç›Šï¼Œé€Ÿåº¦ä¸ç¨³å®šå°å¹…æå‡ã€‚',
                    'æ··è¡€': 'ç»¼åˆæ€§åŠ æˆï¼Œå„é¡¹å±æ€§å°å¹…æå‡ã€‚',
                    'å¤§å™¨': 'åç¨‹çˆ†å‘ï¼Œæœ€åé˜¶æ®µèƒ½åŠ›æå‡ã€‚',
                    'å…ˆé”‹': 'å¼€å±€å¼ºåŠ¿ï¼Œèµ·æ­¥æ›´å¿«æ›´ç¨³ã€‚',
                    'é£˜ç§»': 'å¼¯é“æ§åˆ¶æå‡ï¼Œè¿‡å¼¯é€Ÿåº¦æŸè€—æ›´ä½ã€‚',
                    'å¡é“': 'å¡é“ä¼˜åŠ¿ï¼Œå¡æ®µé€Ÿåº¦æŸè€—é™ä½ã€‚',
                    'å¤©å‘½': 'ç¥å…½ä¸“å±ï¼Œå…¨é¢å¼ºåŠ›å¢ç›Šã€‚',
                    'å¥‡è¿¹': 'ç»å¢ƒç¿»ç›˜ï¼Œè½åæ—¶è·å¾—é¢å¤–å¢ç›Šã€‚',
                    'æ®‹å½±': 'äº§ç”Ÿè™šå½±ï¼Œå‡å°‘å¯¹æ‰‹å¹²æ‰°åˆ¤å®šã€‚',
                    'æµæ˜Ÿ': 'ç»ˆç›˜æé€Ÿï¼Œå†²çº¿å‰æœ€ååŠ é€Ÿã€‚',
                    'ä¼ è¯´': 'å…¨å±æ€§æå‡ï¼Œå¤§å¹…å¢å¼ºç»¼åˆèƒ½åŠ›ã€‚'
                };
            }
            
            showSkillDetail(type) {
                const titleEl = document.getElementById('skill-title');
                const descEl = document.getElementById('skill-desc');
                const modal = document.getElementById('skill-modal');
                const eff = this.skillEffects()[type] || 'æš‚æ— è¯¥æŠ€èƒ½çš„è¯¦ç»†è¯´æ˜';
                titleEl.innerText = `æŠ€èƒ½ï¼š${type}`;
                descEl.innerText = eff;
                modal.style.display = 'flex';
            }
            
            closeSkillModal() {
                const modal = document.getElementById('skill-modal');
                modal.style.display = 'none';
            }
            
            // è®¡ç®—é€Ÿåº¦ï¼šåŸºäº activeGenes
             computeSpeedWithGenes(baseSpeed, genes) {
                 let m = 1.0;
                 genes.forEach(g => {
                     const t = g.type;
                    if (t === 'ç–¾é£') m += 0.08;
                    else if (t === 'çˆ†å†²') m += 0.15;
                    else if (t === 'åšéŸ§') m += 0.06;
                    else if (t === 'çµæ´»') m += 0.05;
                    else if (t === 'ç¨³å¥') m += 0.05;
                    else m += 0.03; // å…¶ä»–æŠ€èƒ½ä¹Ÿæœ‰å¾®é‡åŠ æˆ
                });
                
                // ç¨€æœ‰æŠ€èƒ½é¢å¤–åŠ æˆ
                genes.forEach(g => {
                    if (g.quality === 'ç¨€æœ‰') m += 0.02;
                });

                if (genes.length === 0) m *= 0.98; 
                const jitter = 1 + (Math.random() * 0.04 - 0.02); 
                 return baseSpeed * m * jitter;
             }
            
            slotCountForHorse(h) {
                const q = h.quality;
                if (q === 'ç¨€æœ‰') return 6;
                if (q === 'é«˜çº§') return 5;
                if (q === 'ä¸­çº§') return 4;
                if (q === 'æ™®é€š') return 3;
                return h.geneSlots || 6;
            }
            
            pickStartGenes(pool, slots) {
                if (!Array.isArray(pool) || pool.length === 0) return [];
                if (pool.length <= slots) return [...pool];
                const shuffled = [...pool].sort(() => 0.5 - Math.random());
                return shuffled.slice(0, slots);
            }
            
            ensureLockedStartGenes(h) {
                const slots = this.slotCountForHorse(h);
                const pool = Array.isArray(h.genes) ? h.genes : [];
                let locked = Array.isArray(h.lockedStartGenes) ? h.lockedStartGenes.slice(0) : [];
                const map = new Map();
                locked.forEach(g => { if (!map.has(g.type)) map.set(g.type, g); });
                let arr = Array.from(map.values());
                if (arr.length > slots) arr = arr.slice(0, slots);
                if (arr.length < slots) {
                    const remain = pool.filter(g => !arr.some(a => a.type === g.type));
                    const shuffled = [...remain].sort(() => 0.5 - Math.random());
                    arr = arr.concat(shuffled.slice(0, slots - arr.length));
                }
                h.lockedStartGenes = arr;
            }

             createNameTag(h) {
                  const nameTag = document.createElement('div');
                  
                  // ç»„è£…æ˜¾ç¤ºå†…å®¹ï¼šåå­— + åŸºå› æ ‡ç­¾ (åªæ˜¾ç¤º activeGenes)
                 let geneHtml = '';
                 if (h.activeGenes && h.activeGenes.length > 0) {
                    geneHtml = h.activeGenes.map(g => 
                        `<span style="background:${g.quality==='æ™®é€š'?'#bdc3c7':'#f1c40f'}; color:#000; padding:1px 2px; border-radius:2px; margin-left:2px; font-size:7px;">${g.type}</span>`
                    ).join('');
                 }
                 // ç§»é™¤ä¹‹å‰çš„é»˜è®¤éšæœºæ˜¾ç¤ºï¼Œä¿æŒæ¸…çˆ½

                 nameTag.innerHTML = `${h.data.name}<br>${geneHtml}`;
                 
                 nameTag.style.transform = 'translate(-50%, -100%)'; 
                 nameTag.style.width = 'auto'; 
                 nameTag.style.textAlign = 'center';
                 nameTag.style.position = 'absolute';
                 nameTag.style.fontSize = '9px';
                 nameTag.style.lineHeight = '11px';
                 nameTag.style.whiteSpace = 'nowrap';
                 nameTag.style.zIndex = '101'; 
                 nameTag.style.background = 'rgba(0,0,0,0.45)';
                 nameTag.style.color = '#ecf0f1';
                 nameTag.style.padding = '3px 6px';
                 nameTag.style.borderRadius = '4px';
                 nameTag.style.border = '1px solid rgba(255,255,255,0.15)';
                 nameTag.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
                 
                 document.getElementById('ui-layer').appendChild(nameTag);
                 h.nameTag = nameTag;
            }

             // æ—§æ–¹æ³•ä¿ç•™å…¼å®¹ (æˆ–åˆ é™¤)
             computeFinalSpeed(data) { return this.computeSpeedWithGenes(data.baseSpeed, data.genes || []); }

            selectHorse(id) {
                this.selectedHorseId = id;
                this.updateUI();
            }
            
            prevHorse() {
                if (this.racing) return;
                const list = this.player.horses;
                const idx = list.findIndex(h => h.id === this.selectedHorseId);
                const ni = (idx > 0 ? idx - 1 : list.length - 1);
                this.selectedHorseId = list[ni].id;
                this.updateUI();
            }
            
            nextHorse() {
                if (this.racing) return;
                const list = this.player.horses;
                const idx = list.findIndex(h => h.id === this.selectedHorseId);
                const ni = (idx < list.length - 1 ? idx + 1 : 0);
                this.selectedHorseId = list[ni].id;
                this.updateUI();
            }
            
            scrollSelectedIntoView() {
                const infoPanel = document.getElementById('info-panel');
                const container = infoPanel.querySelector('.stable-container');
                if (!container) return;
                const card = infoPanel.querySelector('.horse-card.selected');
                if (!card) return;
                const center = card.offsetLeft + (card.offsetWidth / 2);
                const target = center - (container.clientWidth / 2);
                container.scrollTo({ left: target, behavior: 'smooth' });
            }

            updateUI() {
                const p = this.player;
                const infoPanel = document.getElementById('info-panel');
                
                // ä¿ç•™æ¯”èµ›ä¸­é©¬å©æ»šåŠ¨ä½ç½®ï¼Œé˜²æ­¢åˆ·æ–°å¯¼è‡´å¡ç‰‡è·³åŠ¨
                let prevScrollLeft = null;
                const prevContainer = infoPanel.querySelector('.stable-container');
                if (prevContainer) prevScrollLeft = prevContainer.scrollLeft;
                
                // æ¸…é™¤å¯¿å‘½ä¸º0çš„é©¬
                const before = p.horses.length;
                p.horses = p.horses.filter(h => (h.lifespan == null ? true : h.lifespan > 0));
                if (p.horses.length === 0) {
                    // ä¿åº•ï¼šå¦‚æœæ¸…ç©ºäº†ï¼Œæ¢å¤åˆå§‹ç¬¬ä¸€åŒ¹ä»¥é¿å…UIç©ºç™½
                    p.horses = JSON.parse(JSON.stringify(InitialPlayer.horses));
                }
                // ä¿è¯é€‰ä¸­IDæœ‰æ•ˆ
                if (!p.horses.find(h => h.id === this.selectedHorseId)) {
                    this.selectedHorseId = p.horses[0].id;
                }
                
                // 1. ç”Ÿæˆèµ„äº§è¡Œ
                let html = `
                    <div class="asset-row">
                        <span>ğŸ’° ç§¯åˆ†: ${p.integral}</span>
                        <span>ğŸ« é—¨ç¥¨: ${p.ticketsNormal}</span>
                    </div>
                    <div class="stable-container">
                `;

                // 2. ç”Ÿæˆé©¬åŒ¹å¡ç‰‡
                p.horses.slice(0, this.stableCap).forEach(h => {
                    this.ensureLockedStartGenes(h);
                    let genesHtml = '';
                    
                    // è·å–æ‰€æœ‰æŠ€èƒ½ç±»å‹ï¼Œç”¨äºå±•ç¤ºæŠ€èƒ½æ± ï¼Œå¹¶é«˜äº®æ¯”èµ›ä½¿ç”¨æŠ€èƒ½
                    const allTypes = Object.values(GeneType);
                    const slots = this.slotCountForHorse(h);
                    this.ensureLockedStartGenes(h);
                    const previewActives = (h.lockedStartGenes || []).slice(0, slots);
                    const activeSet = new Set((previewActives || []).map(g => g.type));
                    const rawLearned = ([]).concat(h.learnedThisRace || [], (h.data && h.data.learnedThisRace) ? h.data.learnedThisRace : []);
                    const learnedSet = new Set(rawLearned.filter(t => !activeSet.has(t)));
                    
                    genesHtml = allTypes.map(type => {
                        const owned = h.genes && h.genes.find(g => g.type === type);
                        if (owned) {
                            const cls = owned.quality === 'ç¨€æœ‰' ? 'gene-rare' : 'gene-normal';
                            const activeCls = activeSet.has(type) ? ' gene-active' : '';
                            const learnedCls = learnedSet.has(type) ? ' gene-just' : '';
                            return `<span class="gene-tag ${cls}${activeCls}${learnedCls}" onclick="game.showSkillDetail('${type}')">${type}</span>`;
                        } else {
                            return `<span class="gene-tag gene-locked" onclick="game.showSkillDetail('${type}')">${type}</span>`;
                        }
                    }).join('');

                    
                    const isSelected = h.id === this.selectedHorseId;
                    const selectedClass = isSelected ? 'selected' : '';
                    
                    html += `
                        <div class="horse-card ${selectedClass}" onclick="game.selectHorse('${h.id}')">
                            <div class="name" style="color:${h.color}">${h.name}</div>
                            <div class="life">å¯¿å‘½: ${h.lifespan}/${h.maxLifespan}</div>
                            <div class="gene-tags">${genesHtml}</div>
                        </div>
                    `;
                });

                html += `</div>`; // é—­åˆ stable-container
                infoPanel.innerHTML = html;
                
                // æ¯”èµ›ä¸­æ¢å¤æ»šåŠ¨ä½ç½®
                const newContainer = infoPanel.querySelector('.stable-container');
                if (this.racing && newContainer && prevScrollLeft !== null) {
                    newContainer.scrollLeft = prevScrollLeft;
                }
                
                // æ»‘åŠ¨æ‰‹åŠ¿
                const container = infoPanel.querySelector('.stable-container');
                if (container) {
                    container.style.overflowX = this.racing ? 'hidden' : 'auto';
                    let startX = 0, deltaX = 0, touching = false;
                    const onStart = (x) => { startX = x; deltaX = 0; touching = true; };
                    const onMove = (x) => { if (touching) deltaX = x - startX; };
                    const onEnd = () => {
                        if (!touching) return;
                        touching = false;
                        if (this.racing) return;
                        if (Math.abs(deltaX) > 40) {
                            if (deltaX < 0) this.nextHorse(); else this.prevHorse();
                        }
                    };
                    container.addEventListener('touchstart', e => onStart(e.touches[0].clientX), {passive:true});
                    container.addEventListener('touchmove', e => onMove(e.touches[0].clientX), {passive:true});
                    container.addEventListener('touchend', onEnd);
                    container.addEventListener('mousedown', e => onStart(e.clientX));
                    container.addEventListener('mousemove', e => onMove(e.clientX));
                    container.addEventListener('mouseup', onEnd);
                    container.addEventListener('mouseleave', onEnd);
                }
                
                // æ»šåŠ¨ä½¿é€‰ä¸­é¡¹å±…ä¸­
                if (!this.racing) this.scrollSelectedIntoView();
            }

            openBreed() {
                document.getElementById('breed-panel').style.display = 'flex';
                document.getElementById('breed-result').innerText = '';
            }

            closeBreed() {
                document.getElementById('breed-panel').style.display = 'none';
            }

            confirmBreed() {
                // é©¬å©å®¹é‡é™åˆ¶
                const aliveCount = this.player.horses.filter(h => (h.lifespan == null ? true : h.lifespan > 0)).length;
                if (aliveCount >= this.stableCap) {
                    alert("é©¬å©å·²æ»¡ (ä¸Šé™5åŒ¹)ã€‚è¯·å…ˆæ¸…ç†å¯¿å‘½ä¸º0çš„é©¬æˆ–å¼ƒç½®åå†åŸ¹è‚²ã€‚");
                    return;
                }
                if (this.player.integral < 500) {
                    alert("ç§¯åˆ†ä¸è¶³ (éœ€è¦500)ï¼å…ˆå»æ¯”èµ›èµ¢ç‚¹åˆ†å§ã€‚");
                    return;
                }
                
                // ä½¿ç”¨å½“å‰é€‰ä¸­çš„é©¬ä½œä¸ºçˆ¶æœ¬
                const parent1 = this.player.horses.find(h => h.id === this.selectedHorseId);
                if (!parent1) {
                    alert("è¯·å…ˆé€‰æ‹©ä¸€åŒ¹é©¬ï¼");
                    return;
                }

                this.player.integral -= 500;
                const parent2 = generateAIHorse(999);
                const foal = BreedingSystem.breedHorse(parent1, parent2);
                this.player.horses.push(foal);
                
                // è‡ªåŠ¨é€‰ä¸­æ–°é©¬
                this.selectedHorseId = foal.id;
                
                document.getElementById('breed-result').innerText = `åŸ¹è‚²æˆåŠŸï¼è·å¾—æ–°é©¬ï¼š${foal.name}`;
                this.updateUI();
            }

            openReforge() {
                const horse = this.player.horses.find(h => h.id === this.selectedHorseId);
                if (!horse || !horse.genes || horse.genes.length === 0) {
                    alert("è¯¥é©¬åŒ¹æ²¡æœ‰æŠ€èƒ½ï¼Œæ— æ³•æ´—ç»ƒï¼");
                    return;
                }
                
                document.getElementById('reforge-panel').style.display = 'flex';
                this.tempReforgeGenes = null;
                this.tempReforgeQuality = horse.quality;
                
                // æ¸²æŸ“å½“å‰æŠ€èƒ½
                const currentSlots = this.slotCountForHorse(horse);
                const currentLocked = Array.isArray(horse.lockedStartGenes) && horse.lockedStartGenes.length > 0
                    ? horse.lockedStartGenes.slice(0, currentSlots)
                    : this.pickStartGenes(horse.genes, currentSlots);
                this.renderReforgeGenes(currentLocked, 'reforge-current-genes', currentLocked);
                // æ¸…ç©ºæ–°æŠ€èƒ½é¢„è§ˆ
                document.getElementById('reforge-new-genes').innerHTML = 
                    `<div style="grid-column:1/-1; text-align:center; color:#7f8c8d; margin-top:40px;">ç‚¹å‡»æ´—ç»ƒç”Ÿæˆ</div>`;
                
                // æŒ‰é’®çŠ¶æ€
                document.getElementById('btn-do-reforge').style.display = 'block';
                document.getElementById('btn-save-reforge').style.display = 'none';
                const discardBtn = document.getElementById('btn-discard-reforge');
                if (discardBtn) discardBtn.style.display = 'none';
            }

            closeReforge() {
                document.getElementById('reforge-panel').style.display = 'none';
                this.tempReforgeGenes = null;
                this.tempReforgeQuality = null;
            }

            renderReforgeGenes(genes, containerId, actives = []) {
                const container = document.getElementById(containerId);
                if (!genes) {
                    container.innerHTML = '';
                    return;
                }
                const activeSet = new Set((actives || []).map(a => a.type));
                container.innerHTML = genes.map(g => {
                     const cls = g.quality === 'ç¨€æœ‰' ? 'gene-rare' : 'gene-normal';
                     const activeCls = activeSet.has(g.type) ? ' gene-active' : '';
                     return `<span class="gene-tag ${cls}${activeCls}" style="font-size:7px;">${g.type}</span>`;
                }).join('');
            }

            doReforge() {
                if (this.player.integral < 1) {
                    alert("ç§¯åˆ†ä¸è¶³ (éœ€è¦1000)ï¼");
                    return;
                }
                
                const horse = this.player.horses.find(h => h.id === this.selectedHorseId);
                // æ‰£è´¹
                this.player.integral -= 1;
                this.updateUI(); // åˆ·æ–°ç§¯åˆ†æ˜¾ç¤º
                
                // æ¦‚ç‡æå‡ç¨€æœ‰ç­‰çº§ï¼šæ™®é€š->ä¸­çº§->é«˜çº§->ç¨€æœ‰
                const ladder = ['æ™®é€š','ä¸­çº§','é«˜çº§','ç¨€æœ‰'];
                let q = horse.quality;
                const idx = ladder.indexOf(q);
                if (idx !== -1 && idx < ladder.length - 1) {
                    if (Math.random() < 0.3) { // 30% å‡ä¸€çº§
                        q = ladder[idx + 1];
                    }
                }
                this.tempReforgeQuality = q;
                
                // æ ¹æ®æ–°ç­‰çº§çš„æ§½ä½ï¼Œé”å®šæ¯”èµ›åˆå§‹æŠ€èƒ½ï¼ˆä¸æ”¹å˜æŠ€èƒ½æ± ï¼‰
                const slots = this.slotCountForHorse({ quality: q, geneSlots: horse.geneSlots });
                this.tempReforgeGenes = this.pickStartGenes(horse.genes, slots);
                
                // æ¸²æŸ“æ–°æŠ€èƒ½
                this.renderReforgeGenes(this.tempReforgeGenes, 'reforge-new-genes', this.tempReforgeGenes);
                // åœ¨æ–°é¢„è§ˆåŒºé¡¶éƒ¨æ˜¾ç¤ºæ–°ç­‰çº§
                const newBox = document.getElementById('reforge-new-genes');
                const badge = document.createElement('div');
                badge.style.gridColumn = '1/-1';
                badge.style.textAlign = 'center';
                badge.style.color = '#f1c40f';
                badge.style.fontSize = '12px';
                badge.style.marginBottom = '6px';
                badge.innerText = `æ–°ç¨€æœ‰ç­‰çº§: ${this.tempReforgeQuality}`;
                newBox.prepend(badge);
                
                // åˆ‡æ¢æŒ‰é’®
                document.getElementById('btn-do-reforge').style.display = 'none';
                document.getElementById('btn-save-reforge').style.display = 'block';
                const discardBtn = document.getElementById('btn-discard-reforge');
                if (discardBtn) discardBtn.style.display = 'block';
            }
            
            saveReforge() {
                if (!this.tempReforgeGenes) return;
                
                const horse = this.player.horses.find(h => h.id === this.selectedHorseId);
                horse.lockedStartGenes = this.tempReforgeGenes;
                if (this.tempReforgeQuality) {
                    horse.quality = this.tempReforgeQuality;
                    // åŒæ­¥ geneSlots å¯é€‰ï¼ˆä¿æŒå…¼å®¹ï¼‰
                    horse.geneSlots = this.slotCountForHorse(horse);
                }
                this.ensureLockedStartGenes(horse);
                alert("ä¿å­˜æˆåŠŸï¼");
                this.closeReforge();
                this.updateUI();
            }
            
            discardReforge() {
                // æ”¾å¼ƒæ´—ç»ƒï¼šæ¸…ç©ºé¢„è§ˆï¼Œæ¢å¤æŒ‰é’®
                this.tempReforgeGenes = null;
                const preview = document.getElementById('reforge-new-genes');
                if (preview) {
                    preview.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#7f8c8d; margin-top:40px;">ç‚¹å‡»æ´—ç»ƒç”Ÿæˆ</div>`;
                }
                document.getElementById('btn-do-reforge').style.display = 'block';
                document.getElementById('btn-save-reforge').style.display = 'none';
                const discardBtn = document.getElementById('btn-discard-reforge');
                if (discardBtn) discardBtn.style.display = 'none';
            }

            startRace() {
                if (this.player.ticketsNormal < 1) {
                    alert("é—¨ç¥¨ä¸è¶³ï¼");
                    return;
                }
                
                // ä½¿ç”¨å½“å‰é€‰ä¸­çš„é©¬å‚èµ›
                const myHorse = this.player.horses.find(h => h.id === this.selectedHorseId);
                
                if (myHorse.lifespan <= 0) {
                    alert("å½“å‰é€‰ä¸­çš„é©¬åŒ¹å¯¿å‘½å·²å°½ï¼è¯·é€‰æ‹©å…¶ä»–é©¬åŒ¹ã€‚");
                    return;
                }

                this.player.ticketsNormal--;
                myHorse.lifespan--;
                this.updateUI();

                document.getElementById('lobby-panel').style.display = 'none';
                document.getElementById('status-label').style.display = 'none';

                // ç”Ÿæˆé©¬åŒ¹ï¼šä½¿ç”¨å®¿æ•Œæ± ä¸­çš„é©¬åŒ¹
                this.horses = [];
                
                // ç®€å•çš„æ´—ç‰Œå®¿æ•Œï¼Œæˆ–è€…ç›´æ¥å…¨éƒ¨ä¸Šåœº (å¦‚æœæ˜¯5åŒ¹çš„è¯)
                // è¿™é‡Œæˆ‘ä»¬ç›´æ¥ç”¨å›ºå®šçš„5åŒ¹å®¿æ•Œä½œä¸ºå¯¹æ‰‹
                const rivals = this.rivals;
                
                const raceData = [myHorse, ...rivals];
                
                const track = document.getElementById('track-layer'); // ä¿®å¤ï¼šé‡æ–°å®šä¹‰ track å˜é‡
                
                // æ·»åŠ è·‘é“åˆ†éš”çº¿ (æ¨ªå‘)
                track.innerHTML = '';
                // è·‘é“æ€»é«˜åº¦çº¦ 667 - 250 = 417px
                // 5æ¡è·‘é“ï¼Œæ¯æ¡çº¦ 80px
                
                // åˆå§‹åŒ–é©¬åŒ¹æ¯”èµ›æ•°æ®
                 raceData.forEach((data, i) => {
                     this.ensureLockedStartGenes(data);
                     const el = document.createElement('div');
                     el.className = 'horse';
                    el.style.top = (i * 80 + 10) + 'px'; 
                    el.style.left = '50px';
                    track.appendChild(el);
                     
                     // æ¯”èµ›åˆå§‹æŠ€èƒ½ï¼šæ ¹æ®ç¨€æœ‰ç­‰çº§çš„æ§½ä½æ•°ï¼Œä»æŠ€èƒ½æ± é”å®š
                     // æ¸…ç©ºå½“å±€çš„â€œæ–°é¢†æ‚Ÿâ€æ ‡è®°
                     data.learnedThisRace = [];
                     const slots = this.slotCountForHorse(data);
                     const activeGenes = (data.lockedStartGenes || []).slice(0, slots);
                     data.activeGenes = activeGenes;

                     this.horses.push({ 
                         el, 
                         nameTag: null, 
                         data, // å¼•ç”¨åŸå§‹æ•°æ® (ç”¨äºèµ›åä¿å­˜)
                         activeGenes, // å½“å±€ç”Ÿæ•ˆçš„æŠ€èƒ½ (6ä¸ªåŸºç¡€ + 1ä¸ªé¢†æ‚Ÿ)
                         distance: 0, 
                         // ä½¿ç”¨ activeGenes è®¡ç®—åˆå§‹é€Ÿåº¦
                         speed: this.computeSpeedWithGenes(data.baseSpeed, activeGenes), 
                         frameIndex: 1, 
                        frameTimer: 0,
                        baseTop: (i * 80 + 10),
                        _learned: false, 
                        boostTimer: 0
                     });
                 });

                // ç”Ÿæˆåç‰Œ
                this.horses.forEach(h => {
                     this.createNameTag(h);
                });

                // é‡ç½®è·‘é“ä½ç½®
                track.style.left = '0px'; // æ¨ªå‘é‡ç½®
                track.style.top = '0px';

                this.racing = true;
                requestAnimationFrame(this.loop.bind(this));
            }

            spawnGhost(h) {
                const track = document.getElementById('track-layer');
                const ghost = document.createElement('div');
                ghost.className = 'horse-ghost';
                ghost.style.top = h.baseTop + 'px';
                ghost.style.left = (50 + h.distance - 20) + 'px';
                ghost.style.backgroundImage = h.el.style.backgroundImage;
                track.appendChild(ghost);
                let op = 0.35, dx = 0;
                const anim = () => {
                    dx += 1.5;
                    op -= 0.03;
                    ghost.style.transform = `scaleX(-1) translateX(-${dx}px)`;
                    ghost.style.opacity = String(op);
                    if (op > 0) requestAnimationFrame(anim);
                    else if (ghost.parentNode) ghost.parentNode.removeChild(ghost);
                };
                requestAnimationFrame(anim);
            }

            loop() {
                if (!this.racing) return;

                let finishedCount = 0;
                let playerHorse = this.horses[0];
                const uiLayer = document.getElementById('ui-layer');
                
                this.horses.forEach(h => {
                    // æ›´æ–°åŠ¨ç”»å¸§
                    h.frameTimer++;
                    if (h.frameTimer > 3) { 
                        h.frameIndex++;
                        if (h.frameIndex > 20) h.frameIndex = 1; 
                        h.frameTimer = 0;
                        h.el.style.backgroundImage = `url('assets/sprites/horse_run/${h.frameIndex}_horesrun.png')`;
                        if (h.boostTimer && h.boostTimer > 0) this.spawnGhost(h);
                    }

                    if (h.distance < 2000) { 
                        h.distance += h.speed * 0.05; 
                        h.el.style.left = (50 + h.distance) + 'px'; // æ¨ªå‘ç§»åŠ¨
                    } else {
                        finishedCount++;
                    }

                    // èµ›ä¸­é¢†æ‚Ÿé€»è¾‘ï¼šæ‰€æœ‰é©¬åŒ¹éƒ½æœ‰æœºä¼š
                    if (!h._learned && h.distance > 600) {
                        h._learned = true;
                        
                        // ç©å®¶å¿…è§¦å‘ï¼ŒAI 30% æ¦‚ç‡è§¦å‘
                        const isPlayer = (h === playerHorse);
                        const shouldTrigger = isPlayer || (Math.random() < 0.3);

                        if (shouldTrigger) {
                             // è®¡ç®—å¯é¢†æ‚Ÿçš„éé‡å¤æŠ€èƒ½ OR å¯å‡çº§çš„ç¨€æœ‰æŠ€èƒ½
                            const existing = Array.isArray(h.data.genes) ? h.data.genes : [];
                            const allTypes = Object.values(GeneType);
                            const isRare = Math.random() < 0.1; // 10% æ¦‚ç‡ç¨€æœ‰
                            
                            // å€™é€‰åˆ—è¡¨ (å…¨æŠ€èƒ½æ± )
                            const candidates = allTypes.filter(t => {
                                // æ’é™¤å½“å±€å·²ç»æ‹¥æœ‰çš„æŠ€èƒ½ (é¿å…é‡å¤é¢†æ‚Ÿ)
                                const existGene = h.activeGenes.find(g => g.type === t);
                                if (!existGene) return true; // æœªæ‹¥æœ‰
                                if (isRare && existGene.quality === 'æ™®é€š') return true; // å¯å‡çº§
                                return false;
                            });

                            // åªè¦æ²¡å­¦è¿‡ï¼Œå°±èƒ½å­¦
                            if (candidates.length > 0) {
                                let type = null;
                                let isUpgrade = false;
                                
                                type = candidates[Math.floor(Math.random() * candidates.length)];
                                const exist = h.activeGenes.find(g => g.type === type);
                                if (exist) isUpgrade = true;

                                if (type) {
                                    const quality = isRare ? 'ç¨€æœ‰' : 'æ™®é€š';
                                    const newGene = { type, quality };
                                    const slots = this.slotCountForHorse(h.data);
                                    if (isUpgrade) {
                                        const upgradeIdx = h.activeGenes.findIndex(g => g.type === type);
                                        if (upgradeIdx !== -1) h.activeGenes[upgradeIdx] = newGene;
                                    } else {
                                        const limit = slots + 1; // é€‰ä¸­æŠ€èƒ½ + 1ä¸ªæ–°é¢†æ‚Ÿ
                                        const existsActive = h.activeGenes.some(g => g.type === type);
                                        if (!existsActive && h.activeGenes.length < limit) h.activeGenes.push(newGene);
                                    }
                                    
                                    // åŒæ—¶ä¹Ÿå†™å…¥ data.genes (æ°¸ä¹…ä¿å­˜ï¼Œæ»¡è¶³æ”¶é›†éœ€æ±‚)
                                    // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦å†æ¬¡æ£€æŸ¥ data.genes é‡Œæ˜¯å¦å·²æœ‰ï¼Œå› ä¸º activeGenes æ˜¯å­é›†
                                    if (!h.data.genes) h.data.genes = [];
                                    const permIdx = h.data.genes.findIndex(g => g.type === type);
                                    if (permIdx !== -1) {
                                        // å¦‚æœæ°¸ä¹…æ± é‡Œå·²æœ‰ï¼Œçœ‹æ˜¯å¦éœ€è¦å‡çº§
                                        if (h.data.genes[permIdx].quality === 'æ™®é€š' && isRare) {
                                            h.data.genes[permIdx] = newGene;
                                        }
                                    } else {
                                        // æ°¸ä¹…æ± é‡Œæ²¡æœ‰ï¼Œç›´æ¥æ·»åŠ 
                                        h.data.genes.push(newGene);
                                    }
                                    // åŒæ­¥å½“å±€æ¿€æ´»åˆ—è¡¨åˆ°æ•°æ®å¯¹è±¡ï¼Œä¾›æŠ€èƒ½æ± é«˜äº®
                                    h.data.activeGenes = h.activeGenes;
                                    // è®°å½•æœ¬å±€æ–°é¢†æ‚Ÿçš„æŠ€èƒ½ï¼Œç”¨äºæŠ€èƒ½æ± çº¢æ¡†é«˜äº®
                                    if (!h.data.learnedThisRace) h.data.learnedThisRace = [];
                                    if (!h.data.learnedThisRace.includes(type)) h.data.learnedThisRace.push(type);
                                    
                                    // é£˜å­—æ•ˆæœ
                                    const float = document.createElement('div');
                                    float.innerText = `ğŸ’¡ é¡¿æ‚Ÿ: ${type}${isRare?'(ç¨€æœ‰)':''}!`;
                                float.style.position = 'absolute';
                                // ä¿®æ­£åæ ‡è®¡ç®—
                                const cameraOffset = 150 - (50 + playerHorse.distance);
                                const nameLeft = (50 + h.distance) + cameraOffset;
                                const nameTop = 250 + h.baseTop + 20;

                                float.style.left = (nameLeft + 20) + 'px';
                                float.style.top = nameTop + 'px';
                                float.style.color = isRare ? '#e74c3c' : '#f1c40f'; // ç¨€æœ‰ç”¨çº¢è‰²
                                float.style.fontWeight = 'bold';
                                float.style.textShadow = '1px 1px 2px #000';
                                float.style.zIndex = '200';
                                float.style.whiteSpace = 'nowrap';
                                uiLayer.appendChild(float);
                                
                                // åŠ¨ç”»ä¸Šé£˜æ·¡å‡º
                            let op = 1, y = 0;
                            const anim = () => {
                                y += 1.5;
                                op -= 0.02;
                                float.style.transform = `translateY(-${y}px)`;
                                float.style.opacity = String(op);
                                if (op > 0) requestAnimationFrame(anim);
                                else if (float.parentNode) {
                                    float.parentNode.removeChild(float);
                                    // åŠ¨ç”»ç»“æŸååˆ·æ–° UIï¼Œç¡®ä¿å¤§å…é‡Œçš„æŠ€èƒ½æ± æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
                                    if (window.game) window.game.updateUI();
                                }
                            };
                            requestAnimationFrame(anim);
                                
                                // åˆ·æ–°åç‰Œ (é‡æ–°ç”Ÿæˆ)
                                if (h.nameTag) {
                                    let geneHtml = '';
                                    if (h.activeGenes && h.activeGenes.length > 0) {
                                        geneHtml = h.activeGenes.map(g => 
                                            `<span style="background:${g.quality==='æ™®é€š'?'#bdc3c7':'#f1c40f'}; color:#000; padding:1px 2px; border-radius:2px; margin-left:2px; font-size:7px;">${g.type}</span>`
                                        ).join('');
                                    }
                                    h.nameTag.innerHTML = `${h.data.name}<br>${geneHtml}`;
                                }
                                
                                // é¢†æ‚Ÿåç¨å¾®åŠ é€Ÿ
                                h.speed *= 1.05;
                                h.boostTimer = 60;
                            }
                        }
                    }
                }

                    // æ›´æ–°åç‰Œä½ç½® (UI å±‚)
                    // åç‰Œ x = é©¬åŒ¹å½“å‰è·ç¦» - ç©å®¶è·‘è¿‡çš„è·ç¦» + å±å¹•åç§»(150)
                    // å› ä¸ºé•œå¤´æ˜¯è·Ÿéšç©å®¶çš„ï¼Œæ‰€ä»¥å±å¹•ä¸Šçš„ x åæ ‡ = é©¬åŒ¹ç»å¯¹x - è·‘é“åç§»x
                    // è·‘é“åç§» = -playerHorse.distance
                    // æ‰€ä»¥ å±å¹•x = (50 + h.distance) - playerHorse.distance + 150
                    // ç­‰ç­‰ï¼ŒtrackLayer è¢« transform ç§»åŠ¨äº†ã€‚
                    // å±å¹• x = (50 + h.distance) - playerHorse.distance + 150 - 50 (å› ä¸º 150 æ˜¯ targetX)
                    
                    // æ›´ç®€å•çš„ç®—æ³•ï¼šåç‰Œè·Ÿéšé©¬åŒ¹åœ¨å±å¹•ä¸Šçš„ä½ç½®
                    // é©¬åŒ¹çš„å±å¹• X = åˆå§‹Left(50) + h.distance + trackLayerçš„translateX
                    // trackLayerçš„translateX = -playerHorse.distance
                    const screenX = 50 + h.distance - playerHorse.distance + 150 - 50; 
                    // è§£é‡Šï¼štrackLayer ç§»åŠ¨äº† -playerDistanceï¼Œä¹Ÿå°±æ˜¯å¾€å·¦ç§»äº†ã€‚
                    // ä½†å®é™…ä¸Šæˆ‘ä»¬æ˜¯ç”¨ transform ç§»åŠ¨çš„ trackLayerã€‚
                    // é©¬åŒ¹åœ¨ trackLayer é‡Œçš„ left æ˜¯ 50 + h.distanceã€‚
                    // æ‰€ä»¥é©¬åŒ¹ç›¸å¯¹äºè§†å£çš„ left æ˜¯ (50 + h.distance) - playerHorse.distance + 150 - 50 ... ä¸å¯¹
                    
                    // é‡æ–°ç†ä¸€ä¸‹ï¼š
                    // æˆ‘ä»¬çš„é•œå¤´é€»è¾‘æ˜¯ï¼štrackLayer.style.transform = `translateX(${-playerHorse.distance}px)`;
                    // è¿™æ„å‘³ç€ï¼ŒtrackLayer çš„åŸç‚¹ (0,0) ç°åœ¨åœ¨å±å¹•çš„ (-playerHorse.distance, 0) ä½ç½®ï¼ˆå‡è®¾ä¸è€ƒè™‘ targetX åç§»ï¼‰ã€‚
                    // ä½†æˆ‘ä»¬å®é™…ä¸Šæ˜¯æƒ³è®© playerHorse åœ¨å±å¹•çš„ 150px å¤„ã€‚
                    // æ‰€ä»¥ trackLayer çš„ translateX åº”è¯¥æ˜¯ 150 - (50 + playerHorse.distance)ã€‚
                    // ä¹‹å‰çš„ä»£ç æ˜¯ translateX(-playerHorse.distance)ï¼Œè¿™ä¼šå¯¼è‡´ playerHorse åœ¨å±å¹•çš„ 50px å¤„ã€‚
                    
                    // ä¿®æ­£é•œå¤´é€»è¾‘ï¼š
                    const cameraOffset = 150 - (50 + playerHorse.distance);
                    const trackLayer = document.getElementById('track-layer');
                    trackLayer.style.transform = `translateX(${cameraOffset}px)`;
                    
                    const laneHeight = 120;
                    const trackTop = 180;
                    const horseLeftBase = 50;
                    const horseWidth = 120;
                    const horseVisualTopOffset = 20;
                    const nameLeft = horseLeftBase + h.distance + cameraOffset + (horseWidth / 2); 
                    const nameTop = trackTop + h.baseTop + horseVisualTopOffset + laneHeight + 10;
                    
                    if (h.nameTag) {
                        h.nameTag.style.left = nameLeft + 'px'; 
                        h.nameTag.style.top = nameTop + 'px';
                        h.nameTag.style.transform = 'translate(-50%, -100%)'; 
                    }
                });

                // é•œå¤´è·Ÿéšé€»è¾‘ (å·²æ•´åˆåˆ°ä¸Šé¢å¾ªç¯ä¸­)
                // const targetX = 150 - playerHorse.distance;
                // const trackLayer = document.getElementById('track-layer');
                // trackLayer.style.transform = `translateX(${-playerHorse.distance}px)`;
                
                if (finishedCount >= this.horses.length) {
                    this.racing = false;
                    this.endRace();
                } else {
                    requestAnimationFrame(this.loop.bind(this));
                }
            }

            endRace() {
                // ç®€å•åˆ¤å®šï¼šè°å…ˆåˆ°ç»ˆç‚¹ï¼ˆè¿™é‡Œç®€åŒ–ä¸ºè°è·‘å¾—è¿œï¼Œå®é™…ä¸Šå¤§å®¶éƒ½è·‘å®Œäº†ï¼‰
                // åœ¨è¿™ä¸ªç®€åŒ–ç‰ˆé‡Œï¼Œé€Ÿåº¦å¿«çš„è‚¯å®šå…ˆåˆ°ã€‚
                this.horses.sort((a, b) => b.speed - a.speed);
                const winner = this.horses[0];
                const isWin = winner.data.id === this.selectedHorseId;
                
                let msg = `å† å†›: ${winner.data.name}`;
                if (isWin) {
                    msg += "\nä½ èµ¢äº†ï¼ç§¯åˆ† +100";
                    this.player.integral += 100;
                } else {
                    msg += "\né—æ†¾è½è´¥ã€‚";
                }
                
                this.updateUI();
                this.showResultPanel(msg);

                // ç§»é™¤æ‰€æœ‰è·Ÿéšåç‰Œ
                this.horses.forEach(h => {
                    if (h.nameTag && h.nameTag.parentNode) {
                        h.nameTag.parentNode.removeChild(h.nameTag);
                    }
                });

                // æ¸…ç©ºè·‘é“å†…å®¹ï¼Œä½†ä¸ç«‹åˆ»è¿”å›å¤§å…ï¼Œäº¤ç”±ç»“ç®—é¢æ¿å¤„ç†è¿”å›é€»è¾‘
                document.getElementById('track-layer').innerHTML = '';
                document.getElementById('track-layer').style.transform = 'translateX(0)';
            }
        }

        window.game = new Game();
        
        // ç»“ç®—é¢æ¿é€»è¾‘
        Game.prototype.showResultPanel = function(text) {
            const panel = document.getElementById('result-panel');
            const titleEl = document.getElementById('result-title');
            const descEl = document.getElementById('result-desc');
            const cdEl = document.getElementById('result-countdown');
            const btnBack = document.getElementById('btn-back-lobby');
            
            titleEl.innerText = "æ¯”èµ›ç»“ç®—";
            descEl.innerText = text;
            panel.style.display = 'flex';
            
            let left = 3;
            cdEl.innerText = `è‡ªåŠ¨è¿”å› (${left}s)`;
            
            let timer = setInterval(() => {
                left--;
                cdEl.innerText = `è‡ªåŠ¨è¿”å› (${left}s)`;
                if (left <= 0) {
                    clearInterval(timer);
                    this.closeResultPanel();
                }
            }, 1000);
            
            btnBack.onclick = () => {
                clearInterval(timer);
                this.closeResultPanel();
            };
        };
        
        Game.prototype.closeResultPanel = function() {
            const panel = document.getElementById('result-panel');
            panel.style.display = 'none';
            document.getElementById('lobby-panel').style.display = 'block';
            document.getElementById('status-label').style.display = 'none';
        };
    </script>
</body>
</html>
